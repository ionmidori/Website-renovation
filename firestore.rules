rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // SESSIONS COLLECTION
    // ==========================================
    // âœ… SECURITY FIX: Time-limited read access (7-day TTL)
    // Prevents unauthorized access to old sessions
    // Server-only write (only Admin SDK can create/update)
    match /sessions/{sessionId} {
      // Allow read only if session is less than 7 days old
      // This improves privacy while maintaining current architecture
      allow read: if resource.data.createdAt != null && 
                     resource.data.createdAt > request.time - duration.value(7, 'd');
      
      // Only server can write (via Admin SDK with service account)
      allow write: if false;
      
      // Messages subcollection
      match /messages/{messageId} {
        // Allow read only if parent session is less than 7 days old
        allow read: if get(/databases/$(database)/documents/sessions/$(sessionId)).data.createdAt > request.time - duration.value(7, 'd');
        
        // Only server can write messages
        allow write: if false;
      }
    }
    
    // ==========================================
    // LEADS COLLECTION
    // ==========================================
    // Server-only access (sensitive customer data)
    match /leads/{leadId} {
      // Only server can read/write leads
      allow read, write: if false;
    }
    
    // ==========================================
    // USERS COLLECTION (if you add it later)
    // ==========================================
    // Users can only read/write their own data
    match /users/{userId} {
      // Allow authenticated users to read their own data
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Allow authenticated users to write their own data
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ==========================================
    // DEFAULT RULE - DENY ALL
    // ==========================================
    // Deny access to all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
