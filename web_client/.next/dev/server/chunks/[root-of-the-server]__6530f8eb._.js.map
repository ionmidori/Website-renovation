{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/vision/analyze-room.ts"],"sourcesContent":["import { GoogleGenerativeAI } from '@google/generative-ai';\r\n\r\n/**\r\n * Room structure analysis result from Gemini Vision\r\n */\r\nexport interface RoomAnalysis {\r\n    room_type: string;\r\n    approximate_size_sqm: number;\r\n    architectural_features: string[];\r\n    flooring_type: string;\r\n    wall_color: string;\r\n    ceiling_type: string;\r\n    windows: { position: string; size: string }[];\r\n    doors: { position: string }[];\r\n    special_features: string[];\r\n}\r\n\r\n/**\r\n * Analyze room structure from uploaded photo using Gemini Vision\r\n * \r\n * This function uses Gemini 1.5 Pro Vision to extract detailed structural\r\n * information from an interior photo, which will then be used to generate\r\n * a super-detailed prompt for T2I generation.\r\n * \r\n * @param imageUrl - Public HTTPS URL of the uploaded photo\r\n * @returns Detailed structural analysis as JSON\r\n */\r\nexport async function analyzeRoomStructure(imageUrl: string): Promise<RoomAnalysis> {\r\n    const startTime = Date.now();\r\n\r\n    console.log('[Vision] Initializing Gemini Vision analysis...');\r\n    console.log('[Vision] Image URL:', imageUrl);\r\n\r\n    const apiKey = process.env.GEMINI_API_KEY;\r\n    if (!apiKey) {\r\n        throw new Error('GEMINI_API_KEY not found in environment variables');\r\n    }\r\n\r\n    const genAI = new GoogleGenerativeAI(apiKey);\r\n    // Configurable model with fallback\r\n    const modelVersion = process.env.VISION_MODEL_VERSION || 'gemini-3-pro-image-preview';\r\n    const model = genAI.getGenerativeModel({ model: modelVersion });\r\n\r\n    // Structured analysis prompt\r\n    const analysisPrompt = `You are a professional interior designer and architect. Analyze this interior photo and extract precise structural and architectural information.\r\n\r\nReturn ONLY a valid JSON object with this EXACT structure (no markdown, no explanation):\r\n\r\n{\r\n    \"room_type\": \"living_room|bedroom|kitchen|bathroom|dining_room|office\",\r\n    \"approximate_size_sqm\": 25,\r\n    \"architectural_features\": [\r\n        \"wooden staircase on left wall corner\",\r\n        \"stone-clad fireplace centered on back wall\",\r\n        \"slanted ceiling with exposed beams\"\r\n    ],\r\n    \"flooring_type\": \"terracotta tiles|hardwood|marble|carpet|concrete|laminate\",\r\n    \"wall_color\": \"white|beige|gray|cream|...\",\r\n    \"ceiling_type\": \"flat|sloped|vaulted|exposed_beams\",\r\n    \"windows\": [\r\n        {\"position\": \"right wall center\", \"size\": \"large|medium|small\"}\r\n    ],\r\n    \"doors\": [\r\n        {\"position\": \"back wall left\"}\r\n    ],\r\n    \"special_features\": [\"fireplace\", \"staircase\", \"built-in_shelving\", \"exposed_brick\"]\r\n}\r\n\r\nCRITICAL RULES:\r\n1. Be EXTREMELY precise about positions: use \"left wall\", \"right wall\", \"center\", \"back wall\", \"corner\"\r\n2. Include ALL visible architectural elements\r\n3. Be specific about materials (e.g., \"terracotta tiles\" not just \"tiles\")\r\n4. Return ONLY the JSON object, nothing else\r\n5. Ensure the JSON is valid and parseable`;\r\n\r\n    try {\r\n        // Fetch image and convert to base64\r\n        console.log('[Vision] Fetching and converting image...');\r\n        const { data: imageData, mimeType } = await fetchImageAsBase64(imageUrl);\r\n\r\n        const imagePart = {\r\n            inlineData: {\r\n                data: imageData,\r\n                mimeType: mimeType\r\n            }\r\n        };\r\n\r\n        const TIMEOUT_MS = 30000; // 30 seconds timeout\r\n        const timeoutPromise = new Promise((_, reject) =>\r\n            setTimeout(() => reject(new Error('Vision API request timed out')), TIMEOUT_MS)\r\n        );\r\n\r\n        console.log('[Vision] Sending request to Gemini Vision API...');\r\n\r\n        // Race between API call and timeout\r\n        const result = await Promise.race([\r\n            model.generateContent([analysisPrompt, imagePart]),\r\n            timeoutPromise\r\n        ]) as any; // Cast to any because Promise.race returns the first resolved type\r\n\r\n        const responseText = result.response.text();\r\n\r\n        console.log('[Vision] Raw response:', responseText.substring(0, 200) + '...');\r\n\r\n        // Extract JSON from response (handle potential markdown wrapping)\r\n        let jsonText = responseText.trim();\r\n\r\n        // Remove markdown code blocks if present\r\n        jsonText = jsonText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\r\n\r\n        // Find JSON object in response\r\n        const jsonMatch = jsonText.match(/\\{[\\s\\S]*\\}/);\r\n        if (!jsonMatch) {\r\n            console.error('[Vision] Failed to extract JSON from response:', responseText);\r\n            throw new Error('Failed to parse room analysis - no JSON found in response');\r\n        }\r\n\r\n        let analysis: RoomAnalysis;\r\n\r\n        try {\r\n            analysis = JSON.parse(jsonMatch[0]);\r\n        } catch (parseError) {\r\n            console.error('[Vision] JSON Parse Error:', parseError);\r\n            throw new Error('Failed to parse (syntax error) in Vision API response');\r\n        }\r\n\r\n        const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);\r\n        console.log(`[Vision] ‚úÖ Analysis complete in ${elapsedTime}s`);\r\n        console.log('[Vision] Analyzed room:', JSON.stringify(analysis, null, 2));\r\n\r\n        // Validation - Robust check of all required fields\r\n        if (\r\n            typeof analysis.room_type !== 'string' ||\r\n            typeof analysis.approximate_size_sqm !== 'number' ||\r\n            !Array.isArray(analysis.architectural_features) ||\r\n            typeof analysis.flooring_type !== 'string' ||\r\n            typeof analysis.wall_color !== 'string' ||\r\n            typeof analysis.ceiling_type !== 'string' ||\r\n            !Array.isArray(analysis.windows) ||\r\n            !Array.isArray(analysis.doors)\r\n        ) {\r\n            console.error('[Vision] Validation Failed. Received:', analysis);\r\n            throw new Error('Invalid analysis result - missing required fields or incorrect types');\r\n        }\r\n\r\n        return analysis;\r\n\r\n    } catch (error) {\r\n        console.error('[Vision] Error during analysis:', error);\r\n\r\n        if (error instanceof Error) {\r\n            if (error.message.includes('API key')) {\r\n                throw new Error('Gemini API authentication failed. Check GEMINI_API_KEY.');\r\n            }\r\n            if (error.message.includes('quota')) {\r\n                throw new Error('Gemini API quota exceeded. Try again later.');\r\n            }\r\n        }\r\n\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Fetch image from URL and convert to base64 with MIME type detection\r\n * @param url - Public HTTPS URL of the image\r\n * @returns Object containing base64 data and mimeType\r\n */\r\nasync function fetchImageAsBase64(url: string): Promise<{ data: string; mimeType: string }> {\r\n    try {\r\n        const response = await fetch(url);\r\n\r\n        if (!response.ok) {\r\n            throw new Error(`Failed to fetch image: ${response.status} ${response.statusText}`);\r\n        }\r\n\r\n        const mimeType = response.headers.get('content-type') || 'image/jpeg';\r\n        const arrayBuffer = await response.arrayBuffer();\r\n        const buffer = Buffer.from(arrayBuffer);\r\n        const base64 = buffer.toString('base64');\r\n\r\n        console.log(`[Vision] Image fetched: ${(buffer.length / 1024).toFixed(2)} KB, Type: ${mimeType}`);\r\n\r\n        return { data: base64, mimeType };\r\n\r\n    } catch (error) {\r\n        console.error('[Vision] Error fetching image:', error);\r\n        throw new Error(`Failed to fetch image from URL: ${url}`);\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 253, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/imagen/generate-interior.ts"],"sourcesContent":["import { GoogleAuth } from 'google-auth-library';\r\n\r\n/**\r\n * Generate interior design image using Imagen 3 via REST API\r\n * Using REST API instead of SDK for better compatibility with service accounts\r\n */\r\nexport async function generateInteriorImage(options: {\r\n    prompt: string;\r\n    aspectRatio?: '1:1' | '16:9' | '9:16' | '4:3' | '3:4';\r\n    numberOfImages?: number;\r\n}): Promise<Buffer> {\r\n    const {\r\n        prompt,\r\n        aspectRatio = '16:9',\r\n        numberOfImages = 1,\r\n    } = options;\r\n\r\n    console.log('[Imagen REST] Starting image generation...');\r\n    console.log('[Imagen REST] Prompt:', prompt.substring(0, 100) + '...');\r\n\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n        // Initialize Google Auth with environment variables\r\n        const privateKey = process.env.FIREBASE_PRIVATE_KEY?.replace(/\\\\n/g, '\\n');\r\n        const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;\r\n        const projectId = process.env.FIREBASE_PROJECT_ID;\r\n\r\n        if (!privateKey || !clientEmail || !projectId) {\r\n            throw new Error('Missing Firebase credentials in environment variables');\r\n        }\r\n\r\n        const auth = new GoogleAuth({\r\n            credentials: {\r\n                client_email: clientEmail,\r\n                private_key: privateKey,\r\n                project_id: projectId,\r\n            },\r\n            scopes: ['https://www.googleapis.com/auth/cloud-platform'],\r\n        });\r\n\r\n        const client = await auth.getClient();\r\n        const accessToken = await client.getAccessToken();\r\n\r\n        if (!accessToken.token) {\r\n            throw new Error('Failed to get access token');\r\n        }\r\n\r\n        console.log('[Imagen REST] Got access token');\r\n        console.log('[Imagen REST] Project:', projectId);\r\n\r\n        // ‚úÖ BUG FIX #8: Configurable Imagen model version\r\n        const location = 'us-central1';\r\n        const model = process.env.IMAGEN_MODEL_VERSION || 'imagen-4.0-generate-001';\r\n\r\n        const endpoint = `https://${location}-aiplatform.googleapis.com/v1/projects/${projectId}/locations/${location}/publishers/google/models/${model}:predict`;\r\n\r\n        // API request payload\r\n        const requestPayload = {\r\n            instances: [\r\n                {\r\n                    prompt: prompt,\r\n                }\r\n            ],\r\n            parameters: {\r\n                sampleCount: numberOfImages,\r\n                aspectRatio: aspectRatio,\r\n                safetySetting: 'block_some',\r\n                personGeneration: 'allow_adult',\r\n            }\r\n        };\r\n\r\n        console.log('[Imagen REST] Calling API...');\r\n\r\n        // Create AbortController for timeout\r\n        const controller = new AbortController();\r\n        const timeoutId = setTimeout(() => controller.abort(), 60000); // 60s timeout\r\n\r\n        // Make REST API call\r\n        const response = await fetch(endpoint, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Authorization': `Bearer ${accessToken.token}`,\r\n                'Content-Type': 'application/json',\r\n            },\r\n            body: JSON.stringify(requestPayload),\r\n            signal: controller.signal,\r\n        });\r\n        clearTimeout(timeoutId); // Clear timeout on success\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text();\r\n            console.error('[Imagen REST] API Error:', response.status, errorText);\r\n            throw new Error(`Imagen API error: ${response.status} - ${errorText}`);\r\n        }\r\n\r\n        const result = await response.json();\r\n\r\n        console.log('[Imagen REST] API Response received');\r\n\r\n        // Extract base64 image from response\r\n        if (!result.predictions || result.predictions.length === 0) {\r\n            throw new Error('No image generated');\r\n        }\r\n\r\n        // Imagen returns base64 encoded image in predictions[0].bytesBase64Encoded\r\n        const base64Image = result.predictions[0].bytesBase64Encoded;\r\n\r\n        if (!base64Image) {\r\n            console.error('[Imagen REST] Response structure:', JSON.stringify(result, null, 2));\r\n            throw new Error('No image data in response');\r\n        }\r\n\r\n        // Convert base64 to Buffer\r\n        const imageBuffer = Buffer.from(base64Image, 'base64');\r\n\r\n        const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);\r\n        console.log(`[Imagen REST] Image generated in ${elapsedTime}s`);\r\n        console.log(`[Imagen REST] Image size: ${(imageBuffer.length / 1024).toFixed(2)} KB`);\r\n\r\n        return imageBuffer;\r\n    } catch (error) {\r\n        console.error('[Imagen REST] Error:', error);\r\n\r\n        // ‚úÖ BUG FIX #10: User-friendly error messages (don't expose internal details)\r\n        if (error instanceof Error) {\r\n            // Log detailed error for debugging\r\n            console.error('[Imagen REST] Detailed error:', error.message, error.stack);\r\n\r\n            if (error.message.includes('403')) {\r\n                throw new Error('Image generation service is currently unavailable. Please try again later.');\r\n            }\r\n\r\n            if (error.message.includes('404')) {\r\n                throw new Error('Image generation service is currently unavailable. Please try again later.');\r\n            }\r\n\r\n            if (error.message.includes('timeout') || error.message.includes('ETIMEDOUT')) {\r\n                throw new Error('Image generation timed out. Please try again.');\r\n            }\r\n        }\r\n\r\n        // Generic user-friendly message\r\n        throw new Error('Image generation failed. Please try again in a few moments.');\r\n    }\r\n}\r\n\r\n/**\r\n * Enhanced prompt generator for interior design\r\n */\r\nexport function buildInteriorDesignPrompt(options: {\r\n    userPrompt: string;\r\n    roomType: string;\r\n    style: string;\r\n}): string {\r\n    const { userPrompt, roomType, style } = options;\r\n\r\n    const enhancedPrompt = `\r\nPhotorealistic interior design rendering of a ${roomType}.\r\nStyle: ${style}.\r\n${userPrompt}\r\n\r\nProfessional architectural visualization quality with natural lighting, realistic materials and textures, proper perspective, modern high-end interior design, clean composition, 4K quality.\r\n    `.trim();\r\n\r\n    return enhancedPrompt;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 382, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/imagen/prompt-builders.ts"],"sourcesContent":["import { RoomAnalysis } from '../vision/analyze-room';\r\n\r\n/**\r\n * Build a super-detailed T2I prompt from room structure analysis\r\n * \r\n * This replaces the I2I approach with a T2I approach that uses detailed\r\n * structural description extracted by Gemini Vision.\r\n * \r\n * @param analysis - Structural analysis from Gemini Vision\r\n * @param targetStyle - Desired design style (e.g., \"modern industrial\")\r\n * @param userRequest - User's specific renovation request\r\n * @returns Detailed T2I prompt that preserves structure\r\n */\r\nexport function buildPromptFromRoomAnalysis(\r\n    analysis: RoomAnalysis,\r\n    targetStyle: string,\r\n    userRequest: string\r\n): string {\r\n    console.log('[Prompt Builder] Building detailed T2I prompt from analysis...');\r\n\r\n    // Helper for formatting lists\r\n    const formatList = (items: any[], formatter: (item: any) => string, emptyText = '') =>\r\n        items && items.length > 0 ? items.map(formatter).join('\\n') : emptyText;\r\n\r\n    // Format architectural features\r\n    const features = formatList(analysis.architectural_features, f => `- ${f}`);\r\n\r\n    // Format windows\r\n    const windowsDescription = formatList(\r\n        analysis.windows,\r\n        w => `- ${w.size} window on ${w.position}`,\r\n        '- No visible windows'\r\n    );\r\n\r\n    // Format doors\r\n    const doorsDescription = formatList(analysis.doors, d => `- Door on ${d.position}`);\r\n\r\n    // Format special features\r\n    const specialFeaturesList = formatList(analysis.special_features, f => `- ${f}`);\r\n    const specialFeatures = specialFeaturesList ? `\\nSpecial architectural elements:\\n${specialFeaturesList}` : '';\r\n\r\n    // Build comprehensive prompt\r\n    const detailedPrompt = `\r\nProfessional architectural photography of a ${analysis.room_type}, approximately ${analysis.approximate_size_sqm} square meters.\r\n\r\nARCHITECTURAL LAYOUT (MUST PRESERVE EXACTLY):\r\n${features}\r\n\r\nWindows:\r\n${windowsDescription}\r\n\r\n${doorsDescription ? `Doors:\\n${doorsDescription}\\n` : ''}\r\nFlooring: ${analysis.flooring_type}\r\nWalls: ${analysis.wall_color}\r\nCeiling: ${analysis.ceiling_type}${specialFeatures}\r\n\r\nDESIGN TRANSFORMATION:\r\nStyle: ${targetStyle}\r\nUser request: ${userRequest}\r\n\r\nSTRICT REQUIREMENTS:\r\n- Preserve the EXACT architectural layout described above\r\n- Keep all structural elements in their specified positions\r\n- Maintain the same room dimensions and proportions\r\n- Change ONLY: furniture, decorative elements, material textures, colors, lighting fixtures\r\n- Do NOT move or alter: windows, doors, stairs, fireplace, built-in features\r\n- Quality: Photorealistic, 8K resolution, architectural magazine quality\r\n- Lighting: Natural sunlight through windows + ambient interior lighting\r\n- Style: High-end professional interior design\r\n- Perspective: Proper architectural perspective, sharp focus throughout\r\n- Rendering: Physically based rendering, ray-traced reflections, realistic materials\r\n    `.trim();\r\n\r\n    console.log('[Prompt Builder] Generated prompt length:', detailedPrompt.length, 'characters');\r\n\r\n    // Log a preview\r\n    const preview = detailedPrompt.substring(0, 200) + '...';\r\n    console.log('[Prompt Builder] Preview:', preview);\r\n\r\n    return detailedPrompt;\r\n}\r\n\r\n/**\r\n * Build a fallback prompt if vision analysis fails\r\n * This is used as a safety net\r\n */\r\nexport function buildFallbackPrompt(\r\n    roomType: string,\r\n    style: string,\r\n    userRequest: string\r\n): string {\r\n    return `\r\nProfessional ${style} style ${roomType}.\r\n${userRequest}\r\nPhotorealistic, 8K, architectural photography, high-end interior design, natural lighting.\r\n    `.trim();\r\n}\r\n"],"names":[],"mappings":";;;;;;AAaO,SAAS,4BACZ,QAAsB,EACtB,WAAmB,EACnB,WAAmB;IAEnB,QAAQ,GAAG,CAAC;IAEZ,8BAA8B;IAC9B,MAAM,aAAa,CAAC,OAAc,WAAkC,YAAY,EAAE,GAC9E,SAAS,MAAM,MAAM,GAAG,IAAI,MAAM,GAAG,CAAC,WAAW,IAAI,CAAC,QAAQ;IAElE,gCAAgC;IAChC,MAAM,WAAW,WAAW,SAAS,sBAAsB,EAAE,CAAA,IAAK,CAAC,EAAE,EAAE,GAAG;IAE1E,iBAAiB;IACjB,MAAM,qBAAqB,WACvB,SAAS,OAAO,EAChB,CAAA,IAAK,CAAC,EAAE,EAAE,EAAE,IAAI,CAAC,WAAW,EAAE,EAAE,QAAQ,EAAE,EAC1C;IAGJ,eAAe;IACf,MAAM,mBAAmB,WAAW,SAAS,KAAK,EAAE,CAAA,IAAK,CAAC,UAAU,EAAE,EAAE,QAAQ,EAAE;IAElF,0BAA0B;IAC1B,MAAM,sBAAsB,WAAW,SAAS,gBAAgB,EAAE,CAAA,IAAK,CAAC,EAAE,EAAE,GAAG;IAC/E,MAAM,kBAAkB,sBAAsB,CAAC,mCAAmC,EAAE,qBAAqB,GAAG;IAE5G,6BAA6B;IAC7B,MAAM,iBAAiB,CAAC;4CACgB,EAAE,SAAS,SAAS,CAAC,gBAAgB,EAAE,SAAS,oBAAoB,CAAC;;;AAGjH,EAAE,SAAS;;;AAGX,EAAE,mBAAmB;;AAErB,EAAE,mBAAmB,CAAC,QAAQ,EAAE,iBAAiB,EAAE,CAAC,GAAG,GAAG;UAChD,EAAE,SAAS,aAAa,CAAC;OAC5B,EAAE,SAAS,UAAU,CAAC;SACpB,EAAE,SAAS,YAAY,GAAG,gBAAgB;;;OAG5C,EAAE,YAAY;cACP,EAAE,YAAY;;;;;;;;;;;;;IAaxB,CAAC,CAAC,IAAI;IAEN,QAAQ,GAAG,CAAC,6CAA6C,eAAe,MAAM,EAAE;IAEhF,gBAAgB;IAChB,MAAM,UAAU,eAAe,SAAS,CAAC,GAAG,OAAO;IACnD,QAAQ,GAAG,CAAC,6BAA6B;IAEzC,OAAO;AACX;AAMO,SAAS,oBACZ,QAAgB,EAChB,KAAa,EACb,WAAmB;IAEnB,OAAO,CAAC;aACC,EAAE,MAAM,OAAO,EAAE,SAAS;AACvC,EAAE,YAAY;;IAEV,CAAC,CAAC,IAAI;AACV"}},
    {"offset": {"line": 449, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/imagen/generate-interior-i2i.ts"],"sourcesContent":["import { GoogleAuth } from 'google-auth-library';\r\n\r\n/**\r\n * Generate interior design image using Imagen 3 Capability (Image-to-Image Editing)\r\n * \r\n * This function takes a reference image (user's photo) and modifies it based on the prompt\r\n * while preserving structural elements like windows, doors, and architectural features.\r\n * \r\n * Using REST API instead of SDK for better compatibility with service accounts\r\n */\r\nexport async function generateInteriorImageI2I(options: {\r\n    prompt: string;\r\n    referenceImage: string; // Public HTTPS URL from Firebase Storage\r\n    mode?: 'inpainting-insert' | 'inpainting-remove';\r\n    maskMode?: 'auto' | 'manual';\r\n    aspectRatio?: '1:1' | '16:9' | '9:16' | '4:3' | '3:4';\r\n    numberOfImages?: number;\r\n    modificationType?: 'renovation' | 'detail'; // New parameter\r\n}): Promise<Buffer> {\r\n    const {\r\n        prompt,\r\n        referenceImage,\r\n        mode = 'inpainting-insert',\r\n        maskMode = 'auto',\r\n        aspectRatio = '16:9',\r\n        numberOfImages = 1,\r\n        modificationType = 'renovation', // Default to whole room renovation\r\n    } = options;\r\n\r\n    console.log('[Imagen I2I] Starting image-to-image editing...');\r\n    console.log('[Imagen I2I] Modification Type:', modificationType);\r\n    console.log('[Imagen I2I] Prompt:', prompt.substring(0, 100) + '...');\r\n\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n        // Initialize Google Auth with environment variables\r\n        const privateKey = process.env.FIREBASE_PRIVATE_KEY?.replace(/\\\\n/g, '\\n');\r\n        const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;\r\n        const projectId = process.env.FIREBASE_PROJECT_ID;\r\n\r\n        if (!privateKey || !clientEmail || !projectId) {\r\n            throw new Error('Missing Firebase credentials in environment variables');\r\n        }\r\n\r\n        const auth = new GoogleAuth({\r\n            credentials: {\r\n                client_email: clientEmail,\r\n                private_key: privateKey,\r\n                project_id: projectId,\r\n            },\r\n            scopes: ['https://www.googleapis.com/auth/cloud-platform'],\r\n        });\r\n\r\n        const client = await auth.getClient();\r\n        const accessToken = await client.getAccessToken();\r\n\r\n        if (!accessToken.token) {\r\n            throw new Error('Failed to get access token');\r\n        }\r\n\r\n        console.log('[Imagen I2I] Got access token');\r\n        console.log('[Imagen I2I] Project:', projectId);\r\n\r\n        // SELECT MODEL BASED ON MODIFICATION TYPE\r\n        const location = 'us-central1';\r\n        let model = process.env.IMAGEN_I2I_MODEL || 'imagegeneration@006'; // Default General\r\n\r\n        if (modificationType === 'detail') {\r\n            // Use Capability model for detail editing\r\n            model = process.env.IMAGEN_CAPABILITY_MODEL || 'imagen-3.0-capability-001';\r\n            console.log('[Imagen I2I] DETAIL mode selected -> Switching to Capability model');\r\n        } else {\r\n            // Use Generate model for general renovation\r\n            console.log('[Imagen I2I] RENOVATION mode selected -> Using General model');\r\n        }\r\n\r\n        const endpoint = `https://${location}-aiplatform.googleapis.com/v1/projects/${projectId}/locations/${location}/publishers/google/models/${model}:predict`;\r\n\r\n        console.log('[Imagen I2I] Using model:', model);\r\n\r\n        // API request payload for image-to-image editing\r\n\r\n        // Convert HTTPS URL to GS URI if possible (preferred by Vertex AI)\r\n        let imageUri = referenceImage;\r\n        if (referenceImage.startsWith('https://storage.googleapis.com/')) {\r\n            // Format: https://storage.googleapis.com/BUCKET_NAME/PATH\r\n            const pathParts = referenceImage.replace('https://storage.googleapis.com/', '').split('/');\r\n            const bucket = pathParts.shift();\r\n            const path = pathParts.join('/');\r\n            if (bucket && path) {\r\n                imageUri = `gs://${bucket}/${path}`;\r\n                console.log('[Imagen I2I] Converted URL to GS URI:', imageUri);\r\n            }\r\n        }\r\n\r\n        const isCapabilityModel = model.includes('capability');\r\n        const isImagen3Generate = model.includes('imagen-3.0-generate');\r\n\r\n        // ‚úÖ QUALITY WRAPPER: Hardcoded parameters for maximum quality\r\n        const parameters: any = {\r\n            sampleCount: numberOfImages,\r\n            // aspectRatio is not supported in I2I mode for some models (inherit from source)\r\n            safetySetting: 'block_some',\r\n            personGeneration: 'allow_adult',\r\n\r\n            // ‚úÖ NEW: Negative prompt to prevent distortions and artifacts\r\n            negativePrompt: 'blurry, distorted, low resolution, cartoon, painting, melted objects, ' +\r\n                'bad perspective, floating structures, noise, ugly, deformed, watermark, ' +\r\n                'text overlay, amateur, sketch, low quality, pixelated',\r\n        };\r\n\r\n        // Strict Payload Logic based on Model Type\r\n        if (isCapabilityModel) {\r\n            // Capability models (editing) require editConfig\r\n            parameters.editConfig = {\r\n                editMode: mode,\r\n                maskMode: maskMode,\r\n            };\r\n        } else if (isImagen3Generate) {\r\n            // Imagen 3 Generate (Standard I2I) - STRICTLY NO editConfig\r\n            console.log('[Imagen I2I] Imagen 3 Generate detected - Using CLEAN payload with negative prompt');\r\n        } else {\r\n            // Legacy/Standard models (Imagen 2) - Standard payload\r\n            console.log('[Imagen I2I] Legacy/Standard Model detected - skipping editConfig');\r\n        }\r\n\r\n        const requestPayload = {\r\n            instances: [\r\n                {\r\n                    prompt: prompt,\r\n                    image: {\r\n                        gcsUri: imageUri, // gs:// URL preferred\r\n                    }\r\n                }\r\n            ],\r\n            parameters: parameters\r\n        };\r\n\r\n        // ‚úÖ LOGGING FOR USER DEBUGGING (Excluding large image data if present)\r\n        console.log('--- [DEBUG] IMAGEN API PAYLOAD ---');\r\n        console.log('Model:', model);\r\n        console.log('Endpoint:', endpoint);\r\n        console.log('Payload:', JSON.stringify({\r\n            instances: requestPayload.instances.map(inst => ({\r\n                ...inst,\r\n                // Truncate image data if it were base64 for cleaner logs\r\n                image: inst.image?.gcsUri ? inst.image : '{base64_data_hidden}'\r\n            })),\r\n            parameters: requestPayload.parameters\r\n        }, null, 2));\r\n        console.log('--- [DEBUG] END PAYLOAD ---');\r\n\r\n        console.log('[Imagen I2I] Calling API with editMode:', mode, 'maskMode:', maskMode);\r\n\r\n        // Make REST API call\r\n        const response = await fetch(endpoint, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Authorization': `Bearer ${accessToken.token}`,\r\n                'Content-Type': 'application/json',\r\n            },\r\n            body: JSON.stringify(requestPayload),\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text();\r\n            console.error('[Imagen I2I] API Error:', response.status, errorText);\r\n\r\n            // Check if it's a 404/403 (model not available) and suggest fallback\r\n            if (response.status === 404 || response.status === 403) {\r\n                console.warn('[Imagen I2I] Capability model not available, trying fallback...');\r\n\r\n                // Try fallback to Imagen 2.0 if available\r\n                if (process.env.I2I_FALLBACK_MODEL) {\r\n                    console.log('[Imagen I2I] Attempting fallback to:', process.env.I2I_FALLBACK_MODEL);\r\n                    // Note: Fallback model requires manual configuration in environment variables\r\n                    return await generateInteriorImageI2I({\r\n                        ...options,\r\n                    });\r\n                }\r\n\r\n                throw new Error('Image editing is not available for your account. Please contact support.');\r\n            }\r\n\r\n            // Expose the real error for debugging\r\n            throw new Error(`Imagen API error: ${response.status} - ${errorText}`);\r\n        }\r\n\r\n        const result = await response.json();\r\n        console.log('[Imagen I2I] API Response received');\r\n\r\n        // Extract base64 image from response\r\n        if (!result.predictions || result.predictions.length === 0) {\r\n            throw new Error('No image generated');\r\n        }\r\n\r\n        // Imagen returns base64 encoded image in predictions[0].bytesBase64Encoded\r\n        const base64Image = result.predictions[0].bytesBase64Encoded;\r\n\r\n        if (!base64Image) {\r\n            console.error('[Imagen I2I] Response structure:', JSON.stringify(result, null, 2));\r\n            throw new Error('No image data in response');\r\n        }\r\n\r\n        // Convert base64 to Buffer\r\n        const imageBuffer = Buffer.from(base64Image, 'base64');\r\n\r\n        const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);\r\n        console.log(`[Imagen I2I] Image edited in ${elapsedTime}s`);\r\n        console.log(`[Imagen I2I] Image size: ${(imageBuffer.length / 1024).toFixed(2)} KB`);\r\n\r\n        return imageBuffer;\r\n\r\n    } catch (error) {\r\n        console.error('[Imagen I2I] Error:', error);\r\n\r\n        // User-friendly error messages (don't expose internal details)\r\n        if (error instanceof Error) {\r\n            // Log detailed error for debugging\r\n            console.error('[Imagen I2I] Detailed error:', error.message, error.stack);\r\n\r\n            if (error.message.includes('403')) {\r\n                throw new Error('Image editing service is currently unavailable. Please try again later.');\r\n            }\r\n\r\n            if (error.message.includes('404')) {\r\n                throw new Error('Image editing service is currently unavailable. Please try again later.');\r\n            }\r\n\r\n            // Allow API errors to propagate for debugging\r\n            if (error.message.includes('Imagen API error')) {\r\n                throw error;\r\n            }\r\n        }\r\n\r\n        // Generic user-friendly message\r\n        throw new Error('Image editing failed. Please try again in a few moments.');\r\n    }\r\n}\r\n\r\n/**\r\n * Build enhanced prompt for image-to-image editing\r\n * Optimized for preserving structural elements while changing style\r\n * ENHANCED: Quality Wrapper with mandatory Style Booster\r\n */\r\nexport function buildI2IEditingPrompt(options: {\r\n    userPrompt: string;\r\n    structuralElements?: string;\r\n    roomType: string;\r\n    style: string;\r\n}): string {\r\n    const { userPrompt, structuralElements, roomType, style } = options;\r\n\r\n    // ‚úÖ MANDATORY STYLE BOOSTER: Injected into every prompt for max quality\r\n    const STYLE_BOOSTER = ', photorealistic 8k, highly detailed, architectural photography, ' +\r\n        'sharp focus, raytracing lighting, physically based rendering, ' +\r\n        'professional interior design portfolio';\r\n\r\n    // If we have structural elements, emphasize preservation\r\n    const structuralInstruction = structuralElements\r\n        ? `STRICTLY PRESERVE THE ARCHITECTURAL STRUCTURE AND LAYOUT: ${structuralElements}. `\r\n        : '';\r\n\r\n    // ‚úÖ QUALITY WRAPPER: Every prompt gets the booster appended\r\n    const enhancedPrompt = `\r\n${structuralInstruction}\r\nTask: Professional total renovation of this ${roomType} into a high-end ${style} design.\r\nUser request: ${userPrompt}\r\n\r\nInstructions:\r\n- Keep the exact position of windows, doors, and walls.\r\n- Replace all materials, textures, and furniture with premium ${style} alternatives.\r\n- Use realistic lighting (natural sunlight through windows + interior ambient lighting).\r\n- Quality requirements: ${STYLE_BOOSTER}\r\n    `.trim();\r\n\r\n    console.log('[I2I Prompt] Style Booster injected:', STYLE_BOOSTER);\r\n    return enhancedPrompt;\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAUO,eAAe,yBAAyB,OAQ9C;IACG,MAAM,EACF,MAAM,EACN,cAAc,EACd,OAAO,mBAAmB,EAC1B,WAAW,MAAM,EACjB,cAAc,MAAM,EACpB,iBAAiB,CAAC,EAClB,mBAAmB,YAAY,EAClC,GAAG;IAEJ,QAAQ,GAAG,CAAC;IACZ,QAAQ,GAAG,CAAC,mCAAmC;IAC/C,QAAQ,GAAG,CAAC,wBAAwB,OAAO,SAAS,CAAC,GAAG,OAAO;IAE/D,MAAM,YAAY,KAAK,GAAG;IAE1B,IAAI;QACA,oDAAoD;QACpD,MAAM,aAAa,QAAQ,GAAG,CAAC,oBAAoB,EAAE,QAAQ,QAAQ;QACrE,MAAM,cAAc,QAAQ,GAAG,CAAC,qBAAqB;QACrD,MAAM,YAAY,QAAQ,GAAG,CAAC,mBAAmB;QAEjD,IAAI,CAAC,cAAc,CAAC,eAAe,CAAC,WAAW;YAC3C,MAAM,IAAI,MAAM;QACpB;QAEA,MAAM,OAAO,IAAI,kLAAU,CAAC;YACxB,aAAa;gBACT,cAAc;gBACd,aAAa;gBACb,YAAY;YAChB;YACA,QAAQ;gBAAC;aAAiD;QAC9D;QAEA,MAAM,SAAS,MAAM,KAAK,SAAS;QACnC,MAAM,cAAc,MAAM,OAAO,cAAc;QAE/C,IAAI,CAAC,YAAY,KAAK,EAAE;YACpB,MAAM,IAAI,MAAM;QACpB;QAEA,QAAQ,GAAG,CAAC;QACZ,QAAQ,GAAG,CAAC,yBAAyB;QAErC,0CAA0C;QAC1C,MAAM,WAAW;QACjB,IAAI,QAAQ,QAAQ,GAAG,CAAC,gBAAgB,IAAI,uBAAuB,kBAAkB;QAErF,IAAI,qBAAqB,UAAU;YAC/B,0CAA0C;YAC1C,QAAQ,QAAQ,GAAG,CAAC,uBAAuB,IAAI;YAC/C,QAAQ,GAAG,CAAC;QAChB,OAAO;YACH,4CAA4C;YAC5C,QAAQ,GAAG,CAAC;QAChB;QAEA,MAAM,WAAW,CAAC,QAAQ,EAAE,SAAS,uCAAuC,EAAE,UAAU,WAAW,EAAE,SAAS,0BAA0B,EAAE,MAAM,QAAQ,CAAC;QAEzJ,QAAQ,GAAG,CAAC,6BAA6B;QAEzC,iDAAiD;QAEjD,mEAAmE;QACnE,IAAI,WAAW;QACf,IAAI,eAAe,UAAU,CAAC,oCAAoC;YAC9D,0DAA0D;YAC1D,MAAM,YAAY,eAAe,OAAO,CAAC,mCAAmC,IAAI,KAAK,CAAC;YACtF,MAAM,SAAS,UAAU,KAAK;YAC9B,MAAM,OAAO,UAAU,IAAI,CAAC;YAC5B,IAAI,UAAU,MAAM;gBAChB,WAAW,CAAC,KAAK,EAAE,OAAO,CAAC,EAAE,MAAM;gBACnC,QAAQ,GAAG,CAAC,yCAAyC;YACzD;QACJ;QAEA,MAAM,oBAAoB,MAAM,QAAQ,CAAC;QACzC,MAAM,oBAAoB,MAAM,QAAQ,CAAC;QAEzC,8DAA8D;QAC9D,MAAM,aAAkB;YACpB,aAAa;YACb,iFAAiF;YACjF,eAAe;YACf,kBAAkB;YAElB,8DAA8D;YAC9D,gBAAgB,2EACZ,6EACA;QACR;QAEA,2CAA2C;QAC3C,IAAI,mBAAmB;YACnB,iDAAiD;YACjD,WAAW,UAAU,GAAG;gBACpB,UAAU;gBACV,UAAU;YACd;QACJ,OAAO,IAAI,mBAAmB;YAC1B,4DAA4D;YAC5D,QAAQ,GAAG,CAAC;QAChB,OAAO;YACH,uDAAuD;YACvD,QAAQ,GAAG,CAAC;QAChB;QAEA,MAAM,iBAAiB;YACnB,WAAW;gBACP;oBACI,QAAQ;oBACR,OAAO;wBACH,QAAQ;oBACZ;gBACJ;aACH;YACD,YAAY;QAChB;QAEA,uEAAuE;QACvE,QAAQ,GAAG,CAAC;QACZ,QAAQ,GAAG,CAAC,UAAU;QACtB,QAAQ,GAAG,CAAC,aAAa;QACzB,QAAQ,GAAG,CAAC,YAAY,KAAK,SAAS,CAAC;YACnC,WAAW,eAAe,SAAS,CAAC,GAAG,CAAC,CAAA,OAAQ,CAAC;oBAC7C,GAAG,IAAI;oBACP,yDAAyD;oBACzD,OAAO,KAAK,KAAK,EAAE,SAAS,KAAK,KAAK,GAAG;gBAC7C,CAAC;YACD,YAAY,eAAe,UAAU;QACzC,GAAG,MAAM;QACT,QAAQ,GAAG,CAAC;QAEZ,QAAQ,GAAG,CAAC,2CAA2C,MAAM,aAAa;QAE1E,qBAAqB;QACrB,MAAM,WAAW,MAAM,MAAM,UAAU;YACnC,QAAQ;YACR,SAAS;gBACL,iBAAiB,CAAC,OAAO,EAAE,YAAY,KAAK,EAAE;gBAC9C,gBAAgB;YACpB;YACA,MAAM,KAAK,SAAS,CAAC;QACzB;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YACd,MAAM,YAAY,MAAM,SAAS,IAAI;YACrC,QAAQ,KAAK,CAAC,2BAA2B,SAAS,MAAM,EAAE;YAE1D,qEAAqE;YACrE,IAAI,SAAS,MAAM,KAAK,OAAO,SAAS,MAAM,KAAK,KAAK;gBACpD,QAAQ,IAAI,CAAC;gBAEb,0CAA0C;gBAC1C,IAAI,QAAQ,GAAG,CAAC,kBAAkB,EAAE;oBAChC,QAAQ,GAAG,CAAC,wCAAwC,QAAQ,GAAG,CAAC,kBAAkB;oBAClF,8EAA8E;oBAC9E,OAAO,MAAM,yBAAyB;wBAClC,GAAG,OAAO;oBACd;gBACJ;gBAEA,MAAM,IAAI,MAAM;YACpB;YAEA,sCAAsC;YACtC,MAAM,IAAI,MAAM,CAAC,kBAAkB,EAAE,SAAS,MAAM,CAAC,GAAG,EAAE,WAAW;QACzE;QAEA,MAAM,SAAS,MAAM,SAAS,IAAI;QAClC,QAAQ,GAAG,CAAC;QAEZ,qCAAqC;QACrC,IAAI,CAAC,OAAO,WAAW,IAAI,OAAO,WAAW,CAAC,MAAM,KAAK,GAAG;YACxD,MAAM,IAAI,MAAM;QACpB;QAEA,2EAA2E;QAC3E,MAAM,cAAc,OAAO,WAAW,CAAC,EAAE,CAAC,kBAAkB;QAE5D,IAAI,CAAC,aAAa;YACd,QAAQ,KAAK,CAAC,oCAAoC,KAAK,SAAS,CAAC,QAAQ,MAAM;YAC/E,MAAM,IAAI,MAAM;QACpB;QAEA,2BAA2B;QAC3B,MAAM,cAAc,OAAO,IAAI,CAAC,aAAa;QAE7C,MAAM,cAAc,CAAC,CAAC,KAAK,GAAG,KAAK,SAAS,IAAI,IAAI,EAAE,OAAO,CAAC;QAC9D,QAAQ,GAAG,CAAC,CAAC,6BAA6B,EAAE,YAAY,CAAC,CAAC;QAC1D,QAAQ,GAAG,CAAC,CAAC,yBAAyB,EAAE,CAAC,YAAY,MAAM,GAAG,IAAI,EAAE,OAAO,CAAC,GAAG,GAAG,CAAC;QAEnF,OAAO;IAEX,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,uBAAuB;QAErC,+DAA+D;QAC/D,IAAI,iBAAiB,OAAO;YACxB,mCAAmC;YACnC,QAAQ,KAAK,CAAC,gCAAgC,MAAM,OAAO,EAAE,MAAM,KAAK;YAExE,IAAI,MAAM,OAAO,CAAC,QAAQ,CAAC,QAAQ;gBAC/B,MAAM,IAAI,MAAM;YACpB;YAEA,IAAI,MAAM,OAAO,CAAC,QAAQ,CAAC,QAAQ;gBAC/B,MAAM,IAAI,MAAM;YACpB;YAEA,8CAA8C;YAC9C,IAAI,MAAM,OAAO,CAAC,QAAQ,CAAC,qBAAqB;gBAC5C,MAAM;YACV;QACJ;QAEA,gCAAgC;QAChC,MAAM,IAAI,MAAM;IACpB;AACJ;AAOO,SAAS,sBAAsB,OAKrC;IACG,MAAM,EAAE,UAAU,EAAE,kBAAkB,EAAE,QAAQ,EAAE,KAAK,EAAE,GAAG;IAE5D,wEAAwE;IACxE,MAAM,gBAAgB,sEAClB,mEACA;IAEJ,yDAAyD;IACzD,MAAM,wBAAwB,qBACxB,CAAC,0DAA0D,EAAE,mBAAmB,EAAE,CAAC,GACnF;IAEN,4DAA4D;IAC5D,MAAM,iBAAiB,CAAC;AAC5B,EAAE,sBAAsB;4CACoB,EAAE,SAAS,iBAAiB,EAAE,MAAM;cAClE,EAAE,WAAW;;;;8DAImC,EAAE,MAAM;;wBAE9C,EAAE,cAAc;IACpC,CAAC,CAAC,IAAI;IAEN,QAAQ,GAAG,CAAC,wCAAwC;IACpD,OAAO;AACX"}},
    {"offset": {"line": 662, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/chat-tools.ts"],"sourcesContent":["// Tool definitions for chat API\r\nimport { tool } from 'ai';\r\nimport { z } from 'zod';\r\n// ‚úÖ BUG FIX #12: Removed duplicate import (storage is imported dynamically below)\r\nimport { saveLead } from './db/leads';\r\nimport { generateInteriorImage, buildInteriorDesignPrompt } from './imagen/generate-interior';\r\nimport { generateInteriorImageI2I, buildI2IEditingPrompt } from './imagen/generate-interior-i2i';\r\n// ‚úÖ VISION + T2I: Static imports (no I2I fallback needed)\r\nimport { analyzeRoomStructure } from './vision/analyze-room';\r\nimport { buildPromptFromRoomAnalysis } from './imagen/prompt-builders';\r\nimport { uploadBase64Image } from './imagen/upload-base64-image';\r\nimport crypto from 'node:crypto';\r\n\r\n// Factory function to create tools with injected sessionId\r\nexport function createChatTools(sessionId: string) {\r\n\r\n    // Define schemas first - ‚úÖ CHAIN OF THOUGHT: Forza l'AI a riflettere sulla struttura prima del prompt\r\n    const GenerateRenderParameters = z.object({\r\n        // 1Ô∏è‚É£ STEP 1: Analizza la struttura (Chain of Thought)\r\n        structuralElements: z.string()\r\n            .min(20)\r\n            .describe(\r\n                'MANDATORY: List ALL structural elements visible in the user photo or mentioned in the request (in ENGLISH). ' +\r\n                'Examples: \"arched window on left wall\", \"exposed wooden ceiling beams\", \"parquet flooring\", \"high ceilings 3.5m\". ' +\r\n                'If no photo was uploaded, describe the structural requests from the conversation (e.g., \"large kitchen island\", \"walk-in shower\").'\r\n            ),\r\n\r\n        // 2Ô∏è‚É£ STEP 2: Type & Style (gi√† esistenti)\r\n        roomType: z.string().min(3).describe('MANDATORY: Type of room in ENGLISH (e.g. \"kitchen\", \"bathroom\").'),\r\n        style: z.string().min(3).describe('MANDATORY: Design style in ENGLISH (e.g. \"industrial\", \"modern\").'),\r\n\r\n        // 3Ô∏è‚É£ STEP 3: Prompt finale (DEVE usare structuralElements)\r\n        prompt: z.string()\r\n            .min(30)\r\n            .describe(\r\n                'MANDATORY: The final detailed prompt for the image generator IN ENGLISH. ' +\r\n                'MUST start by describing the structuralElements listed above. ' +\r\n                'Example: \"A modern living room featuring a large arched window on the left wall, exposed wooden beams on the ceiling, and oak parquet flooring. The space includes...\"'\r\n            ),\r\n\r\n        // üÜï HYBRID TOOL PARAMETERS (Optional - backward compatible)\r\n\r\n        // 4Ô∏è‚É£ Mode selection (creation vs modification)\r\n        mode: z.enum(['creation', 'modification'])\r\n            .optional()\r\n            .default('creation')\r\n            .describe(\r\n                'Choose \"modification\" if user uploaded a photo and wants to transform that specific room. ' +\r\n                'Choose \"creation\" if user is describing an imaginary room from scratch. ' +\r\n                'DEFAULT: \"creation\" if not specified.'\r\n            ),\r\n\r\n        // 5Ô∏è‚É£ Source image URL (required for modification mode)\r\n        sourceImageUrl: z.string()\r\n            .url()\r\n            .optional()\r\n            .describe(\r\n                'REQUIRED if mode=\"modification\". The public HTTPS URL of the uploaded user photo (from Firebase Storage). ' +\r\n                'Search conversation history for URLs like \"https://storage.googleapis.com/...\". ' +\r\n                'If user uploaded a photo but you cannot find the URL, ask them to re-upload. ' +\r\n                'Leave empty for mode=\"creation\".'\r\n            ),\r\n        // 6Ô∏è‚É£ Modification Type (for model selection)\r\n        modificationType: z.enum(['renovation', 'detail'])\r\n            .optional()\r\n            .default('renovation')\r\n            .describe(\r\n                'Choose \"renovation\" for whole-room transformation (default). ' +\r\n                'Choose \"detail\" for small edits (e.g., \"change sofa color\", \"add plant\"). ' +\r\n                'This selects the appropriate AI model.'\r\n            ),\r\n    });\r\n\r\n    const SubmitLeadParameters = z.object({\r\n        name: z.string().max(100).describe('Customer name'),\r\n        email: z.string().email().max(200).describe('Customer email'),\r\n        phone: z.string().max(20).optional().describe('Customer phone number'),\r\n        projectDetails: z.string().max(2000).describe('Detailed project description'),\r\n        roomType: z.string().max(100).optional().describe('Type of room'),\r\n        style: z.string().max(100).optional().describe('Preferred style'),\r\n    });\r\n\r\n    return {\r\n        generate_render: tool({\r\n            description: `Generate a photorealistic 3D rendering of an interior design.\r\n            \r\n            IMPORTANT CONFIRMATION RULE:\r\n            DO NOT call without confirmation! First summarize collected details and ask: \"Vuoi che proceda con la generazione?\"\r\n            \r\n            CRITICAL - AFTER THIS TOOL RETURNS:\r\n            You MUST include the returned imageUrl in your next response using markdown format.\r\n            Example: \"Ecco il rendering!\\\\n\\\\n![](RETURNED_IMAGE_URL)\\\\n\\\\nTi piace?\"\r\n            \r\n            The imageUrl will be in the tool result under result.imageUrl - you MUST display it with ![](url) syntax.`,\r\n            parameters: GenerateRenderParameters,\r\n            execute: async (args: any) => {\r\n                // Extract all parameters including new hybrid parameters\r\n                const { prompt, roomType, style, structuralElements, mode, sourceImageUrl, modificationType } = args || {};\r\n\r\n                try {\r\n                    // Use sessionId from closure (injected via factory)\r\n                    console.log('üèóÔ∏è [Chain of Thought] Structural elements detected:', structuralElements);\r\n                    console.log('üõ†Ô∏è [Hybrid Tool] Mode selected:', mode || 'creation (default)');\r\n                    console.log('üîß [Hybrid Tool] Modification Type:', modificationType || 'renovation (default)');\r\n                    console.log('üé® [generate_render] RECEIVED ARGS:', { prompt, roomType, style, mode, hasSourceImage: !!sourceImageUrl });\r\n\r\n                    const safeRoomType = (roomType || 'room').substring(0, 100);\r\n                    const safeStyle = (style || 'modern').substring(0, 100);\r\n\r\n                    // FAILSAFE: If prompt is empty/short, regenerate it\r\n                    let safePrompt = prompt || `Interior design of a ${safeRoomType} in ${safeStyle} style`;\r\n                    if (safePrompt.length < 10) {\r\n                        console.warn('‚ö†Ô∏è [Failsafe] Short prompt detected, regenerating...');\r\n                        safePrompt = `${safeStyle} style ${safeRoomType} with ${structuralElements || 'modern design'}`;\r\n                    }\r\n\r\n                    console.log('üî• [generate_render] Safe Prompt used:', safePrompt);\r\n\r\n                    // üîÄ ROUTING LOGIC: Choose T2I (creation) or I2I (modification)\r\n                    let imageBuffer: Buffer;\r\n                    let enhancedPrompt: string;\r\n\r\n\r\n                    const actualMode = mode || 'creation'; // Default to creation for backward compatibility\r\n\r\n                    // üîç DEBUG LOGGING\r\n                    console.log('üîç [DEBUG] actualMode:', actualMode);\r\n                    console.log('üîç [DEBUG] sourceImageUrl:', sourceImageUrl);\r\n                    console.log('üîç [DEBUG] mode param:', mode);\r\n                    console.log('üîç [DEBUG] Condition met?', actualMode === 'modification' && sourceImageUrl);\r\n\r\n                    if (actualMode === 'modification' && sourceImageUrl) {\r\n                        try {\r\n                            // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\r\n                            // üì∏ PHOTO-BASED RENOVATION: Vision Analysis ‚Üí T2I\r\n                            // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\r\n                            console.log('[Vision] üì∏ PHOTO-BASED MODE: Analyzing with Gemini Vision ‚Üí T2I');\r\n                            console.log('[Vision] Reference photo:', sourceImageUrl);\r\n\r\n                            // Step 1: Analyze room structure with Gemini Vision\r\n                            console.log('[Vision] Step 1: Analyzing room structure...');\r\n                            const roomAnalysis = await analyzeRoomStructure(sourceImageUrl);\r\n\r\n                            console.log('[Vision] ‚úÖ Analysis complete');\r\n                            console.log('[Vision] Detected:', roomAnalysis.room_type, `(~${roomAnalysis.approximate_size_sqm}sqm)`);\r\n                            console.log('[Vision] Features:', roomAnalysis.architectural_features.join(', '));\r\n\r\n                            // Step 2: Build super-detailed prompt from Vision analysis\r\n                            // ‚úÖ REFACTOR: Use I2I Prompt Builder directly (preserving structure)\r\n                            enhancedPrompt = buildI2IEditingPrompt({\r\n                                userPrompt: safePrompt,\r\n                                structuralElements: roomAnalysis.architectural_features.join(', '),\r\n                                roomType: safeRoomType,\r\n                                style: safeStyle\r\n                            });\r\n\r\n                            console.log('[Vision] Step 2: Generating with I2I using Vision-guided prompt');\r\n                            console.log('[I2I] Prompt preview:', enhancedPrompt.substring(0, 150) + '...');\r\n\r\n                            // Step 3: Generate with Image-to-Image (I2I)\r\n                            // ‚úÖ REFACTOR: Passing sourceImageUrl as referenceImage\r\n                            imageBuffer = await generateInteriorImageI2I({\r\n                                prompt: enhancedPrompt,\r\n                                referenceImage: sourceImageUrl,\r\n                                mode: 'inpainting-insert', // Default for renovation\r\n                                aspectRatio: '16:9',\r\n                                numberOfImages: 1,\r\n                                modificationType: modificationType || 'renovation'\r\n                            });\r\n\r\n                            console.log('[I2I] ‚úÖ Generation complete using Vision-guided I2I');\r\n\r\n                            console.log('[T2I] ‚úÖ Generation complete using Vision-guided T2I');\r\n\r\n                        } catch (visionError) {\r\n                            console.error('[Vision] ‚ö†Ô∏è Analysis failed, falling back to standard T2I:', visionError);\r\n\r\n                            // FALLBACK: Use standard T2I generation\r\n                            console.log('[Fallback] Switching to standard Text-to-Image generation...');\r\n\r\n                            enhancedPrompt = buildInteriorDesignPrompt({\r\n                                userPrompt: safePrompt,\r\n                                roomType: safeRoomType,\r\n                                style: safeStyle,\r\n                            });\r\n\r\n                            imageBuffer = await generateInteriorImage({\r\n                                prompt: enhancedPrompt,\r\n                                aspectRatio: '16:9',\r\n                            });\r\n                        }\r\n\r\n\r\n                    } else {\r\n                        // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\r\n                        // ‚ú® TEXT-TO-IMAGE CREATION MODE (existing flow - unchanged)\r\n                        // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\r\n                        console.log('[Hybrid Tool] ‚ú® Using TEXT-TO-IMAGE generation (creation mode)');\r\n                        console.log('[generate_render] Calling Imagen REST API...');\r\n\r\n                        // Build enhanced prompt (existing logic)\r\n                        enhancedPrompt = buildInteriorDesignPrompt({\r\n                            userPrompt: safePrompt,\r\n                            roomType: safeRoomType,\r\n                            style: safeStyle,\r\n                        });\r\n\r\n                        // Generate image (existing flow)\r\n                        imageBuffer = await generateInteriorImage({\r\n                            prompt: enhancedPrompt,\r\n                            aspectRatio: '16:9',\r\n                        });\r\n                    }\r\n\r\n                    // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\r\n                    // üì§ UPLOAD TO FIREBASE STORAGE (common for both modes)\r\n                    // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\r\n\r\n                    // ‚úÖ BUG FIX #7: Validate image buffer before upload\r\n                    if (!imageBuffer || imageBuffer.length === 0) {\r\n                        throw new Error('Generated image is empty or invalid');\r\n                    }\r\n\r\n                    const maxSizeBytes = 10 * 1024 * 1024; // 10MB limit\r\n                    if (imageBuffer.length > maxSizeBytes) {\r\n                        throw new Error(`Generated image is too large: ${(imageBuffer.length / 1024 / 1024).toFixed(2)}MB (max 10MB)`);\r\n                    }\r\n\r\n                    console.log(`[generate_render] Image validated: ${(imageBuffer.length / 1024).toFixed(2)} KB`);\r\n\r\n                    // Upload to Firebase Storage with session-scoped path\r\n                    const { storage } = await import('./firebase-admin');\r\n                    const bucket = storage().bucket();\r\n\r\n                    // ‚úÖ BUG FIX #2: Add unique ID to prevent race conditions\r\n                    const timestamp = Date.now();\r\n                    const uniqueId = crypto.randomUUID().split('-')[0]; // First segment for brevity\r\n                    const fileName = `renders/${sessionId}/${timestamp}-${uniqueId}-${safeRoomType.replace(/\\s+/g, '-')}.png`;\r\n                    const file = bucket.file(fileName);\r\n\r\n                    await file.save(imageBuffer, {\r\n                        contentType: 'image/png',\r\n                        metadata: {\r\n                            cacheControl: 'public, max-age=31536000',\r\n                        },\r\n                    });\r\n\r\n                    // Generate Signed URL (valid for 7 days)\r\n                    // This replaces makePublic() for better security\r\n                    const [signedUrl] = await file.getSignedUrl({\r\n                        action: 'read',\r\n                        expires: Date.now() + 7 * 24 * 60 * 60 * 1000, // 7 days\r\n                    });\r\n\r\n                    const imageUrl = signedUrl;\r\n                    console.log('[generate_render] ‚úÖ Image uploaded (secure signed URL):', imageUrl.substring(0, 50) + '...');\r\n\r\n                    // Return URL directly - Gemini will receive this and include it in response\r\n                    return {\r\n                        status: 'success',\r\n                        imageUrl,\r\n                        description: `Rendering ${safeStyle} per ${safeRoomType}`,\r\n                        promptUsed: enhancedPrompt\r\n                    };\r\n                } catch (error) {\r\n                    console.error('[generate_render] Error:', error);\r\n                    return {\r\n                        status: 'error',\r\n                        error: error instanceof Error ? error.message : 'Image generation failed'\r\n                    };\r\n                }\r\n            },\r\n        } as any),\r\n\r\n        submit_lead_data: tool({\r\n            description: 'Submit collected lead data (contact information and project details) to Firestore',\r\n            parameters: SubmitLeadParameters,\r\n            execute: async (data: any) => {\r\n                try {\r\n                    console.log('[submit_lead_data] Saving lead to Firestore:', data);\r\n\r\n                    const { getFirestore, Timestamp, FieldValue } = await import('firebase-admin/firestore');\r\n                    const { db } = await import('./firebase-admin');\r\n                    const firestore = db();\r\n\r\n                    await firestore.collection('leads').add({\r\n                        ...data,\r\n                        createdAt: new Date().toISOString(),\r\n                        source: 'chatbot',\r\n                        status: 'new'\r\n                    });\r\n\r\n                    console.log('[submit_lead_data] ‚úÖ Lead saved successfully');\r\n\r\n\r\n                    return {\r\n                        success: true,\r\n                        message: 'Dati salvati con successo! Ti contatteremo presto.'\r\n                    };\r\n                } catch (error) {\r\n                    console.error('[submit_lead_data] Error:', error);\r\n                    return {\r\n                        success: false,\r\n                        message: 'Errore nel salvataggio dei dati.'\r\n                    };\r\n                }\r\n            }\r\n        } as any)\r\n    };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 910, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/ai-retry.ts"],"sourcesContent":["import { streamText } from 'ai';\r\n\r\n/**\r\n * ‚úÖ CRITICAL FIX #3: AI timeout and rate limit handling\r\n * Helper function to call AI with retry logic and timeout\r\n */\r\nconst MAX_RETRIES = 2;\r\nconst TIMEOUT_MS = 45000; // 45 seconds\r\n\r\nasync function callAIWithRetry(config: any, retries = 0): Promise<any> {\r\n    try {\r\n        // Create abort controller for timeout\r\n        const controller = new AbortController();\r\n        const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);\r\n\r\n        const streamPromise = Promise.resolve().then(() =>\r\n            streamText({ ...config, abortSignal: controller.signal })\r\n        );\r\n\r\n        const result = await Promise.race([\r\n            streamPromise,\r\n            new Promise((_, reject) =>\r\n                setTimeout(() => reject(new Error('AI_TIMEOUT')), TIMEOUT_MS)\r\n            )\r\n        ]);\r\n\r\n        clearTimeout(timeoutId);\r\n        return result;\r\n\r\n    } catch (error: any) {\r\n        // Handle timeout errors\r\n        if (error.message === 'AI_TIMEOUT' && retries < MAX_RETRIES) {\r\n            console.warn(`[AI] Timeout, retrying (${retries + 1}/${MAX_RETRIES})`);\r\n            await new Promise(resolve => setTimeout(resolve, 1000 * (retries + 1)));\r\n            return callAIWithRetry(config, retries + 1);\r\n        }\r\n\r\n        // Handle rate limit (429) errors\r\n        if (error.status === 429 && retries < MAX_RETRIES) {\r\n            const retryAfter = parseInt(error.headers?.['retry-after'] || '5');\r\n            console.warn(`[AI] Rate limited, waiting ${retryAfter}s before retry`);\r\n            await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));\r\n            return callAIWithRetry(config, retries + 1);\r\n        }\r\n\r\n        // Throw user-friendly error\r\n        if (error.status === 429) {\r\n            throw new Error('Il servizio √® temporaneamente sovraccarico. Riprova tra qualche minuto.');\r\n        }\r\n        if (error.message === 'AI_TIMEOUT') {\r\n            throw new Error('La richiesta ha impiegato troppo tempo. Riprova.');\r\n        }\r\n        throw error;\r\n    }\r\n}\r\n\r\nexport { callAIWithRetry };\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA;;;CAGC,GACD,MAAM,cAAc;AACpB,MAAM,aAAa,OAAO,aAAa;AAEvC,eAAe,gBAAgB,MAAW,EAAE,UAAU,CAAC;IACnD,IAAI;QACA,sCAAsC;QACtC,MAAM,aAAa,IAAI;QACvB,MAAM,YAAY,WAAW,IAAM,WAAW,KAAK,IAAI;QAEvD,MAAM,gBAAgB,QAAQ,OAAO,GAAG,IAAI,CAAC,IACzC,IAAA,oKAAU,EAAC;gBAAE,GAAG,MAAM;gBAAE,aAAa,WAAW,MAAM;YAAC;QAG3D,MAAM,SAAS,MAAM,QAAQ,IAAI,CAAC;YAC9B;YACA,IAAI,QAAQ,CAAC,GAAG,SACZ,WAAW,IAAM,OAAO,IAAI,MAAM,gBAAgB;SAEzD;QAED,aAAa;QACb,OAAO;IAEX,EAAE,OAAO,OAAY;QACjB,wBAAwB;QACxB,IAAI,MAAM,OAAO,KAAK,gBAAgB,UAAU,aAAa;YACzD,QAAQ,IAAI,CAAC,CAAC,wBAAwB,EAAE,UAAU,EAAE,CAAC,EAAE,YAAY,CAAC,CAAC;YACrE,MAAM,IAAI,QAAQ,CAAA,UAAW,WAAW,SAAS,OAAO,CAAC,UAAU,CAAC;YACpE,OAAO,gBAAgB,QAAQ,UAAU;QAC7C;QAEA,iCAAiC;QACjC,IAAI,MAAM,MAAM,KAAK,OAAO,UAAU,aAAa;YAC/C,MAAM,aAAa,SAAS,MAAM,OAAO,EAAE,CAAC,cAAc,IAAI;YAC9D,QAAQ,IAAI,CAAC,CAAC,2BAA2B,EAAE,WAAW,cAAc,CAAC;YACrE,MAAM,IAAI,QAAQ,CAAA,UAAW,WAAW,SAAS,aAAa;YAC9D,OAAO,gBAAgB,QAAQ,UAAU;QAC7C;QAEA,4BAA4B;QAC5B,IAAI,MAAM,MAAM,KAAK,KAAK;YACtB,MAAM,IAAI,MAAM;QACpB;QACA,IAAI,MAAM,OAAO,KAAK,cAAc;YAChC,MAAM,IAAI,MAAM;QACpB;QACA,MAAM;IACV;AACJ"}},
    {"offset": {"line": 997, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/firebase-admin.ts"],"sourcesContent":["import { initializeApp, cert, getApps, App } from 'firebase-admin/app';\r\nimport { getFirestore, Firestore } from 'firebase-admin/firestore';\r\nimport { getStorage, Storage } from 'firebase-admin/storage';\r\n\r\n/**\r\n * Firebase Admin SDK initialization for server-side operations\r\n * Singleton pattern ensures single instance across serverless invocations\r\n * ALWAYS loads from firebase-service-account.json for reliability\r\n */\r\n\r\nlet firebaseApp: App | undefined;\r\nlet firestoreInstance: Firestore | undefined;\r\nlet storageInstance: Storage | undefined;\r\n\r\n/**\r\n * ‚úÖ CRITICAL FIX #2: Validate Firebase credentials format\r\n * Prevents security risks from malformed credentials\r\n */\r\n/**\r\n * ‚úÖ CRITICAL FIX #2: Sanitize and Validate Firebase Private Key\r\n * Prevents security risks from malformed credentials and ensures correct format.\r\n * Returns the sanitized private key.\r\n */\r\nfunction sanitizeAndValidatePrivateKey(privateKey: string): string {\r\n    if (!privateKey) {\r\n        throw new Error('[Firebase] Private key is missing');\r\n    }\r\n\r\n    // 1. Sanitize: Handle both escaped (\\n) and unescaped newlines\r\n    let sanitizedKey = privateKey.replace(/\\\\n/g, '\\n');\r\n\r\n    // 2. Sanitize: Remove wrapping quotes if present (common env var issue)\r\n    if (sanitizedKey.startsWith('\"') && sanitizedKey.endsWith('\"')) {\r\n        sanitizedKey = sanitizedKey.slice(1, -1);\r\n    }\r\n    if (sanitizedKey.startsWith(\"'\") && sanitizedKey.endsWith(\"'\")) {\r\n        sanitizedKey = sanitizedKey.slice(1, -1);\r\n    }\r\n\r\n    // 3. Validation: Check for standard PEM format markers\r\n    if (!sanitizedKey.includes('BEGIN PRIVATE KEY') || !sanitizedKey.includes('END PRIVATE KEY')) {\r\n        throw new Error('[Firebase] Invalid private key format - must be a valid RSA private key (PEM format)');\r\n    }\r\n\r\n    // 4. Validation: content check\r\n    const keyContent = sanitizedKey.split('BEGIN PRIVATE KEY')[1]?.split('END PRIVATE KEY')[0];\r\n    if (!keyContent || keyContent.trim().length < 100) {\r\n        throw new Error('[Firebase] Private key appears to be truncated or empty');\r\n    }\r\n\r\n    // 5. Re-verify newlines for PEM validity\r\n    if (!sanitizedKey.includes('\\n')) {\r\n        throw new Error('[Firebase] Private key invalid: missing newlines after sanitization');\r\n    }\r\n\r\n    return sanitizedKey;\r\n}\r\n\r\n/**\r\n * Validates other credential fields\r\n */\r\nfunction validateServiceAccount(clientEmail: string, projectId: string): void {\r\n    // Validate email format\r\n    if (!clientEmail || !clientEmail.includes('@') || !clientEmail.endsWith('.gserviceaccount.com')) {\r\n        throw new Error(`[Firebase] Invalid service account email: ${clientEmail} - must end with .gserviceaccount.com`);\r\n    }\r\n\r\n    // Validate project ID format\r\n    if (!projectId || projectId.length < 6 || !/^[a-z0-9-]+$/.test(projectId)) {\r\n        throw new Error(`[Firebase] Invalid project ID: ${projectId} - must contain only lowercase letters, numbers, and hyphens`);\r\n    }\r\n}\r\n\r\n/**\r\n * Initialize Firebase Admin SDK\r\n * Loads from environment variables (Vercel-compatible) or falls back to JSON file\r\n */\r\nfunction initializeFirebase(): App {\r\n    if (getApps().length === 0) {\r\n        console.log('[Firebase] Initializing Firebase Admin SDK...');\r\n\r\n        try {\r\n            // Try environment variables first (Vercel-compatible)\r\n            // Try environment variables first (Vercel-compatible)\r\n            const rawPrivateKey = process.env.FIREBASE_PRIVATE_KEY;\r\n\r\n            if (rawPrivateKey && process.env.FIREBASE_CLIENT_EMAIL && process.env.FIREBASE_PROJECT_ID) {\r\n                console.log('[Firebase] Loading credentials from environment variables');\r\n\r\n                // ‚úÖ CRITICAL FIX #2: Sanitize & Validate\r\n                const privateKey = sanitizeAndValidatePrivateKey(rawPrivateKey);\r\n\r\n                validateServiceAccount(\r\n                    process.env.FIREBASE_CLIENT_EMAIL,\r\n                    process.env.FIREBASE_PROJECT_ID\r\n                );\r\n\r\n                firebaseApp = initializeApp({\r\n                    credential: cert({\r\n                        projectId: process.env.FIREBASE_PROJECT_ID,\r\n                        clientEmail: process.env.FIREBASE_CLIENT_EMAIL,\r\n                        privateKey: privateKey,\r\n                    }),\r\n                    storageBucket: `${process.env.FIREBASE_PROJECT_ID}.firebasestorage.app`,\r\n                });\r\n\r\n                console.log('[Firebase] ‚úÖ Successfully initialized from environment variables');\r\n\r\n                return firebaseApp;\r\n            }\r\n\r\n            // Fallback to JSON file (local development)\r\n            const fs = require('fs');\r\n            const path = require('path');\r\n\r\n            const serviceAccountPath = path.join(process.cwd(), 'firebase-service-account.json');\r\n\r\n            console.log('[Firebase] Loading credentials from:', serviceAccountPath);\r\n\r\n            if (!fs.existsSync(serviceAccountPath)) {\r\n                throw new Error(`Firebase service account file not found at: ${serviceAccountPath}. Please ensure firebase-service-account.json exists in the project root OR set environment variables.`);\r\n            }\r\n\r\n            const serviceAccount = JSON.parse(fs.readFileSync(serviceAccountPath, 'utf8'));\r\n\r\n            // ‚úÖ CRITICAL FIX #2: Validate JSON file credentials\r\n            const privateKey = sanitizeAndValidatePrivateKey(serviceAccount.private_key);\r\n\r\n            validateServiceAccount(\r\n                serviceAccount.client_email,\r\n                serviceAccount.project_id\r\n            );\r\n\r\n            firebaseApp = initializeApp({\r\n                credential: cert({\r\n                    ...serviceAccount,\r\n                    private_key: privateKey // Use sanitized key\r\n                }),\r\n                storageBucket: serviceAccount.project_id + '.firebasestorage.app',\r\n            });\r\n\r\n            console.log('[Firebase] ‚úÖ Successfully initialized from JSON file');\r\n\r\n            return firebaseApp!; // Assert not null since we just initialized it\r\n        } catch (error) {\r\n            console.error('[Firebase] ‚ùå Initialization FAILED:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    return getApps()[0];\r\n}\r\n\r\n/**\r\n * Get Firestore instance (singleton)\r\n * CRITICAL FIX: Removed settings() call to prevent re-initialization error\r\n */\r\nexport function getFirestoreDb(): Firestore {\r\n    if (!firestoreInstance) {\r\n        const app = initializeFirebase();\r\n        firestoreInstance = getFirestore(app);\r\n        // REMOVED: settings() call - was causing \"already initialized\" error\r\n    }\r\n\r\n    return firestoreInstance;\r\n}\r\n\r\n/**\r\n * Get Firebase Storage instance (singleton)\r\n */\r\nexport function getFirebaseStorage(): Storage {\r\n    if (!storageInstance) {\r\n        const app = initializeFirebase();\r\n        storageInstance = getStorage(app);\r\n    }\r\n\r\n    return storageInstance;\r\n}\r\n\r\n// Export convenient aliases\r\nexport const db = getFirestoreDb;\r\nexport const storage = getFirebaseStorage;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1149, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/db/schema.ts"],"sourcesContent":["import { Timestamp } from 'firebase-admin/firestore';\r\n\r\n/**\r\n * Firestore Schema Definitions\r\n * Collections: users, sessions, messages (subcollection), leads\r\n */\r\n\r\n// /users/{userId}\r\nexport interface User {\r\n    email: string;\r\n    displayName: string;\r\n    photoURL?: string;\r\n    createdAt: Timestamp;\r\n    plan: 'free' | 'pro';\r\n    metadata: {\r\n        totalSessions: number;\r\n        totalMessages: number;\r\n        totalImagesGenerated: number;\r\n    };\r\n}\r\n\r\n// /sessions/{sessionId}\r\nexport interface Session {\r\n    userId?: string;\r\n    createdAt: Timestamp;\r\n    updatedAt: Timestamp;\r\n    summary?: string; // AI-generated summary for old sessions\r\n    messageCount: number;\r\n    status: 'active' | 'archived';\r\n    lastMessagePreview?: string;\r\n}\r\n\r\n// /sessions/{sessionId}/messages/{messageId}\r\nexport interface Message {\r\n    role: 'user' | 'assistant' | 'system';\r\n    content: string;\r\n    timestamp: Timestamp;\r\n    tokens?: {\r\n        input: number;\r\n        output: number;\r\n    };\r\n    imageUrl?: string; // For generated images\r\n    toolCalls?: Array<{\r\n        name: string;\r\n        args: any;\r\n        result: any;\r\n    }>;\r\n}\r\n\r\n// /leads/{leadId}\r\nexport interface Lead {\r\n    sessionId: string;\r\n    userId?: string;\r\n    name: string;\r\n    email: string;\r\n    phone?: string;\r\n    projectDetails: string;\r\n    roomType?: string;\r\n    style?: string;\r\n    estimatedBudget?: string;\r\n    createdAt: Timestamp;\r\n    status: 'new' | 'contacted' | 'converted';\r\n}\r\n\r\n// Collection names (constants for type safety)\r\nexport const COLLECTIONS = {\r\n    USERS: 'users',\r\n    SESSIONS: 'sessions',\r\n    MESSAGES: 'messages', // subcollection under sessions\r\n    LEADS: 'leads',\r\n} as const;\r\n"],"names":[],"mappings":";;;;AAiEO,MAAM,cAAc;IACvB,OAAO;IACP,UAAU;IACV,UAAU;IACV,OAAO;AACX"}},
    {"offset": {"line": 1165, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/db/leads.ts"],"sourcesContent":["import { db } from '../firebase-admin';\r\nimport { COLLECTIONS, Lead } from './schema';\r\nimport { FieldValue } from 'firebase-admin/firestore';\r\n\r\n/**\r\n * Save lead data to Firestore\r\n * Called from the submit_lead_data tool\r\n */\r\nexport async function saveLead(data: {\r\n    sessionId: string;\r\n    userId?: string;\r\n    name: string;\r\n    email: string;\r\n    phone?: string;\r\n    projectDetails: string;\r\n    roomType?: string;\r\n    style?: string;\r\n    estimatedBudget?: string;\r\n}): Promise<{ success: boolean; leadId?: string; error?: string }> {\r\n    try {\r\n        const firestore = db();\r\n\r\n        const leadData: Omit<Lead, 'createdAt'> & { createdAt: any } = {\r\n            ...data,\r\n            createdAt: FieldValue.serverTimestamp(),\r\n            status: 'new',\r\n        };\r\n\r\n        const leadRef = await firestore\r\n            .collection(COLLECTIONS.LEADS)\r\n            .add(leadData);\r\n\r\n        console.log(`[saveLead] Lead saved with ID: ${leadRef.id}`);\r\n\r\n        return {\r\n            success: true,\r\n            leadId: leadRef.id,\r\n        };\r\n\r\n    } catch (error) {\r\n        console.error('[saveLead] Error saving lead:', error);\r\n        return {\r\n            success: false,\r\n            error: error instanceof Error ? error.message : 'Unknown error',\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Get all leads (for admin dashboard - optional)\r\n */\r\nexport async function getLeads(\r\n    status?: 'new' | 'contacted' | 'converted',\r\n    limit: number = 50\r\n): Promise<Lead[]> {\r\n    try {\r\n        const firestore = db();\r\n\r\n        let query = firestore\r\n            .collection(COLLECTIONS.LEADS)\r\n            .orderBy('createdAt', 'desc')\r\n            .limit(limit);\r\n\r\n        if (status) {\r\n            query = query.where('status', '==', status) as any;\r\n        }\r\n\r\n        const snapshot = await query.get();\r\n\r\n        return snapshot.docs.map(doc => ({\r\n            ...doc.data(),\r\n            id: doc.id,\r\n        })) as unknown as Lead[];\r\n\r\n    } catch (error) {\r\n        console.error('[getLeads] Error fetching leads:', error);\r\n        return [];\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;;;;;;AAMO,eAAe,SAAS,IAU9B;IACG,IAAI;QACA,MAAM,YAAY,IAAA,2IAAE;QAEpB,MAAM,WAAyD;YAC3D,GAAG,IAAI;YACP,WAAW,0KAAU,CAAC,eAAe;YACrC,QAAQ;QACZ;QAEA,MAAM,UAAU,MAAM,UACjB,UAAU,CAAC,+IAAW,CAAC,KAAK,EAC5B,GAAG,CAAC;QAET,QAAQ,GAAG,CAAC,CAAC,+BAA+B,EAAE,QAAQ,EAAE,EAAE;QAE1D,OAAO;YACH,SAAS;YACT,QAAQ,QAAQ,EAAE;QACtB;IAEJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,iCAAiC;QAC/C,OAAO;YACH,SAAS;YACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACpD;IACJ;AACJ;AAKO,eAAe,SAClB,MAA0C,EAC1C,QAAgB,EAAE;IAElB,IAAI;QACA,MAAM,YAAY,IAAA,2IAAE;QAEpB,IAAI,QAAQ,UACP,UAAU,CAAC,+IAAW,CAAC,KAAK,EAC5B,OAAO,CAAC,aAAa,QACrB,KAAK,CAAC;QAEX,IAAI,QAAQ;YACR,QAAQ,MAAM,KAAK,CAAC,UAAU,MAAM;QACxC;QAEA,MAAM,WAAW,MAAM,MAAM,GAAG;QAEhC,OAAO,SAAS,IAAI,CAAC,GAAG,CAAC,CAAA,MAAO,CAAC;gBAC7B,GAAG,IAAI,IAAI,EAAE;gBACb,IAAI,IAAI,EAAE;YACd,CAAC;IAEL,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,oCAAoC;QAClD,OAAO,EAAE;IACb;AACJ"}},
    {"offset": {"line": 1228, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/db/messages.ts"],"sourcesContent":["import { db } from '../firebase-admin';\r\nimport { COLLECTIONS } from './schema';\r\nimport { FieldValue } from 'firebase-admin/firestore';\r\n\r\n/**\r\n * Get conversation context (last N messages) for a session\r\n * Optimized for low latency (~30-50ms)\r\n */\r\nexport async function getConversationContext(\r\n    sessionId: string,\r\n    limit: number = 10\r\n): Promise<Array<{ role: string; content: string; toolInvocations?: any[] }>> {\r\n    try {\r\n        const firestore = db();\r\n\r\n        // Query last N messages, ordered by timestamp descending\r\n        const messagesRef = firestore\r\n            .collection(COLLECTIONS.SESSIONS)\r\n            .doc(sessionId)\r\n            .collection(COLLECTIONS.MESSAGES)\r\n            .orderBy('timestamp', 'desc')\r\n            .limit(limit);\r\n\r\n        const snapshot = await messagesRef.get();\r\n\r\n        if (snapshot.empty) {\r\n            console.log(`[getConversationContext] No messages found for session: ${sessionId}`);\r\n            return [];\r\n        }\r\n\r\n        // Convert to array and reverse (oldest first for chat context)\r\n        const messages = snapshot.docs\r\n            .map(doc => {\r\n                const data = doc.data();\r\n                return {\r\n                    role: data.role as 'user' | 'assistant' | 'system',\r\n                    content: data.content as string,\r\n                    toolInvocations: data.toolCalls?.map((tc: any) => ({\r\n                        toolCallId: crypto.randomUUID(), // Generate transient ID\r\n                        toolName: tc.name,\r\n                        args: tc.args,\r\n                        state: 'result',\r\n                        result: tc.result\r\n                    }))\r\n                };\r\n            })\r\n            .reverse(); // Reverse to get chronological order\r\n\r\n        console.log(`[getConversationContext] Loaded ${messages.length} messages for session: ${sessionId}`);\r\n        return messages;\r\n\r\n    } catch (error) {\r\n        console.error('[getConversationContext] Error loading context:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n/**\r\n * Save a message to Firestore\r\n * Non-blocking operation for performance\r\n */\r\nexport async function saveMessage(\r\n    sessionId: string,\r\n    role: 'user' | 'assistant' | 'system',\r\n    content: string,\r\n    metadata?: {\r\n        imageUrl?: string;\r\n        toolCalls?: Array<{ name: string; args: any; result: any }>;\r\n        tokens?: { input: number; output: number };\r\n    }\r\n): Promise<void> {\r\n    try {\r\n        const firestore = db();\r\n\r\n        const messageData = {\r\n            role,\r\n            content,\r\n            timestamp: FieldValue.serverTimestamp(),\r\n            ...metadata,\r\n        };\r\n\r\n        // Add message to subcollection\r\n        await firestore\r\n            .collection(COLLECTIONS.SESSIONS)\r\n            .doc(sessionId)\r\n            .collection(COLLECTIONS.MESSAGES)\r\n            .add(messageData);\r\n\r\n        // Update session metadata\r\n        await firestore\r\n            .collection(COLLECTIONS.SESSIONS)\r\n            .doc(sessionId)\r\n            .set(\r\n                {\r\n                    updatedAt: FieldValue.serverTimestamp(),\r\n                    messageCount: FieldValue.increment(1),\r\n                    lastMessagePreview: content.substring(0, 100),\r\n                },\r\n                { merge: true }\r\n            );\r\n\r\n        console.log(`[saveMessage] Saved ${role} message to session: ${sessionId}`);\r\n\r\n    } catch (error) {\r\n        console.error('[saveMessage] Error saving message:', error);\r\n        // Don't throw - message save failures shouldn't break the chat\r\n    }\r\n}\r\n\r\n/**\r\n * Create or update a session\r\n */\r\nexport async function ensureSession(sessionId: string): Promise<void> {\r\n    try {\r\n        const firestore = db();\r\n        const sessionRef = firestore.collection(COLLECTIONS.SESSIONS).doc(sessionId);\r\n\r\n        const session = await sessionRef.get();\r\n\r\n        if (!session.exists) {\r\n            await sessionRef.set({\r\n                createdAt: FieldValue.serverTimestamp(),\r\n                updatedAt: FieldValue.serverTimestamp(),\r\n                messageCount: 0,\r\n                status: 'active',\r\n            });\r\n\r\n            console.log(`[ensureSession] Created new session: ${sessionId}`);\r\n        }\r\n    } catch (error) {\r\n        console.error('[ensureSession] Error ensuring session:', error);\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;AACA;;;;;;;;;AAMO,eAAe,uBAClB,SAAiB,EACjB,QAAgB,EAAE;IAElB,IAAI;QACA,MAAM,YAAY,IAAA,2IAAE;QAEpB,yDAAyD;QACzD,MAAM,cAAc,UACf,UAAU,CAAC,+IAAW,CAAC,QAAQ,EAC/B,GAAG,CAAC,WACJ,UAAU,CAAC,+IAAW,CAAC,QAAQ,EAC/B,OAAO,CAAC,aAAa,QACrB,KAAK,CAAC;QAEX,MAAM,WAAW,MAAM,YAAY,GAAG;QAEtC,IAAI,SAAS,KAAK,EAAE;YAChB,QAAQ,GAAG,CAAC,CAAC,wDAAwD,EAAE,WAAW;YAClF,OAAO,EAAE;QACb;QAEA,+DAA+D;QAC/D,MAAM,WAAW,SAAS,IAAI,CACzB,GAAG,CAAC,CAAA;YACD,MAAM,OAAO,IAAI,IAAI;YACrB,OAAO;gBACH,MAAM,KAAK,IAAI;gBACf,SAAS,KAAK,OAAO;gBACrB,iBAAiB,KAAK,SAAS,EAAE,IAAI,CAAC,KAAY,CAAC;wBAC/C,YAAY,OAAO,UAAU;wBAC7B,UAAU,GAAG,IAAI;wBACjB,MAAM,GAAG,IAAI;wBACb,OAAO;wBACP,QAAQ,GAAG,MAAM;oBACrB,CAAC;YACL;QACJ,GACC,OAAO,IAAI,qCAAqC;QAErD,QAAQ,GAAG,CAAC,CAAC,gCAAgC,EAAE,SAAS,MAAM,CAAC,uBAAuB,EAAE,WAAW;QACnG,OAAO;IAEX,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,mDAAmD;QACjE,OAAO,EAAE;IACb;AACJ;AAMO,eAAe,YAClB,SAAiB,EACjB,IAAqC,EACrC,OAAe,EACf,QAIC;IAED,IAAI;QACA,MAAM,YAAY,IAAA,2IAAE;QAEpB,MAAM,cAAc;YAChB;YACA;YACA,WAAW,0KAAU,CAAC,eAAe;YACrC,GAAG,QAAQ;QACf;QAEA,+BAA+B;QAC/B,MAAM,UACD,UAAU,CAAC,+IAAW,CAAC,QAAQ,EAC/B,GAAG,CAAC,WACJ,UAAU,CAAC,+IAAW,CAAC,QAAQ,EAC/B,GAAG,CAAC;QAET,0BAA0B;QAC1B,MAAM,UACD,UAAU,CAAC,+IAAW,CAAC,QAAQ,EAC/B,GAAG,CAAC,WACJ,GAAG,CACA;YACI,WAAW,0KAAU,CAAC,eAAe;YACrC,cAAc,0KAAU,CAAC,SAAS,CAAC;YACnC,oBAAoB,QAAQ,SAAS,CAAC,GAAG;QAC7C,GACA;YAAE,OAAO;QAAK;QAGtB,QAAQ,GAAG,CAAC,CAAC,oBAAoB,EAAE,KAAK,qBAAqB,EAAE,WAAW;IAE9E,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,uCAAuC;IACrD,+DAA+D;IACnE;AACJ;AAKO,eAAe,cAAc,SAAiB;IACjD,IAAI;QACA,MAAM,YAAY,IAAA,2IAAE;QACpB,MAAM,aAAa,UAAU,UAAU,CAAC,+IAAW,CAAC,QAAQ,EAAE,GAAG,CAAC;QAElE,MAAM,UAAU,MAAM,WAAW,GAAG;QAEpC,IAAI,CAAC,QAAQ,MAAM,EAAE;YACjB,MAAM,WAAW,GAAG,CAAC;gBACjB,WAAW,0KAAU,CAAC,eAAe;gBACrC,WAAW,0KAAU,CAAC,eAAe;gBACrC,cAAc;gBACd,QAAQ;YACZ;YAEA,QAAQ,GAAG,CAAC,CAAC,qCAAqC,EAAE,WAAW;QACnE;IACJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,2CAA2C;IAC7D;AACJ"}},
    {"offset": {"line": 1327, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/imagen/upload-base64-image.ts"],"sourcesContent":["/**\r\n * Upload base64 image to Firebase Storage and return public URL\r\n * \r\n * Required for Imagen Capability API which needs HTTP/GCS URLs instead of base64\r\n * This is a helper function for the hybrid tool implementation\r\n */\r\n\r\n/**\r\n * Upload base64 encoded image to Firebase Storage\r\n * \r\n * @param options.base64Data - Base64 data URL (e.g., data:image/jpeg;base64,...)\r\n * @param options.sessionId - User session ID for organizing uploads\r\n * @param options.prefix - Optional prefix for storage path (default: 'user-uploads')\r\n * @returns Public HTTPS URL to the uploaded image\r\n * \r\n * @example\r\n * ```typescript\r\n * const url = await uploadBase64Image({\r\n *   base64Data: 'data:image/jpeg;base64,/9j/4AAQSkZ...',\r\n *   sessionId: 'abc123',\r\n *   prefix: 'user-uploads'\r\n * });\r\n * // Returns: https://storage.googleapis.com/bucket-name/user-uploads/abc123/1234567890-xyz.jpeg\r\n * ```\r\n */\r\nexport async function uploadBase64Image(options: {\r\n    base64Data: string;\r\n    sessionId: string;\r\n    prefix?: string;\r\n}): Promise<string> {\r\n    const { base64Data, sessionId, prefix = 'user-uploads' } = options;\r\n\r\n    console.log('[Upload Base64] Starting upload...');\r\n\r\n    try {\r\n        // üîí SECURITY: Validate and sanitize sessionId (prevent path traversal)\r\n        if (typeof sessionId !== 'string' || !/^[a-zA-Z0-9-]{20,50}$/.test(sessionId)) {\r\n            throw new Error('Invalid sessionId format');\r\n        }\r\n\r\n        // 1. Parse base64 data URL to extract MIME type and data\r\n        const matches = base64Data.match(/^data:([A-Za-z-+\\/]+);base64,(.+)$/);\r\n\r\n        if (!matches || matches.length !== 3) {\r\n            throw new Error('Invalid base64 format. Expected: data:image/TYPE;base64,DATA');\r\n        }\r\n\r\n        const mimeType = matches[1]; // e.g., 'image/jpeg', 'image/png'\r\n        const base64String = matches[2];\r\n\r\n        console.log(`[Upload Base64] Detected MIME type: ${mimeType}`);\r\n\r\n        // 2. Convert base64 string to Buffer\r\n        const imageBuffer = Buffer.from(base64String, 'base64');\r\n\r\n        // 3. Validate image size (max 10MB to match existing validation)\r\n        const maxSizeBytes = 10 * 1024 * 1024; // 10MB\r\n        if (imageBuffer.length > maxSizeBytes) {\r\n            const sizeMB = (imageBuffer.length / 1024 / 1024).toFixed(2);\r\n            throw new Error(`Image too large: ${sizeMB}MB (maximum 10MB allowed)`);\r\n        }\r\n\r\n        const sizeKB = (imageBuffer.length / 1024).toFixed(2);\r\n        console.log(`[Upload Base64] Image size: ${sizeKB} KB`);\r\n\r\n        // 4. Generate unique filename to prevent collisions\r\n        const timestamp = Date.now();\r\n        const uniqueId = crypto.randomUUID().split('-')[0]; // First segment for brevity\r\n        const extension = mimeType.split('/')[1]; // Extract extension (jpeg, png, webp, etc.)\r\n\r\n        // üîí SECURITY: sessionId is already validated, safe to use in path\r\n        const fileName = `${prefix}/${sessionId}/${timestamp}-${uniqueId}.${extension}`;\r\n\r\n        console.log(`[Upload Base64] Target path: ${fileName}`);\r\n\r\n        // 5. Import Firebase Storage dynamically (to avoid initialization issues)\r\n        const { storage } = await import('../firebase-admin');\r\n        const bucket = storage().bucket();\r\n\r\n        // 6. Upload to Firebase Storage\r\n        const file = bucket.file(fileName);\r\n\r\n        await file.save(imageBuffer, {\r\n            contentType: mimeType,\r\n            metadata: {\r\n                cacheControl: 'public, max-age=31536000', // Cache for 1 year\r\n                metadata: {\r\n                    uploadedAt: new Date().toISOString(),\r\n                    sessionId: sessionId,\r\n                    source: 'chatbot-upload',\r\n                },\r\n            },\r\n        });\r\n\r\n        console.log('[Upload Base64] File saved to Storage');\r\n\r\n        // 7. Make file publicly accessible\r\n        await file.makePublic();\r\n\r\n        console.log('[Upload Base64] File made public');\r\n\r\n        // 8. Generate and return public URL\r\n        const publicUrl = `https://storage.googleapis.com/${bucket.name}/${fileName}`;\r\n\r\n        console.log(`[Upload Base64] ‚úÖ Upload complete: ${publicUrl}`);\r\n\r\n        return publicUrl;\r\n\r\n    } catch (error) {\r\n        console.error('[Upload Base64] ‚ùå Error:', error);\r\n\r\n        // Provide user-friendly error messages\r\n        if (error instanceof Error) {\r\n            // Re-throw validation errors as-is\r\n            if (error.message.includes('Invalid base64') || error.message.includes('too large')) {\r\n                throw error;\r\n            }\r\n\r\n            // Handle Firebase errors\r\n            if (error.message.includes('PERMISSION_DENIED')) {\r\n                throw new Error('Storage permission denied. Please check Firebase Storage rules.');\r\n            }\r\n\r\n            if (error.message.includes('QUOTA_EXCEEDED')) {\r\n                throw new Error('Storage quota exceeded. Please contact support.');\r\n            }\r\n        }\r\n\r\n        // Generic error for unexpected issues\r\n        throw new Error('Failed to upload image. Please try again.');\r\n    }\r\n}\r\n\r\n/**\r\n * Validate if a string is a valid base64 data URL\r\n * \r\n * @param data - String to validate\r\n * @returns true if valid base64 data URL, false otherwise\r\n */\r\nexport function isValidBase64DataUrl(data: string): boolean {\r\n    const base64Regex = /^data:image\\/(jpeg|jpg|png|gif|webp|bmp);base64,/;\r\n    return base64Regex.test(data);\r\n}\r\n\r\n/**\r\n * Extract MIME type from base64 data URL\r\n * \r\n * @param base64Data - Base64 data URL\r\n * @returns MIME type (e.g., 'image/jpeg') or null if invalid\r\n */\r\nexport function extractMimeType(base64Data: string): string | null {\r\n    const matches = base64Data.match(/^data:([A-Za-z-+\\/]+);base64,/);\r\n    return matches ? matches[1] : null;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1448, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/index.ts"],"sourcesContent":["export * from './vision/analyze-room';\r\nexport * from './imagen/generate-interior';\r\nexport * from './imagen/prompt-builders';\r\nexport * from './chat-tools';\r\nexport * from './ai-retry';\r\nexport * from './db/leads';\r\nexport * from './db/messages';\r\nexport * from './db/schema';\r\nexport * from './imagen/upload-base64-image';\r\n"],"names":[],"mappings":";AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA"}},
    {"offset": {"line": 1479, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/web_client/app/api/chat/history/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { getConversationContext } from '@ai-core';\r\n\r\nexport const runtime = 'nodejs';\r\nexport const dynamic = 'force-dynamic';\r\n\r\n/**\r\n * GET /api/chat/history?sessionId=xxx\r\n * Load conversation history for a session\r\n */\r\nexport async function GET(req: NextRequest) {\r\n    try {\r\n        const { searchParams } = new URL(req.url);\r\n        const sessionId = searchParams.get('sessionId');\r\n\r\n        if (!sessionId) {\r\n            return NextResponse.json(\r\n                { error: 'sessionId is required' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        console.log('[GET /api/chat/history] Loading history for session:', sessionId);\r\n\r\n        // Load last 50 messages from Firestore\r\n        const messages = await getConversationContext(sessionId, 50);\r\n\r\n        console.log('[GET /api/chat/history] Loaded', messages.length, 'messages');\r\n\r\n        return NextResponse.json({\r\n            messages,\r\n            sessionId,\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('[GET /api/chat/history] Error:', error);\r\n        return NextResponse.json(\r\n            { error: 'Failed to load history' },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;AAAA;;;;;;;;AAEO,MAAM,UAAU;AAChB,MAAM,UAAU;AAMhB,eAAe,IAAI,GAAgB;IACtC,IAAI;QACA,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,IAAI,GAAG;QACxC,MAAM,YAAY,aAAa,GAAG,CAAC;QAEnC,IAAI,CAAC,WAAW;YACZ,OAAO,gJAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAAwB,GACjC;gBAAE,QAAQ;YAAI;QAEtB;QAEA,QAAQ,GAAG,CAAC,wDAAwD;QAEpE,uCAAuC;QACvC,MAAM,WAAW,MAAM,IAAA,4JAAsB,EAAC,WAAW;QAEzD,QAAQ,GAAG,CAAC,kCAAkC,SAAS,MAAM,EAAE;QAE/D,OAAO,gJAAY,CAAC,IAAI,CAAC;YACrB;YACA;QACJ;IAEJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,kCAAkC;QAChD,OAAO,gJAAY,CAAC,IAAI,CACpB;YAAE,OAAO;QAAyB,GAClC;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}