{"version":3,"sources":["../../../../node_modules/%40ai-sdk/google/src/google-provider.ts","../../../../node_modules/%40ai-sdk/google/src/version.ts","../../../../node_modules/%40ai-sdk/google/src/google-generative-ai-embedding-model.ts","../../../../node_modules/%40ai-sdk/google/src/google-error.ts","../../../../node_modules/%40ai-sdk/google/src/google-generative-ai-embedding-options.ts","../../../../node_modules/%40ai-sdk/google/src/google-generative-ai-language-model.ts","../../../../node_modules/%40ai-sdk/google/src/convert-google-generative-ai-usage.ts","../../../../node_modules/%40ai-sdk/google/src/convert-json-schema-to-openapi-schema.ts","../../../../node_modules/%40ai-sdk/google/src/convert-to-google-generative-ai-messages.ts","../../../../node_modules/%40ai-sdk/google/src/get-model-path.ts","../../../../node_modules/%40ai-sdk/google/src/google-generative-ai-options.ts","../../../../node_modules/%40ai-sdk/google/src/google-prepare-tools.ts","../../../../node_modules/%40ai-sdk/google/src/map-google-generative-ai-finish-reason.ts","../../../../node_modules/%40ai-sdk/google/src/tool/code-execution.ts","../../../../node_modules/%40ai-sdk/google/src/tool/enterprise-web-search.ts","../../../../node_modules/%40ai-sdk/google/src/tool/file-search.ts","../../../../node_modules/%40ai-sdk/google/src/tool/google-maps.ts","../../../../node_modules/%40ai-sdk/google/src/tool/google-search.ts","../../../../node_modules/%40ai-sdk/google/src/tool/url-context.ts","../../../../node_modules/%40ai-sdk/google/src/tool/vertex-rag-store.ts","../../../../node_modules/%40ai-sdk/google/src/google-tools.ts","../../../../node_modules/%40ai-sdk/google/src/google-generative-ai-image-model.ts","../../../../web_client/app/api/chat/route.ts","../../../../node_modules/next/src/build/templates/app-route.ts"],"sourcesContent":["import {\n  EmbeddingModelV3,\n  LanguageModelV3,\n  ProviderV3,\n  ImageModelV3,\n} from '@ai-sdk/provider';\nimport {\n  FetchFunction,\n  generateId,\n  loadApiKey,\n  withoutTrailingSlash,\n  withUserAgentSuffix,\n} from '@ai-sdk/provider-utils';\nimport { VERSION } from './version';\nimport { GoogleGenerativeAIEmbeddingModel } from './google-generative-ai-embedding-model';\nimport { GoogleGenerativeAIEmbeddingModelId } from './google-generative-ai-embedding-options';\nimport { GoogleGenerativeAILanguageModel } from './google-generative-ai-language-model';\nimport { GoogleGenerativeAIModelId } from './google-generative-ai-options';\nimport { googleTools } from './google-tools';\n\nimport {\n  GoogleGenerativeAIImageSettings,\n  GoogleGenerativeAIImageModelId,\n} from './google-generative-ai-image-settings';\nimport { GoogleGenerativeAIImageModel } from './google-generative-ai-image-model';\n\nexport interface GoogleGenerativeAIProvider extends ProviderV3 {\n  (modelId: GoogleGenerativeAIModelId): LanguageModelV3;\n\n  languageModel(modelId: GoogleGenerativeAIModelId): LanguageModelV3;\n\n  chat(modelId: GoogleGenerativeAIModelId): LanguageModelV3;\n\n  /**\nCreates a model for image generation.\n */\n  image(\n    modelId: GoogleGenerativeAIImageModelId,\n    settings?: GoogleGenerativeAIImageSettings,\n  ): ImageModelV3;\n\n  /**\n   * @deprecated Use `chat()` instead.\n   */\n  generativeAI(modelId: GoogleGenerativeAIModelId): LanguageModelV3;\n\n  /**\n   * Creates a model for text embeddings.\n   */\n  embedding(modelId: GoogleGenerativeAIEmbeddingModelId): EmbeddingModelV3;\n\n  /**\n   * Creates a model for text embeddings.\n   */\n  embeddingModel(modelId: GoogleGenerativeAIEmbeddingModelId): EmbeddingModelV3;\n\n  /**\n   * @deprecated Use `embedding` instead.\n   */\n  textEmbedding(modelId: GoogleGenerativeAIEmbeddingModelId): EmbeddingModelV3;\n\n  /**\n   * @deprecated Use `embeddingModel` instead.\n   */\n  textEmbeddingModel(\n    modelId: GoogleGenerativeAIEmbeddingModelId,\n  ): EmbeddingModelV3;\n\n  tools: typeof googleTools;\n}\n\nexport interface GoogleGenerativeAIProviderSettings {\n  /**\nUse a different URL prefix for API calls, e.g. to use proxy servers.\nThe default prefix is `https://generativelanguage.googleapis.com/v1beta`.\n   */\n  baseURL?: string;\n\n  /**\nAPI key that is being send using the `x-goog-api-key` header.\nIt defaults to the `GOOGLE_GENERATIVE_AI_API_KEY` environment variable.\n   */\n  apiKey?: string;\n\n  /**\nCustom headers to include in the requests.\n     */\n  headers?: Record<string, string | undefined>;\n\n  /**\nCustom fetch implementation. You can use it as a middleware to intercept requests,\nor to provide a custom fetch implementation for e.g. testing.\n    */\n  fetch?: FetchFunction;\n\n  /**\nOptional function to generate a unique ID for each request.\n     */\n  generateId?: () => string;\n\n  /**\n   * Custom provider name\n   * Defaults to 'google.generative-ai'.\n   */\n  name?: string;\n}\n\n/**\nCreate a Google Generative AI provider instance.\n */\nexport function createGoogleGenerativeAI(\n  options: GoogleGenerativeAIProviderSettings = {},\n): GoogleGenerativeAIProvider {\n  const baseURL =\n    withoutTrailingSlash(options.baseURL) ??\n    'https://generativelanguage.googleapis.com/v1beta';\n\n  const providerName = options.name ?? 'google.generative-ai';\n\n  const getHeaders = () =>\n    withUserAgentSuffix(\n      {\n        'x-goog-api-key': loadApiKey({\n          apiKey: options.apiKey,\n          environmentVariableName: 'GOOGLE_GENERATIVE_AI_API_KEY',\n          description: 'Google Generative AI',\n        }),\n        ...options.headers,\n      },\n      `ai-sdk/google/${VERSION}`,\n    );\n\n  const createChatModel = (modelId: GoogleGenerativeAIModelId) =>\n    new GoogleGenerativeAILanguageModel(modelId, {\n      provider: providerName,\n      baseURL,\n      headers: getHeaders,\n      generateId: options.generateId ?? generateId,\n      supportedUrls: () => ({\n        '*': [\n          // Google Generative Language \"files\" endpoint\n          // e.g. https://generativelanguage.googleapis.com/v1beta/files/...\n          new RegExp(`^${baseURL}/files/.*$`),\n          // YouTube URLs (public or unlisted videos)\n          new RegExp(\n            `^https://(?:www\\\\.)?youtube\\\\.com/watch\\\\?v=[\\\\w-]+(?:&[\\\\w=&.-]*)?$`,\n          ),\n          new RegExp(`^https://youtu\\\\.be/[\\\\w-]+(?:\\\\?[\\\\w=&.-]*)?$`),\n        ],\n      }),\n      fetch: options.fetch,\n    });\n\n  const createEmbeddingModel = (modelId: GoogleGenerativeAIEmbeddingModelId) =>\n    new GoogleGenerativeAIEmbeddingModel(modelId, {\n      provider: providerName,\n      baseURL,\n      headers: getHeaders,\n      fetch: options.fetch,\n    });\n\n  const createImageModel = (\n    modelId: GoogleGenerativeAIImageModelId,\n    settings: GoogleGenerativeAIImageSettings = {},\n  ) =>\n    new GoogleGenerativeAIImageModel(modelId, settings, {\n      provider: providerName,\n      baseURL,\n      headers: getHeaders,\n      fetch: options.fetch,\n    });\n\n  const provider = function (modelId: GoogleGenerativeAIModelId) {\n    if (new.target) {\n      throw new Error(\n        'The Google Generative AI model function cannot be called with the new keyword.',\n      );\n    }\n\n    return createChatModel(modelId);\n  };\n\n  provider.specificationVersion = 'v3' as const;\n  provider.languageModel = createChatModel;\n  provider.chat = createChatModel;\n  provider.generativeAI = createChatModel;\n  provider.embedding = createEmbeddingModel;\n  provider.embeddingModel = createEmbeddingModel;\n  provider.textEmbedding = createEmbeddingModel;\n  provider.textEmbeddingModel = createEmbeddingModel;\n  provider.image = createImageModel;\n  provider.imageModel = createImageModel;\n  provider.tools = googleTools;\n\n  return provider as GoogleGenerativeAIProvider;\n}\n\n/**\nDefault Google Generative AI provider instance.\n */\nexport const google = createGoogleGenerativeAI();\n","// Version string of this package injected at build time.\ndeclare const __PACKAGE_VERSION__: string | undefined;\nexport const VERSION: string =\n  typeof __PACKAGE_VERSION__ !== 'undefined'\n    ? __PACKAGE_VERSION__\n    : '0.0.0-test';\n","import {\n  EmbeddingModelV3,\n  TooManyEmbeddingValuesForCallError,\n} from '@ai-sdk/provider';\nimport {\n  combineHeaders,\n  createJsonResponseHandler,\n  FetchFunction,\n  lazySchema,\n  parseProviderOptions,\n  postJsonToApi,\n  resolve,\n  zodSchema,\n} from '@ai-sdk/provider-utils';\nimport { z } from 'zod/v4';\nimport { googleFailedResponseHandler } from './google-error';\nimport {\n  GoogleGenerativeAIEmbeddingModelId,\n  googleGenerativeAIEmbeddingProviderOptions,\n} from './google-generative-ai-embedding-options';\n\ntype GoogleGenerativeAIEmbeddingConfig = {\n  provider: string;\n  baseURL: string;\n  headers: () => Record<string, string | undefined>;\n  fetch?: FetchFunction;\n};\n\nexport class GoogleGenerativeAIEmbeddingModel implements EmbeddingModelV3 {\n  readonly specificationVersion = 'v3';\n  readonly modelId: GoogleGenerativeAIEmbeddingModelId;\n  readonly maxEmbeddingsPerCall = 2048;\n  readonly supportsParallelCalls = true;\n\n  private readonly config: GoogleGenerativeAIEmbeddingConfig;\n\n  get provider(): string {\n    return this.config.provider;\n  }\n  constructor(\n    modelId: GoogleGenerativeAIEmbeddingModelId,\n    config: GoogleGenerativeAIEmbeddingConfig,\n  ) {\n    this.modelId = modelId;\n    this.config = config;\n  }\n\n  async doEmbed({\n    values,\n    headers,\n    abortSignal,\n    providerOptions,\n  }: Parameters<EmbeddingModelV3['doEmbed']>[0]): Promise<\n    Awaited<ReturnType<EmbeddingModelV3['doEmbed']>>\n  > {\n    // Parse provider options\n    const googleOptions = await parseProviderOptions({\n      provider: 'google',\n      providerOptions,\n      schema: googleGenerativeAIEmbeddingProviderOptions,\n    });\n\n    if (values.length > this.maxEmbeddingsPerCall) {\n      throw new TooManyEmbeddingValuesForCallError({\n        provider: this.provider,\n        modelId: this.modelId,\n        maxEmbeddingsPerCall: this.maxEmbeddingsPerCall,\n        values,\n      });\n    }\n\n    const mergedHeaders = combineHeaders(\n      await resolve(this.config.headers),\n      headers,\n    );\n\n    // For single embeddings, use the single endpoint (ratelimits, etc.)\n    if (values.length === 1) {\n      const {\n        responseHeaders,\n        value: response,\n        rawValue,\n      } = await postJsonToApi({\n        url: `${this.config.baseURL}/models/${this.modelId}:embedContent`,\n        headers: mergedHeaders,\n        body: {\n          model: `models/${this.modelId}`,\n          content: {\n            parts: [{ text: values[0] }],\n          },\n          outputDimensionality: googleOptions?.outputDimensionality,\n          taskType: googleOptions?.taskType,\n        },\n        failedResponseHandler: googleFailedResponseHandler,\n        successfulResponseHandler: createJsonResponseHandler(\n          googleGenerativeAISingleEmbeddingResponseSchema,\n        ),\n        abortSignal,\n        fetch: this.config.fetch,\n      });\n\n      return {\n        warnings: [],\n        embeddings: [response.embedding.values],\n        usage: undefined,\n        response: { headers: responseHeaders, body: rawValue },\n      };\n    }\n\n    const {\n      responseHeaders,\n      value: response,\n      rawValue,\n    } = await postJsonToApi({\n      url: `${this.config.baseURL}/models/${this.modelId}:batchEmbedContents`,\n      headers: mergedHeaders,\n      body: {\n        requests: values.map(value => ({\n          model: `models/${this.modelId}`,\n          content: { role: 'user', parts: [{ text: value }] },\n          outputDimensionality: googleOptions?.outputDimensionality,\n          taskType: googleOptions?.taskType,\n        })),\n      },\n      failedResponseHandler: googleFailedResponseHandler,\n      successfulResponseHandler: createJsonResponseHandler(\n        googleGenerativeAITextEmbeddingResponseSchema,\n      ),\n      abortSignal,\n      fetch: this.config.fetch,\n    });\n\n    return {\n      warnings: [],\n      embeddings: response.embeddings.map(item => item.values),\n      usage: undefined,\n      response: { headers: responseHeaders, body: rawValue },\n    };\n  }\n}\n\n// minimal version of the schema, focussed on what is needed for the implementation\n// this approach limits breakages when the API changes and increases efficiency\nconst googleGenerativeAITextEmbeddingResponseSchema = lazySchema(() =>\n  zodSchema(\n    z.object({\n      embeddings: z.array(z.object({ values: z.array(z.number()) })),\n    }),\n  ),\n);\n\n// Schema for single embedding response\nconst googleGenerativeAISingleEmbeddingResponseSchema = lazySchema(() =>\n  zodSchema(\n    z.object({\n      embedding: z.object({ values: z.array(z.number()) }),\n    }),\n  ),\n);\n","import {\n  createJsonErrorResponseHandler,\n  type InferSchema,\n  lazySchema,\n  zodSchema,\n} from '@ai-sdk/provider-utils';\nimport { z } from 'zod/v4';\n\nconst googleErrorDataSchema = lazySchema(() =>\n  zodSchema(\n    z.object({\n      error: z.object({\n        code: z.number().nullable(),\n        message: z.string(),\n        status: z.string(),\n      }),\n    }),\n  ),\n);\n\nexport type GoogleErrorData = InferSchema<typeof googleErrorDataSchema>;\n\nexport const googleFailedResponseHandler = createJsonErrorResponseHandler({\n  errorSchema: googleErrorDataSchema,\n  errorToMessage: data => data.error.message,\n});\n","import {\n  type InferSchema,\n  lazySchema,\n  zodSchema,\n} from '@ai-sdk/provider-utils';\nimport { z } from 'zod/v4';\n\nexport type GoogleGenerativeAIEmbeddingModelId =\n  | 'gemini-embedding-001'\n  | 'text-embedding-004'\n  | (string & {});\n\nexport const googleGenerativeAIEmbeddingProviderOptions = lazySchema(() =>\n  zodSchema(\n    z.object({\n      /**\n       * Optional. Optional reduced dimension for the output embedding.\n       * If set, excessive values in the output embedding are truncated from the end.\n       */\n      outputDimensionality: z.number().optional(),\n\n      /**\n       * Optional. Specifies the task type for generating embeddings.\n       * Supported task types:\n       * - SEMANTIC_SIMILARITY: Optimized for text similarity.\n       * - CLASSIFICATION: Optimized for text classification.\n       * - CLUSTERING: Optimized for clustering texts based on similarity.\n       * - RETRIEVAL_DOCUMENT: Optimized for document retrieval.\n       * - RETRIEVAL_QUERY: Optimized for query-based retrieval.\n       * - QUESTION_ANSWERING: Optimized for answering questions.\n       * - FACT_VERIFICATION: Optimized for verifying factual information.\n       * - CODE_RETRIEVAL_QUERY: Optimized for retrieving code blocks based on natural language queries.\n       */\n      taskType: z\n        .enum([\n          'SEMANTIC_SIMILARITY',\n          'CLASSIFICATION',\n          'CLUSTERING',\n          'RETRIEVAL_DOCUMENT',\n          'RETRIEVAL_QUERY',\n          'QUESTION_ANSWERING',\n          'FACT_VERIFICATION',\n          'CODE_RETRIEVAL_QUERY',\n        ])\n        .optional(),\n    }),\n  ),\n);\n\nexport type GoogleGenerativeAIEmbeddingProviderOptions = InferSchema<\n  typeof googleGenerativeAIEmbeddingProviderOptions\n>;\n","import {\n  LanguageModelV3,\n  LanguageModelV3CallOptions,\n  LanguageModelV3Content,\n  LanguageModelV3FinishReason,\n  LanguageModelV3GenerateResult,\n  LanguageModelV3Source,\n  LanguageModelV3StreamPart,\n  LanguageModelV3StreamResult,\n  SharedV3ProviderMetadata,\n  SharedV3Warning,\n} from '@ai-sdk/provider';\nimport {\n  combineHeaders,\n  createEventSourceResponseHandler,\n  createJsonResponseHandler,\n  FetchFunction,\n  generateId,\n  InferSchema,\n  lazySchema,\n  parseProviderOptions,\n  ParseResult,\n  postJsonToApi,\n  Resolvable,\n  resolve,\n  zodSchema,\n} from '@ai-sdk/provider-utils';\nimport { z } from 'zod/v4';\nimport {\n  convertGoogleGenerativeAIUsage,\n  GoogleGenerativeAIUsageMetadata,\n} from './convert-google-generative-ai-usage';\nimport { convertJSONSchemaToOpenAPISchema } from './convert-json-schema-to-openapi-schema';\nimport { convertToGoogleGenerativeAIMessages } from './convert-to-google-generative-ai-messages';\nimport { getModelPath } from './get-model-path';\nimport { googleFailedResponseHandler } from './google-error';\nimport {\n  GoogleGenerativeAIModelId,\n  googleGenerativeAIProviderOptions,\n} from './google-generative-ai-options';\nimport { GoogleGenerativeAIContentPart } from './google-generative-ai-prompt';\nimport { prepareTools } from './google-prepare-tools';\nimport { mapGoogleGenerativeAIFinishReason } from './map-google-generative-ai-finish-reason';\n\ntype GoogleGenerativeAIConfig = {\n  provider: string;\n  baseURL: string;\n  headers: Resolvable<Record<string, string | undefined>>;\n  fetch?: FetchFunction;\n  generateId: () => string;\n\n  /**\n   * The supported URLs for the model.\n   */\n  supportedUrls?: () => LanguageModelV3['supportedUrls'];\n};\n\nexport class GoogleGenerativeAILanguageModel implements LanguageModelV3 {\n  readonly specificationVersion = 'v3';\n\n  readonly modelId: GoogleGenerativeAIModelId;\n\n  private readonly config: GoogleGenerativeAIConfig;\n  private readonly generateId: () => string;\n\n  constructor(\n    modelId: GoogleGenerativeAIModelId,\n    config: GoogleGenerativeAIConfig,\n  ) {\n    this.modelId = modelId;\n    this.config = config;\n    this.generateId = config.generateId ?? generateId;\n  }\n\n  get provider(): string {\n    return this.config.provider;\n  }\n\n  get supportedUrls() {\n    return this.config.supportedUrls?.() ?? {};\n  }\n\n  private async getArgs({\n    prompt,\n    maxOutputTokens,\n    temperature,\n    topP,\n    topK,\n    frequencyPenalty,\n    presencePenalty,\n    stopSequences,\n    responseFormat,\n    seed,\n    tools,\n    toolChoice,\n    providerOptions,\n  }: LanguageModelV3CallOptions) {\n    const warnings: SharedV3Warning[] = [];\n\n    const providerOptionsName = this.config.provider.includes('vertex')\n      ? 'vertex'\n      : 'google';\n    let googleOptions = await parseProviderOptions({\n      provider: providerOptionsName,\n      providerOptions,\n      schema: googleGenerativeAIProviderOptions,\n    });\n\n    if (googleOptions == null && providerOptionsName !== 'google') {\n      googleOptions = await parseProviderOptions({\n        provider: 'google',\n        providerOptions,\n        schema: googleGenerativeAIProviderOptions,\n      });\n    }\n\n    // Add warning if Vertex rag tools are used with a non-Vertex Google provider\n    if (\n      tools?.some(\n        tool =>\n          tool.type === 'provider' && tool.id === 'google.vertex_rag_store',\n      ) &&\n      !this.config.provider.startsWith('google.vertex.')\n    ) {\n      warnings.push({\n        type: 'other',\n        message:\n          \"The 'vertex_rag_store' tool is only supported with the Google Vertex provider \" +\n          'and might not be supported or could behave unexpectedly with the current Google provider ' +\n          `(${this.config.provider}).`,\n      });\n    }\n\n    const isGemmaModel = this.modelId.toLowerCase().startsWith('gemma-');\n\n    const { contents, systemInstruction } = convertToGoogleGenerativeAIMessages(\n      prompt,\n      { isGemmaModel, providerOptionsName },\n    );\n\n    const {\n      tools: googleTools,\n      toolConfig: googleToolConfig,\n      toolWarnings,\n    } = prepareTools({\n      tools,\n      toolChoice,\n      modelId: this.modelId,\n    });\n\n    return {\n      args: {\n        generationConfig: {\n          // standardized settings:\n          maxOutputTokens,\n          temperature,\n          topK,\n          topP,\n          frequencyPenalty,\n          presencePenalty,\n          stopSequences,\n          seed,\n\n          // response format:\n          responseMimeType:\n            responseFormat?.type === 'json' ? 'application/json' : undefined,\n          responseSchema:\n            responseFormat?.type === 'json' &&\n            responseFormat.schema != null &&\n            // Google GenAI does not support all OpenAPI Schema features,\n            // so this is needed as an escape hatch:\n            // TODO convert into provider option\n            (googleOptions?.structuredOutputs ?? true)\n              ? convertJSONSchemaToOpenAPISchema(responseFormat.schema)\n              : undefined,\n          ...(googleOptions?.audioTimestamp && {\n            audioTimestamp: googleOptions.audioTimestamp,\n          }),\n\n          // provider options:\n          responseModalities: googleOptions?.responseModalities,\n          thinkingConfig: googleOptions?.thinkingConfig,\n          ...(googleOptions?.mediaResolution && {\n            mediaResolution: googleOptions.mediaResolution,\n          }),\n          ...(googleOptions?.imageConfig && {\n            imageConfig: googleOptions.imageConfig,\n          }),\n        },\n        contents,\n        systemInstruction: isGemmaModel ? undefined : systemInstruction,\n        safetySettings: googleOptions?.safetySettings,\n        tools: googleTools,\n        toolConfig: googleOptions?.retrievalConfig\n          ? {\n              ...googleToolConfig,\n              retrievalConfig: googleOptions.retrievalConfig,\n            }\n          : googleToolConfig,\n        cachedContent: googleOptions?.cachedContent,\n        labels: googleOptions?.labels,\n      },\n      warnings: [...warnings, ...toolWarnings],\n      providerOptionsName,\n    };\n  }\n\n  async doGenerate(\n    options: LanguageModelV3CallOptions,\n  ): Promise<LanguageModelV3GenerateResult> {\n    const { args, warnings, providerOptionsName } = await this.getArgs(options);\n\n    const mergedHeaders = combineHeaders(\n      await resolve(this.config.headers),\n      options.headers,\n    );\n\n    const {\n      responseHeaders,\n      value: response,\n      rawValue: rawResponse,\n    } = await postJsonToApi({\n      url: `${this.config.baseURL}/${getModelPath(\n        this.modelId,\n      )}:generateContent`,\n      headers: mergedHeaders,\n      body: args,\n      failedResponseHandler: googleFailedResponseHandler,\n      successfulResponseHandler: createJsonResponseHandler(responseSchema),\n      abortSignal: options.abortSignal,\n      fetch: this.config.fetch,\n    });\n\n    const candidate = response.candidates[0];\n    const content: Array<LanguageModelV3Content> = [];\n\n    // map ordered parts to content:\n    const parts = candidate.content?.parts ?? [];\n\n    const usageMetadata = response.usageMetadata;\n\n    // Associates a code execution result with its preceding call.\n    let lastCodeExecutionToolCallId: string | undefined;\n\n    // Build content array from all parts\n    for (const part of parts) {\n      if ('executableCode' in part && part.executableCode?.code) {\n        const toolCallId = this.config.generateId();\n        lastCodeExecutionToolCallId = toolCallId;\n\n        content.push({\n          type: 'tool-call',\n          toolCallId,\n          toolName: 'code_execution',\n          input: JSON.stringify(part.executableCode),\n          providerExecuted: true,\n        });\n      } else if ('codeExecutionResult' in part && part.codeExecutionResult) {\n        content.push({\n          type: 'tool-result',\n          // Assumes a result directly follows its corresponding call part.\n          toolCallId: lastCodeExecutionToolCallId!,\n          toolName: 'code_execution',\n          result: {\n            outcome: part.codeExecutionResult.outcome,\n            output: part.codeExecutionResult.output,\n          },\n        });\n        // Clear the ID after use to avoid accidental reuse.\n        lastCodeExecutionToolCallId = undefined;\n      } else if ('text' in part && part.text != null && part.text.length > 0) {\n        content.push({\n          type: part.thought === true ? 'reasoning' : 'text',\n          text: part.text,\n          providerMetadata: part.thoughtSignature\n            ? {\n                [providerOptionsName]: {\n                  thoughtSignature: part.thoughtSignature,\n                },\n              }\n            : undefined,\n        });\n      } else if ('functionCall' in part) {\n        content.push({\n          type: 'tool-call' as const,\n          toolCallId: this.config.generateId(),\n          toolName: part.functionCall.name,\n          input: JSON.stringify(part.functionCall.args),\n          providerMetadata: part.thoughtSignature\n            ? {\n                [providerOptionsName]: {\n                  thoughtSignature: part.thoughtSignature,\n                },\n              }\n            : undefined,\n        });\n      } else if ('inlineData' in part) {\n        content.push({\n          type: 'file' as const,\n          data: part.inlineData.data,\n          mediaType: part.inlineData.mimeType,\n          providerMetadata: part.thoughtSignature\n            ? {\n                [providerOptionsName]: {\n                  thoughtSignature: part.thoughtSignature,\n                },\n              }\n            : undefined,\n        });\n      }\n    }\n\n    const sources =\n      extractSources({\n        groundingMetadata: candidate.groundingMetadata,\n        generateId: this.config.generateId,\n      }) ?? [];\n    for (const source of sources) {\n      content.push(source);\n    }\n\n    return {\n      content,\n      finishReason: {\n        unified: mapGoogleGenerativeAIFinishReason({\n          finishReason: candidate.finishReason,\n          hasToolCalls: content.some(part => part.type === 'tool-call'),\n        }),\n        raw: candidate.finishReason ?? undefined,\n      },\n      usage: convertGoogleGenerativeAIUsage(usageMetadata),\n      warnings,\n      providerMetadata: {\n        [providerOptionsName]: {\n          promptFeedback: response.promptFeedback ?? null,\n          groundingMetadata: candidate.groundingMetadata ?? null,\n          urlContextMetadata: candidate.urlContextMetadata ?? null,\n          safetyRatings: candidate.safetyRatings ?? null,\n          usageMetadata: usageMetadata ?? null,\n        },\n      },\n      request: { body: args },\n      response: {\n        // TODO timestamp, model id, id\n        headers: responseHeaders,\n        body: rawResponse,\n      },\n    };\n  }\n\n  async doStream(\n    options: LanguageModelV3CallOptions,\n  ): Promise<LanguageModelV3StreamResult> {\n    const { args, warnings, providerOptionsName } = await this.getArgs(options);\n\n    const headers = combineHeaders(\n      await resolve(this.config.headers),\n      options.headers,\n    );\n\n    const { responseHeaders, value: response } = await postJsonToApi({\n      url: `${this.config.baseURL}/${getModelPath(\n        this.modelId,\n      )}:streamGenerateContent?alt=sse`,\n      headers,\n      body: args,\n      failedResponseHandler: googleFailedResponseHandler,\n      successfulResponseHandler: createEventSourceResponseHandler(chunkSchema),\n      abortSignal: options.abortSignal,\n      fetch: this.config.fetch,\n    });\n\n    let finishReason: LanguageModelV3FinishReason = {\n      unified: 'other',\n      raw: undefined,\n    };\n    let usage: GoogleGenerativeAIUsageMetadata | undefined = undefined;\n    let providerMetadata: SharedV3ProviderMetadata | undefined = undefined;\n\n    const generateId = this.config.generateId;\n    let hasToolCalls = false;\n\n    // Track active blocks to group consecutive parts of same type\n    let currentTextBlockId: string | null = null;\n    let currentReasoningBlockId: string | null = null;\n    let blockCounter = 0;\n\n    // Track emitted sources to prevent duplicates\n    const emittedSourceUrls = new Set<string>();\n    // Associates a code execution result with its preceding call.\n    let lastCodeExecutionToolCallId: string | undefined;\n\n    return {\n      stream: response.pipeThrough(\n        new TransformStream<\n          ParseResult<ChunkSchema>,\n          LanguageModelV3StreamPart\n        >({\n          start(controller) {\n            controller.enqueue({ type: 'stream-start', warnings });\n          },\n\n          transform(chunk, controller) {\n            if (options.includeRawChunks) {\n              controller.enqueue({ type: 'raw', rawValue: chunk.rawValue });\n            }\n\n            if (!chunk.success) {\n              controller.enqueue({ type: 'error', error: chunk.error });\n              return;\n            }\n\n            const value = chunk.value;\n\n            const usageMetadata = value.usageMetadata;\n\n            if (usageMetadata != null) {\n              usage = usageMetadata;\n            }\n\n            const candidate = value.candidates?.[0];\n\n            // sometimes the API returns an empty candidates array\n            if (candidate == null) {\n              return;\n            }\n\n            const content = candidate.content;\n\n            const sources = extractSources({\n              groundingMetadata: candidate.groundingMetadata,\n              generateId,\n            });\n            if (sources != null) {\n              for (const source of sources) {\n                if (\n                  source.sourceType === 'url' &&\n                  !emittedSourceUrls.has(source.url)\n                ) {\n                  emittedSourceUrls.add(source.url);\n                  controller.enqueue(source);\n                }\n              }\n            }\n\n            // Process tool call's parts before determining finishReason to ensure hasToolCalls is properly set\n            if (content != null) {\n              // Process all parts in a single loop to preserve original order\n              const parts = content.parts ?? [];\n              for (const part of parts) {\n                if ('executableCode' in part && part.executableCode?.code) {\n                  const toolCallId = generateId();\n                  lastCodeExecutionToolCallId = toolCallId;\n\n                  controller.enqueue({\n                    type: 'tool-call',\n                    toolCallId,\n                    toolName: 'code_execution',\n                    input: JSON.stringify(part.executableCode),\n                    providerExecuted: true,\n                  });\n\n                  hasToolCalls = true;\n                } else if (\n                  'codeExecutionResult' in part &&\n                  part.codeExecutionResult\n                ) {\n                  // Assumes a result directly follows its corresponding call part.\n                  const toolCallId = lastCodeExecutionToolCallId;\n\n                  if (toolCallId) {\n                    controller.enqueue({\n                      type: 'tool-result',\n                      toolCallId,\n                      toolName: 'code_execution',\n                      result: {\n                        outcome: part.codeExecutionResult.outcome,\n                        output: part.codeExecutionResult.output,\n                      },\n                    });\n                    // Clear the ID after use.\n                    lastCodeExecutionToolCallId = undefined;\n                  }\n                } else if (\n                  'text' in part &&\n                  part.text != null &&\n                  part.text.length > 0\n                ) {\n                  if (part.thought === true) {\n                    // End any active text block before starting reasoning\n                    if (currentTextBlockId !== null) {\n                      controller.enqueue({\n                        type: 'text-end',\n                        id: currentTextBlockId,\n                      });\n                      currentTextBlockId = null;\n                    }\n\n                    // Start new reasoning block if not already active\n                    if (currentReasoningBlockId === null) {\n                      currentReasoningBlockId = String(blockCounter++);\n                      controller.enqueue({\n                        type: 'reasoning-start',\n                        id: currentReasoningBlockId,\n                        providerMetadata: part.thoughtSignature\n                          ? {\n                              [providerOptionsName]: {\n                                thoughtSignature: part.thoughtSignature,\n                              },\n                            }\n                          : undefined,\n                      });\n                    }\n\n                    controller.enqueue({\n                      type: 'reasoning-delta',\n                      id: currentReasoningBlockId,\n                      delta: part.text,\n                      providerMetadata: part.thoughtSignature\n                        ? {\n                            [providerOptionsName]: {\n                              thoughtSignature: part.thoughtSignature,\n                            },\n                          }\n                        : undefined,\n                    });\n                  } else {\n                    // End any active reasoning block before starting text\n                    if (currentReasoningBlockId !== null) {\n                      controller.enqueue({\n                        type: 'reasoning-end',\n                        id: currentReasoningBlockId,\n                      });\n                      currentReasoningBlockId = null;\n                    }\n\n                    // Start new text block if not already active\n                    if (currentTextBlockId === null) {\n                      currentTextBlockId = String(blockCounter++);\n                      controller.enqueue({\n                        type: 'text-start',\n                        id: currentTextBlockId,\n                        providerMetadata: part.thoughtSignature\n                          ? {\n                              [providerOptionsName]: {\n                                thoughtSignature: part.thoughtSignature,\n                              },\n                            }\n                          : undefined,\n                      });\n                    }\n\n                    controller.enqueue({\n                      type: 'text-delta',\n                      id: currentTextBlockId,\n                      delta: part.text,\n                      providerMetadata: part.thoughtSignature\n                        ? {\n                            [providerOptionsName]: {\n                              thoughtSignature: part.thoughtSignature,\n                            },\n                          }\n                        : undefined,\n                    });\n                  }\n                } else if ('inlineData' in part) {\n                  // Process file parts inline to preserve order with text\n                  controller.enqueue({\n                    type: 'file',\n                    mediaType: part.inlineData.mimeType,\n                    data: part.inlineData.data,\n                  });\n                }\n              }\n\n              const toolCallDeltas = getToolCallsFromParts({\n                parts: content.parts,\n                generateId,\n                providerOptionsName,\n              });\n\n              if (toolCallDeltas != null) {\n                for (const toolCall of toolCallDeltas) {\n                  controller.enqueue({\n                    type: 'tool-input-start',\n                    id: toolCall.toolCallId,\n                    toolName: toolCall.toolName,\n                    providerMetadata: toolCall.providerMetadata,\n                  });\n\n                  controller.enqueue({\n                    type: 'tool-input-delta',\n                    id: toolCall.toolCallId,\n                    delta: toolCall.args,\n                    providerMetadata: toolCall.providerMetadata,\n                  });\n\n                  controller.enqueue({\n                    type: 'tool-input-end',\n                    id: toolCall.toolCallId,\n                    providerMetadata: toolCall.providerMetadata,\n                  });\n\n                  controller.enqueue({\n                    type: 'tool-call',\n                    toolCallId: toolCall.toolCallId,\n                    toolName: toolCall.toolName,\n                    input: toolCall.args,\n                    providerMetadata: toolCall.providerMetadata,\n                  });\n\n                  hasToolCalls = true;\n                }\n              }\n            }\n\n            if (candidate.finishReason != null) {\n              finishReason = {\n                unified: mapGoogleGenerativeAIFinishReason({\n                  finishReason: candidate.finishReason,\n                  hasToolCalls,\n                }),\n                raw: candidate.finishReason,\n              };\n\n              providerMetadata = {\n                [providerOptionsName]: {\n                  promptFeedback: value.promptFeedback ?? null,\n                  groundingMetadata: candidate.groundingMetadata ?? null,\n                  urlContextMetadata: candidate.urlContextMetadata ?? null,\n                  safetyRatings: candidate.safetyRatings ?? null,\n                },\n              };\n              if (usageMetadata != null) {\n                (\n                  providerMetadata[providerOptionsName] as Record<\n                    string,\n                    unknown\n                  >\n                ).usageMetadata = usageMetadata;\n              }\n            }\n          },\n\n          flush(controller) {\n            // Close any open blocks before finishing\n            if (currentTextBlockId !== null) {\n              controller.enqueue({\n                type: 'text-end',\n                id: currentTextBlockId,\n              });\n            }\n            if (currentReasoningBlockId !== null) {\n              controller.enqueue({\n                type: 'reasoning-end',\n                id: currentReasoningBlockId,\n              });\n            }\n\n            controller.enqueue({\n              type: 'finish',\n              finishReason,\n              usage: convertGoogleGenerativeAIUsage(usage),\n              providerMetadata,\n            });\n          },\n        }),\n      ),\n      response: { headers: responseHeaders },\n      request: { body: args },\n    };\n  }\n}\n\nfunction getToolCallsFromParts({\n  parts,\n  generateId,\n  providerOptionsName,\n}: {\n  parts: ContentSchema['parts'];\n  generateId: () => string;\n  providerOptionsName: string;\n}) {\n  const functionCallParts = parts?.filter(\n    part => 'functionCall' in part,\n  ) as Array<\n    GoogleGenerativeAIContentPart & {\n      functionCall: { name: string; args: unknown };\n      thoughtSignature?: string | null;\n    }\n  >;\n\n  return functionCallParts == null || functionCallParts.length === 0\n    ? undefined\n    : functionCallParts.map(part => ({\n        type: 'tool-call' as const,\n        toolCallId: generateId(),\n        toolName: part.functionCall.name,\n        args: JSON.stringify(part.functionCall.args),\n        providerMetadata: part.thoughtSignature\n          ? {\n              [providerOptionsName]: {\n                thoughtSignature: part.thoughtSignature,\n              },\n            }\n          : undefined,\n      }));\n}\n\nfunction extractSources({\n  groundingMetadata,\n  generateId,\n}: {\n  groundingMetadata: GroundingMetadataSchema | undefined | null;\n  generateId: () => string;\n}): undefined | LanguageModelV3Source[] {\n  if (!groundingMetadata?.groundingChunks) {\n    return undefined;\n  }\n\n  const sources: LanguageModelV3Source[] = [];\n\n  for (const chunk of groundingMetadata.groundingChunks) {\n    if (chunk.web != null) {\n      // Handle web chunks as URL sources\n      sources.push({\n        type: 'source',\n        sourceType: 'url',\n        id: generateId(),\n        url: chunk.web.uri,\n        title: chunk.web.title ?? undefined,\n      });\n    } else if (chunk.retrievedContext != null) {\n      // Handle retrievedContext chunks from RAG operations\n      const uri = chunk.retrievedContext.uri;\n      const fileSearchStore = chunk.retrievedContext.fileSearchStore;\n\n      if (uri && (uri.startsWith('http://') || uri.startsWith('https://'))) {\n        // Old format: Google Search with HTTP/HTTPS URL\n        sources.push({\n          type: 'source',\n          sourceType: 'url',\n          id: generateId(),\n          url: uri,\n          title: chunk.retrievedContext.title ?? undefined,\n        });\n      } else if (uri) {\n        // Old format: Document with file path (gs://, etc.)\n        const title = chunk.retrievedContext.title ?? 'Unknown Document';\n        let mediaType = 'application/octet-stream';\n        let filename: string | undefined = undefined;\n\n        if (uri.endsWith('.pdf')) {\n          mediaType = 'application/pdf';\n          filename = uri.split('/').pop();\n        } else if (uri.endsWith('.txt')) {\n          mediaType = 'text/plain';\n          filename = uri.split('/').pop();\n        } else if (uri.endsWith('.docx')) {\n          mediaType =\n            'application/vnd.openxmlformats-officedocument.wordprocessingml.document';\n          filename = uri.split('/').pop();\n        } else if (uri.endsWith('.doc')) {\n          mediaType = 'application/msword';\n          filename = uri.split('/').pop();\n        } else if (uri.match(/\\.(md|markdown)$/)) {\n          mediaType = 'text/markdown';\n          filename = uri.split('/').pop();\n        } else {\n          filename = uri.split('/').pop();\n        }\n\n        sources.push({\n          type: 'source',\n          sourceType: 'document',\n          id: generateId(),\n          mediaType,\n          title,\n          filename,\n        });\n      } else if (fileSearchStore) {\n        // New format: File Search with fileSearchStore (no uri)\n        const title = chunk.retrievedContext.title ?? 'Unknown Document';\n        sources.push({\n          type: 'source',\n          sourceType: 'document',\n          id: generateId(),\n          mediaType: 'application/octet-stream',\n          title,\n          filename: fileSearchStore.split('/').pop(),\n        });\n      }\n    } else if (chunk.maps != null) {\n      if (chunk.maps.uri) {\n        sources.push({\n          type: 'source',\n          sourceType: 'url',\n          id: generateId(),\n          url: chunk.maps.uri,\n          title: chunk.maps.title ?? undefined,\n        });\n      }\n    }\n  }\n\n  return sources.length > 0 ? sources : undefined;\n}\n\nexport const getGroundingMetadataSchema = () =>\n  z.object({\n    webSearchQueries: z.array(z.string()).nullish(),\n    retrievalQueries: z.array(z.string()).nullish(),\n    searchEntryPoint: z.object({ renderedContent: z.string() }).nullish(),\n    groundingChunks: z\n      .array(\n        z.object({\n          web: z\n            .object({ uri: z.string(), title: z.string().nullish() })\n            .nullish(),\n          retrievedContext: z\n            .object({\n              uri: z.string().nullish(),\n              title: z.string().nullish(),\n              text: z.string().nullish(),\n              fileSearchStore: z.string().nullish(),\n            })\n            .nullish(),\n          maps: z\n            .object({\n              uri: z.string().nullish(),\n              title: z.string().nullish(),\n              text: z.string().nullish(),\n              placeId: z.string().nullish(),\n            })\n            .nullish(),\n        }),\n      )\n      .nullish(),\n    groundingSupports: z\n      .array(\n        z.object({\n          segment: z.object({\n            startIndex: z.number().nullish(),\n            endIndex: z.number().nullish(),\n            text: z.string().nullish(),\n          }),\n          segment_text: z.string().nullish(),\n          groundingChunkIndices: z.array(z.number()).nullish(),\n          supportChunkIndices: z.array(z.number()).nullish(),\n          confidenceScores: z.array(z.number()).nullish(),\n          confidenceScore: z.array(z.number()).nullish(),\n        }),\n      )\n      .nullish(),\n    retrievalMetadata: z\n      .union([\n        z.object({\n          webDynamicRetrievalScore: z.number(),\n        }),\n        z.object({}),\n      ])\n      .nullish(),\n  });\n\nconst getContentSchema = () =>\n  z.object({\n    parts: z\n      .array(\n        z.union([\n          // note: order matters since text can be fully empty\n          z.object({\n            functionCall: z.object({\n              name: z.string(),\n              args: z.unknown(),\n            }),\n            thoughtSignature: z.string().nullish(),\n          }),\n          z.object({\n            inlineData: z.object({\n              mimeType: z.string(),\n              data: z.string(),\n            }),\n            thoughtSignature: z.string().nullish(),\n          }),\n          z.object({\n            executableCode: z\n              .object({\n                language: z.string(),\n                code: z.string(),\n              })\n              .nullish(),\n            codeExecutionResult: z\n              .object({\n                outcome: z.string(),\n                output: z.string(),\n              })\n              .nullish(),\n            text: z.string().nullish(),\n            thought: z.boolean().nullish(),\n            thoughtSignature: z.string().nullish(),\n          }),\n        ]),\n      )\n      .nullish(),\n  });\n\n// https://cloud.google.com/vertex-ai/generative-ai/docs/multimodal/configure-safety-filters\nconst getSafetyRatingSchema = () =>\n  z.object({\n    category: z.string().nullish(),\n    probability: z.string().nullish(),\n    probabilityScore: z.number().nullish(),\n    severity: z.string().nullish(),\n    severityScore: z.number().nullish(),\n    blocked: z.boolean().nullish(),\n  });\n\nconst usageSchema = z.object({\n  cachedContentTokenCount: z.number().nullish(),\n  thoughtsTokenCount: z.number().nullish(),\n  promptTokenCount: z.number().nullish(),\n  candidatesTokenCount: z.number().nullish(),\n  totalTokenCount: z.number().nullish(),\n  // https://cloud.google.com/vertex-ai/generative-ai/docs/reference/rest/v1/GenerateContentResponse#TrafficType\n  trafficType: z.string().nullish(),\n});\n\n// https://ai.google.dev/api/generate-content#UrlRetrievalMetadata\nexport const getUrlContextMetadataSchema = () =>\n  z.object({\n    urlMetadata: z.array(\n      z.object({\n        retrievedUrl: z.string(),\n        urlRetrievalStatus: z.string(),\n      }),\n    ),\n  });\n\nconst responseSchema = lazySchema(() =>\n  zodSchema(\n    z.object({\n      candidates: z.array(\n        z.object({\n          content: getContentSchema().nullish().or(z.object({}).strict()),\n          finishReason: z.string().nullish(),\n          safetyRatings: z.array(getSafetyRatingSchema()).nullish(),\n          groundingMetadata: getGroundingMetadataSchema().nullish(),\n          urlContextMetadata: getUrlContextMetadataSchema().nullish(),\n        }),\n      ),\n      usageMetadata: usageSchema.nullish(),\n      promptFeedback: z\n        .object({\n          blockReason: z.string().nullish(),\n          safetyRatings: z.array(getSafetyRatingSchema()).nullish(),\n        })\n        .nullish(),\n    }),\n  ),\n);\n\ntype ContentSchema = NonNullable<\n  InferSchema<typeof responseSchema>['candidates'][number]['content']\n>;\nexport type GroundingMetadataSchema = NonNullable<\n  InferSchema<typeof responseSchema>['candidates'][number]['groundingMetadata']\n>;\n\ntype GroundingChunkSchema = NonNullable<\n  GroundingMetadataSchema['groundingChunks']\n>[number];\n\nexport type UrlContextMetadataSchema = NonNullable<\n  InferSchema<typeof responseSchema>['candidates'][number]['urlContextMetadata']\n>;\n\nexport type SafetyRatingSchema = NonNullable<\n  InferSchema<typeof responseSchema>['candidates'][number]['safetyRatings']\n>[number];\n\n// limited version of the schema, focussed on what is needed for the implementation\n// this approach limits breakages when the API changes and increases efficiency\nconst chunkSchema = lazySchema(() =>\n  zodSchema(\n    z.object({\n      candidates: z\n        .array(\n          z.object({\n            content: getContentSchema().nullish(),\n            finishReason: z.string().nullish(),\n            safetyRatings: z.array(getSafetyRatingSchema()).nullish(),\n            groundingMetadata: getGroundingMetadataSchema().nullish(),\n            urlContextMetadata: getUrlContextMetadataSchema().nullish(),\n          }),\n        )\n        .nullish(),\n      usageMetadata: usageSchema.nullish(),\n      promptFeedback: z\n        .object({\n          blockReason: z.string().nullish(),\n          safetyRatings: z.array(getSafetyRatingSchema()).nullish(),\n        })\n        .nullish(),\n    }),\n  ),\n);\n\ntype ChunkSchema = InferSchema<typeof chunkSchema>;\n","import { LanguageModelV3Usage } from '@ai-sdk/provider';\n\nexport type GoogleGenerativeAIUsageMetadata = {\n  promptTokenCount?: number | null;\n  candidatesTokenCount?: number | null;\n  totalTokenCount?: number | null;\n  cachedContentTokenCount?: number | null;\n  thoughtsTokenCount?: number | null;\n  trafficType?: string | null;\n};\n\nexport function convertGoogleGenerativeAIUsage(\n  usage: GoogleGenerativeAIUsageMetadata | undefined | null,\n): LanguageModelV3Usage {\n  if (usage == null) {\n    return {\n      inputTokens: {\n        total: undefined,\n        noCache: undefined,\n        cacheRead: undefined,\n        cacheWrite: undefined,\n      },\n      outputTokens: {\n        total: undefined,\n        text: undefined,\n        reasoning: undefined,\n      },\n      raw: undefined,\n    };\n  }\n\n  const promptTokens = usage.promptTokenCount ?? 0;\n  const candidatesTokens = usage.candidatesTokenCount ?? 0;\n  const cachedContentTokens = usage.cachedContentTokenCount ?? 0;\n  const thoughtsTokens = usage.thoughtsTokenCount ?? 0;\n\n  return {\n    inputTokens: {\n      total: promptTokens,\n      noCache: promptTokens - cachedContentTokens,\n      cacheRead: cachedContentTokens,\n      cacheWrite: undefined,\n    },\n    outputTokens: {\n      total: candidatesTokens + thoughtsTokens,\n      text: candidatesTokens,\n      reasoning: thoughtsTokens,\n    },\n    raw: usage,\n  };\n}\n","import { JSONSchema7Definition } from '@ai-sdk/provider';\n\n/**\n * Converts JSON Schema 7 to OpenAPI Schema 3.0\n */\nexport function convertJSONSchemaToOpenAPISchema(\n  jsonSchema: JSONSchema7Definition | undefined,\n  isRoot = true,\n): unknown {\n  // Handle empty object schemas: undefined at root, preserved when nested\n  if (jsonSchema == null) {\n    return undefined;\n  }\n\n  if (isEmptyObjectSchema(jsonSchema)) {\n    if (isRoot) {\n      return undefined;\n    }\n\n    if (typeof jsonSchema === 'object' && jsonSchema.description) {\n      return { type: 'object', description: jsonSchema.description };\n    }\n    return { type: 'object' };\n  }\n\n  if (typeof jsonSchema === 'boolean') {\n    return { type: 'boolean', properties: {} };\n  }\n\n  const {\n    type,\n    description,\n    required,\n    properties,\n    items,\n    allOf,\n    anyOf,\n    oneOf,\n    format,\n    const: constValue,\n    minLength,\n    enum: enumValues,\n  } = jsonSchema;\n\n  const result: Record<string, unknown> = {};\n\n  if (description) result.description = description;\n  if (required) result.required = required;\n  if (format) result.format = format;\n\n  if (constValue !== undefined) {\n    result.enum = [constValue];\n  }\n\n  // Handle type\n  if (type) {\n    if (Array.isArray(type)) {\n      const hasNull = type.includes('null');\n      const nonNullTypes = type.filter(t => t !== 'null');\n\n      if (nonNullTypes.length === 0) {\n        // Only null type\n        result.type = 'null';\n      } else {\n        // One or more non-null types: always use anyOf\n        result.anyOf = nonNullTypes.map(t => ({ type: t }));\n        if (hasNull) {\n          result.nullable = true;\n        }\n      }\n    } else {\n      result.type = type;\n    }\n  }\n\n  // Handle enum\n  if (enumValues !== undefined) {\n    result.enum = enumValues;\n  }\n\n  if (properties != null) {\n    result.properties = Object.entries(properties).reduce(\n      (acc, [key, value]) => {\n        acc[key] = convertJSONSchemaToOpenAPISchema(value, false);\n        return acc;\n      },\n      {} as Record<string, unknown>,\n    );\n  }\n\n  if (items) {\n    result.items = Array.isArray(items)\n      ? items.map(item => convertJSONSchemaToOpenAPISchema(item, false))\n      : convertJSONSchemaToOpenAPISchema(items, false);\n  }\n\n  if (allOf) {\n    result.allOf = allOf.map(item =>\n      convertJSONSchemaToOpenAPISchema(item, false),\n    );\n  }\n  if (anyOf) {\n    // Handle cases where anyOf includes a null type\n    if (\n      anyOf.some(\n        schema => typeof schema === 'object' && schema?.type === 'null',\n      )\n    ) {\n      const nonNullSchemas = anyOf.filter(\n        schema => !(typeof schema === 'object' && schema?.type === 'null'),\n      );\n\n      if (nonNullSchemas.length === 1) {\n        // If there's only one non-null schema, convert it and make it nullable\n        const converted = convertJSONSchemaToOpenAPISchema(\n          nonNullSchemas[0],\n          false,\n        );\n        if (typeof converted === 'object') {\n          result.nullable = true;\n          Object.assign(result, converted);\n        }\n      } else {\n        // If there are multiple non-null schemas, keep them in anyOf\n        result.anyOf = nonNullSchemas.map(item =>\n          convertJSONSchemaToOpenAPISchema(item, false),\n        );\n        result.nullable = true;\n      }\n    } else {\n      result.anyOf = anyOf.map(item =>\n        convertJSONSchemaToOpenAPISchema(item, false),\n      );\n    }\n  }\n  if (oneOf) {\n    result.oneOf = oneOf.map(item =>\n      convertJSONSchemaToOpenAPISchema(item, false),\n    );\n  }\n\n  if (minLength !== undefined) {\n    result.minLength = minLength;\n  }\n\n  return result;\n}\n\nfunction isEmptyObjectSchema(jsonSchema: JSONSchema7Definition): boolean {\n  return (\n    jsonSchema != null &&\n    typeof jsonSchema === 'object' &&\n    jsonSchema.type === 'object' &&\n    (jsonSchema.properties == null ||\n      Object.keys(jsonSchema.properties).length === 0) &&\n    !jsonSchema.additionalProperties\n  );\n}\n","import {\n  LanguageModelV3Prompt,\n  UnsupportedFunctionalityError,\n} from '@ai-sdk/provider';\nimport {\n  GoogleGenerativeAIContent,\n  GoogleGenerativeAIContentPart,\n  GoogleGenerativeAIPrompt,\n} from './google-generative-ai-prompt';\nimport { convertToBase64 } from '@ai-sdk/provider-utils';\n\nexport function convertToGoogleGenerativeAIMessages(\n  prompt: LanguageModelV3Prompt,\n  options?: { isGemmaModel?: boolean; providerOptionsName?: string },\n): GoogleGenerativeAIPrompt {\n  const systemInstructionParts: Array<{ text: string }> = [];\n  const contents: Array<GoogleGenerativeAIContent> = [];\n  let systemMessagesAllowed = true;\n  const isGemmaModel = options?.isGemmaModel ?? false;\n  const providerOptionsName = options?.providerOptionsName ?? 'google';\n\n  for (const { role, content } of prompt) {\n    switch (role) {\n      case 'system': {\n        if (!systemMessagesAllowed) {\n          throw new UnsupportedFunctionalityError({\n            functionality:\n              'system messages are only supported at the beginning of the conversation',\n          });\n        }\n\n        systemInstructionParts.push({ text: content });\n        break;\n      }\n\n      case 'user': {\n        systemMessagesAllowed = false;\n\n        const parts: GoogleGenerativeAIContentPart[] = [];\n\n        for (const part of content) {\n          switch (part.type) {\n            case 'text': {\n              parts.push({ text: part.text });\n              break;\n            }\n\n            case 'file': {\n              // default to image/jpeg for unknown image/* types\n              const mediaType =\n                part.mediaType === 'image/*' ? 'image/jpeg' : part.mediaType;\n\n              parts.push(\n                part.data instanceof URL\n                  ? {\n                      fileData: {\n                        mimeType: mediaType,\n                        fileUri: part.data.toString(),\n                      },\n                    }\n                  : {\n                      inlineData: {\n                        mimeType: mediaType,\n                        data: convertToBase64(part.data),\n                      },\n                    },\n              );\n\n              break;\n            }\n          }\n        }\n\n        contents.push({ role: 'user', parts });\n        break;\n      }\n\n      case 'assistant': {\n        systemMessagesAllowed = false;\n\n        contents.push({\n          role: 'model',\n          parts: content\n            .map(part => {\n              const providerOpts = part.providerOptions?.[providerOptionsName];\n              const thoughtSignature =\n                providerOpts?.thoughtSignature != null\n                  ? String(providerOpts.thoughtSignature)\n                  : undefined;\n\n              switch (part.type) {\n                case 'text': {\n                  return part.text.length === 0\n                    ? undefined\n                    : {\n                        text: part.text,\n                        thoughtSignature,\n                      };\n                }\n\n                case 'reasoning': {\n                  return part.text.length === 0\n                    ? undefined\n                    : {\n                        text: part.text,\n                        thought: true,\n                        thoughtSignature,\n                      };\n                }\n\n                case 'file': {\n                  if (part.data instanceof URL) {\n                    throw new UnsupportedFunctionalityError({\n                      functionality:\n                        'File data URLs in assistant messages are not supported',\n                    });\n                  }\n\n                  return {\n                    inlineData: {\n                      mimeType: part.mediaType,\n                      data: convertToBase64(part.data),\n                    },\n                    thoughtSignature,\n                  };\n                }\n\n                case 'tool-call': {\n                  return {\n                    functionCall: {\n                      name: part.toolName,\n                      args: part.input,\n                    },\n                    thoughtSignature,\n                  };\n                }\n              }\n            })\n            .filter(part => part !== undefined),\n        });\n        break;\n      }\n\n      case 'tool': {\n        systemMessagesAllowed = false;\n\n        const parts: GoogleGenerativeAIContentPart[] = [];\n\n        for (const part of content) {\n          if (part.type === 'tool-approval-response') {\n            continue;\n          }\n          const output = part.output;\n\n          if (output.type === 'content') {\n            for (const contentPart of output.value) {\n              switch (contentPart.type) {\n                case 'text':\n                  parts.push({\n                    functionResponse: {\n                      name: part.toolName,\n                      response: {\n                        name: part.toolName,\n                        content: contentPart.text,\n                      },\n                    },\n                  });\n                  break;\n                case 'image-data':\n                  parts.push(\n                    {\n                      inlineData: {\n                        mimeType: contentPart.mediaType,\n                        data: contentPart.data,\n                      },\n                    },\n                    {\n                      text: 'Tool executed successfully and returned this image as a response',\n                    },\n                  );\n                  break;\n                default:\n                  parts.push({ text: JSON.stringify(contentPart) });\n                  break;\n              }\n            }\n          } else {\n            parts.push({\n              functionResponse: {\n                name: part.toolName,\n                response: {\n                  name: part.toolName,\n                  content:\n                    output.type === 'execution-denied'\n                      ? (output.reason ?? 'Tool execution denied.')\n                      : output.value,\n                },\n              },\n            });\n          }\n        }\n\n        contents.push({\n          role: 'user',\n          parts,\n        });\n        break;\n      }\n    }\n  }\n\n  if (\n    isGemmaModel &&\n    systemInstructionParts.length > 0 &&\n    contents.length > 0 &&\n    contents[0].role === 'user'\n  ) {\n    const systemText = systemInstructionParts\n      .map(part => part.text)\n      .join('\\n\\n');\n\n    contents[0].parts.unshift({ text: systemText + '\\n\\n' });\n  }\n\n  return {\n    systemInstruction:\n      systemInstructionParts.length > 0 && !isGemmaModel\n        ? { parts: systemInstructionParts }\n        : undefined,\n    contents,\n  };\n}\n","export function getModelPath(modelId: string): string {\n  return modelId.includes('/') ? modelId : `models/${modelId}`;\n}\n","import { InferSchema, lazySchema, zodSchema } from '@ai-sdk/provider-utils';\nimport { z } from 'zod/v4';\n\nexport type GoogleGenerativeAIModelId =\n  // Stable models\n  // https://ai.google.dev/gemini-api/docs/models/gemini\n  | 'gemini-1.5-flash'\n  | 'gemini-1.5-flash-latest'\n  | 'gemini-1.5-flash-001'\n  | 'gemini-1.5-flash-002'\n  | 'gemini-1.5-flash-8b'\n  | 'gemini-1.5-flash-8b-latest'\n  | 'gemini-1.5-flash-8b-001'\n  | 'gemini-1.5-pro'\n  | 'gemini-1.5-pro-latest'\n  | 'gemini-1.5-pro-001'\n  | 'gemini-1.5-pro-002'\n  | 'gemini-2.0-flash'\n  | 'gemini-2.0-flash-001'\n  | 'gemini-2.0-flash-live-001'\n  | 'gemini-2.0-flash-lite'\n  | 'gemini-2.0-pro-exp-02-05'\n  | 'gemini-2.0-flash-thinking-exp-01-21'\n  | 'gemini-2.0-flash-exp'\n  | 'gemini-2.5-pro'\n  | 'gemini-2.5-flash'\n  | 'gemini-2.5-flash-image-preview'\n  | 'gemini-2.5-flash-lite'\n  | 'gemini-2.5-flash-lite-preview-09-2025'\n  | 'gemini-2.5-flash-preview-04-17'\n  | 'gemini-2.5-flash-preview-09-2025'\n  | 'gemini-3-pro-preview'\n  | 'gemini-3-pro-image-preview'\n  | 'gemini-3-flash-preview'\n  // latest version\n  // https://ai.google.dev/gemini-api/docs/models#latest\n  | 'gemini-pro-latest'\n  | 'gemini-flash-latest'\n  | 'gemini-flash-lite-latest'\n  // Experimental models\n  // https://ai.google.dev/gemini-api/docs/models/experimental-models\n  | 'gemini-2.5-pro-exp-03-25'\n  | 'gemini-exp-1206'\n  | 'gemma-3-12b-it'\n  | 'gemma-3-27b-it'\n  | (string & {});\n\nexport const googleGenerativeAIProviderOptions = lazySchema(() =>\n  zodSchema(\n    z.object({\n      responseModalities: z.array(z.enum(['TEXT', 'IMAGE'])).optional(),\n\n      thinkingConfig: z\n        .object({\n          thinkingBudget: z.number().optional(),\n          includeThoughts: z.boolean().optional(),\n          // https://ai.google.dev/gemini-api/docs/gemini-3?thinking=high#thinking_level\n          thinkingLevel: z\n            .enum(['minimal', 'low', 'medium', 'high'])\n            .optional(),\n        })\n        .optional(),\n\n      /**\n       * Optional.\n       * The name of the cached content used as context to serve the prediction.\n       * Format: cachedContents/{cachedContent}\n       */\n      cachedContent: z.string().optional(),\n\n      /**\n       * Optional. Enable structured output. Default is true.\n       *\n       * This is useful when the JSON Schema contains elements that are\n       * not supported by the OpenAPI schema version that\n       * Google Generative AI uses. You can use this to disable\n       * structured outputs if you need to.\n       */\n      structuredOutputs: z.boolean().optional(),\n\n      /**\n       * Optional. A list of unique safety settings for blocking unsafe content.\n       */\n      safetySettings: z\n        .array(\n          z.object({\n            category: z.enum([\n              'HARM_CATEGORY_UNSPECIFIED',\n              'HARM_CATEGORY_HATE_SPEECH',\n              'HARM_CATEGORY_DANGEROUS_CONTENT',\n              'HARM_CATEGORY_HARASSMENT',\n              'HARM_CATEGORY_SEXUALLY_EXPLICIT',\n              'HARM_CATEGORY_CIVIC_INTEGRITY',\n            ]),\n            threshold: z.enum([\n              'HARM_BLOCK_THRESHOLD_UNSPECIFIED',\n              'BLOCK_LOW_AND_ABOVE',\n              'BLOCK_MEDIUM_AND_ABOVE',\n              'BLOCK_ONLY_HIGH',\n              'BLOCK_NONE',\n              'OFF',\n            ]),\n          }),\n        )\n        .optional(),\n\n      threshold: z\n        .enum([\n          'HARM_BLOCK_THRESHOLD_UNSPECIFIED',\n          'BLOCK_LOW_AND_ABOVE',\n          'BLOCK_MEDIUM_AND_ABOVE',\n          'BLOCK_ONLY_HIGH',\n          'BLOCK_NONE',\n          'OFF',\n        ])\n        .optional(),\n\n      /**\n       * Optional. Enables timestamp understanding for audio-only files.\n       *\n       * https://cloud.google.com/vertex-ai/generative-ai/docs/multimodal/audio-understanding\n       */\n      audioTimestamp: z.boolean().optional(),\n\n      /**\n       * Optional. Defines labels used in billing reports. Available on Vertex AI only.\n       *\n       * https://cloud.google.com/vertex-ai/generative-ai/docs/multimodal/add-labels-to-api-calls\n       */\n      labels: z.record(z.string(), z.string()).optional(),\n\n      /**\n       * Optional. If specified, the media resolution specified will be used.\n       *\n       * https://ai.google.dev/api/generate-content#MediaResolution\n       */\n      mediaResolution: z\n        .enum([\n          'MEDIA_RESOLUTION_UNSPECIFIED',\n          'MEDIA_RESOLUTION_LOW',\n          'MEDIA_RESOLUTION_MEDIUM',\n          'MEDIA_RESOLUTION_HIGH',\n        ])\n        .optional(),\n\n      /**\n       * Optional. Configures the image generation aspect ratio for Gemini models.\n       *\n       * https://ai.google.dev/gemini-api/docs/image-generation#aspect_ratios\n       */\n      imageConfig: z\n        .object({\n          aspectRatio: z\n            .enum([\n              '1:1',\n              '2:3',\n              '3:2',\n              '3:4',\n              '4:3',\n              '4:5',\n              '5:4',\n              '9:16',\n              '16:9',\n              '21:9',\n            ])\n            .optional(),\n          imageSize: z.enum(['1K', '2K', '4K']).optional(),\n        })\n        .optional(),\n\n      /**\n       * Optional. Configuration for grounding retrieval.\n       * Used to provide location context for Google Maps and Google Search grounding.\n       *\n       * https://cloud.google.com/vertex-ai/generative-ai/docs/grounding/grounding-with-google-maps\n       */\n      retrievalConfig: z\n        .object({\n          latLng: z\n            .object({\n              latitude: z.number(),\n              longitude: z.number(),\n            })\n            .optional(),\n        })\n        .optional(),\n    }),\n  ),\n);\n\nexport type GoogleGenerativeAIProviderOptions = InferSchema<\n  typeof googleGenerativeAIProviderOptions\n>;\n","import {\n  LanguageModelV3CallOptions,\n  SharedV3Warning,\n  UnsupportedFunctionalityError,\n} from '@ai-sdk/provider';\nimport { convertJSONSchemaToOpenAPISchema } from './convert-json-schema-to-openapi-schema';\nimport { GoogleGenerativeAIModelId } from './google-generative-ai-options';\n\nexport function prepareTools({\n  tools,\n  toolChoice,\n  modelId,\n}: {\n  tools: LanguageModelV3CallOptions['tools'];\n  toolChoice?: LanguageModelV3CallOptions['toolChoice'];\n  modelId: GoogleGenerativeAIModelId;\n}): {\n  tools:\n    | Array<\n        | {\n            functionDeclarations: Array<{\n              name: string;\n              description: string;\n              parameters: unknown;\n            }>;\n          }\n        | Record<string, any>\n      >\n    | undefined;\n  toolConfig:\n    | undefined\n    | {\n        functionCallingConfig: {\n          mode: 'AUTO' | 'NONE' | 'ANY';\n          allowedFunctionNames?: string[];\n        };\n      };\n  toolWarnings: SharedV3Warning[];\n} {\n  // when the tools array is empty, change it to undefined to prevent errors:\n  tools = tools?.length ? tools : undefined;\n\n  const toolWarnings: SharedV3Warning[] = [];\n\n  const isLatest = (\n    [\n      'gemini-flash-latest',\n      'gemini-flash-lite-latest',\n      'gemini-pro-latest',\n    ] as const satisfies GoogleGenerativeAIModelId[]\n  ).some(id => id === modelId);\n  const isGemini2orNewer =\n    modelId.includes('gemini-2') || modelId.includes('gemini-3') || isLatest;\n  const supportsDynamicRetrieval =\n    modelId.includes('gemini-1.5-flash') && !modelId.includes('-8b');\n  const supportsFileSearch = modelId.includes('gemini-2.5');\n\n  if (tools == null) {\n    return { tools: undefined, toolConfig: undefined, toolWarnings };\n  }\n\n  // Check for mixed tool types and add warnings\n  const hasFunctionTools = tools.some(tool => tool.type === 'function');\n  const hasProviderTools = tools.some(tool => tool.type === 'provider');\n\n  if (hasFunctionTools && hasProviderTools) {\n    toolWarnings.push({\n      type: 'unsupported',\n      feature: `combination of function and provider-defined tools`,\n    });\n  }\n\n  if (hasProviderTools) {\n    const googleTools: any[] = [];\n\n    const ProviderTools = tools.filter(tool => tool.type === 'provider');\n    ProviderTools.forEach(tool => {\n      switch (tool.id) {\n        case 'google.google_search':\n          if (isGemini2orNewer) {\n            googleTools.push({ googleSearch: {} });\n          } else if (supportsDynamicRetrieval) {\n            // For non-Gemini-2 models that don't support dynamic retrieval, use basic googleSearchRetrieval\n            googleTools.push({\n              googleSearchRetrieval: {\n                dynamicRetrievalConfig: {\n                  mode: tool.args.mode as\n                    | 'MODE_DYNAMIC'\n                    | 'MODE_UNSPECIFIED'\n                    | undefined,\n                  dynamicThreshold: tool.args.dynamicThreshold as\n                    | number\n                    | undefined,\n                },\n              },\n            });\n          } else {\n            googleTools.push({ googleSearchRetrieval: {} });\n          }\n          break;\n        case 'google.enterprise_web_search':\n          if (isGemini2orNewer) {\n            googleTools.push({ enterpriseWebSearch: {} });\n          } else {\n            toolWarnings.push({\n              type: 'unsupported',\n              feature: `provider-defined tool ${tool.id}`,\n              details: 'Enterprise Web Search requires Gemini 2.0 or newer.',\n            });\n          }\n          break;\n        case 'google.url_context':\n          if (isGemini2orNewer) {\n            googleTools.push({ urlContext: {} });\n          } else {\n            toolWarnings.push({\n              type: 'unsupported',\n              feature: `provider-defined tool ${tool.id}`,\n              details:\n                'The URL context tool is not supported with other Gemini models than Gemini 2.',\n            });\n          }\n          break;\n        case 'google.code_execution':\n          if (isGemini2orNewer) {\n            googleTools.push({ codeExecution: {} });\n          } else {\n            toolWarnings.push({\n              type: 'unsupported',\n              feature: `provider-defined tool ${tool.id}`,\n              details:\n                'The code execution tools is not supported with other Gemini models than Gemini 2.',\n            });\n          }\n          break;\n        case 'google.file_search':\n          if (supportsFileSearch) {\n            googleTools.push({ fileSearch: { ...tool.args } });\n          } else {\n            toolWarnings.push({\n              type: 'unsupported',\n              feature: `provider-defined tool ${tool.id}`,\n              details:\n                'The file search tool is only supported with Gemini 2.5 models.',\n            });\n          }\n          break;\n        case 'google.vertex_rag_store':\n          if (isGemini2orNewer) {\n            googleTools.push({\n              retrieval: {\n                vertex_rag_store: {\n                  rag_resources: {\n                    rag_corpus: tool.args.ragCorpus,\n                  },\n                  similarity_top_k: tool.args.topK as number | undefined,\n                },\n              },\n            });\n          } else {\n            toolWarnings.push({\n              type: 'unsupported',\n              feature: `provider-defined tool ${tool.id}`,\n              details:\n                'The RAG store tool is not supported with other Gemini models than Gemini 2.',\n            });\n          }\n          break;\n        case 'google.google_maps':\n          if (isGemini2orNewer) {\n            googleTools.push({ googleMaps: {} });\n          } else {\n            toolWarnings.push({\n              type: 'unsupported',\n              feature: `provider-defined tool ${tool.id}`,\n              details:\n                'The Google Maps grounding tool is not supported with Gemini models other than Gemini 2 or newer.',\n            });\n          }\n          break;\n        default:\n          toolWarnings.push({\n            type: 'unsupported',\n            feature: `provider-defined tool ${tool.id}`,\n          });\n          break;\n      }\n    });\n\n    return {\n      tools: googleTools.length > 0 ? googleTools : undefined,\n      toolConfig: undefined,\n      toolWarnings,\n    };\n  }\n\n  const functionDeclarations = [];\n  for (const tool of tools) {\n    switch (tool.type) {\n      case 'function':\n        functionDeclarations.push({\n          name: tool.name,\n          description: tool.description ?? '',\n          parameters: convertJSONSchemaToOpenAPISchema(tool.inputSchema),\n        });\n        break;\n      default:\n        toolWarnings.push({\n          type: 'unsupported',\n          feature: `function tool ${tool.name}`,\n        });\n        break;\n    }\n  }\n\n  if (toolChoice == null) {\n    return {\n      tools: [{ functionDeclarations }],\n      toolConfig: undefined,\n      toolWarnings,\n    };\n  }\n\n  const type = toolChoice.type;\n\n  switch (type) {\n    case 'auto':\n      return {\n        tools: [{ functionDeclarations }],\n        toolConfig: { functionCallingConfig: { mode: 'AUTO' } },\n        toolWarnings,\n      };\n    case 'none':\n      return {\n        tools: [{ functionDeclarations }],\n        toolConfig: { functionCallingConfig: { mode: 'NONE' } },\n        toolWarnings,\n      };\n    case 'required':\n      return {\n        tools: [{ functionDeclarations }],\n        toolConfig: { functionCallingConfig: { mode: 'ANY' } },\n        toolWarnings,\n      };\n    case 'tool':\n      return {\n        tools: [{ functionDeclarations }],\n        toolConfig: {\n          functionCallingConfig: {\n            mode: 'ANY',\n            allowedFunctionNames: [toolChoice.toolName],\n          },\n        },\n        toolWarnings,\n      };\n    default: {\n      const _exhaustiveCheck: never = type;\n      throw new UnsupportedFunctionalityError({\n        functionality: `tool choice type: ${_exhaustiveCheck}`,\n      });\n    }\n  }\n}\n","import { LanguageModelV3FinishReason } from '@ai-sdk/provider';\n\nexport function mapGoogleGenerativeAIFinishReason({\n  finishReason,\n  hasToolCalls,\n}: {\n  finishReason: string | null | undefined;\n  hasToolCalls: boolean;\n}): LanguageModelV3FinishReason['unified'] {\n  switch (finishReason) {\n    case 'STOP':\n      return hasToolCalls ? 'tool-calls' : 'stop';\n    case 'MAX_TOKENS':\n      return 'length';\n    case 'IMAGE_SAFETY':\n    case 'RECITATION':\n    case 'SAFETY':\n    case 'BLOCKLIST':\n    case 'PROHIBITED_CONTENT':\n    case 'SPII':\n      return 'content-filter';\n    case 'MALFORMED_FUNCTION_CALL':\n      return 'error';\n    case 'FINISH_REASON_UNSPECIFIED':\n    case 'OTHER':\n    default:\n      return 'other';\n  }\n}\n","import { createProviderToolFactoryWithOutputSchema } from '@ai-sdk/provider-utils';\nimport { z } from 'zod/v4';\n\n/**\n * A tool that enables the model to generate and run Python code.\n *\n * @note Ensure the selected model supports Code Execution.\n * Multi-tool usage with the code execution tool is typically compatible with Gemini >=2 models.\n *\n * @see https://ai.google.dev/gemini-api/docs/code-execution (Google AI)\n * @see https://cloud.google.com/vertex-ai/generative-ai/docs/model-reference/code-execution-api (Vertex AI)\n */\nexport const codeExecution = createProviderToolFactoryWithOutputSchema<\n  {\n    language: string;\n    code: string;\n  },\n  {\n    outcome: string;\n    output: string;\n  },\n  {}\n>({\n  id: 'google.code_execution',\n  inputSchema: z.object({\n    language: z.string().describe('The programming language of the code.'),\n    code: z.string().describe('The code to be executed.'),\n  }),\n  outputSchema: z.object({\n    outcome: z\n      .string()\n      .describe('The outcome of the execution (e.g., \"OUTCOME_OK\").'),\n    output: z.string().describe('The output from the code execution.'),\n  }),\n});\n","import {\n  createProviderToolFactory,\n  lazySchema,\n  zodSchema,\n} from '@ai-sdk/provider-utils';\nimport { z } from 'zod/v4';\n\n// https://cloud.google.com/vertex-ai/generative-ai/docs/grounding/web-grounding-enterprise\n\nexport const enterpriseWebSearch = createProviderToolFactory<\n  {\n    // Enterprise Web Search does not have any input schema\n  },\n  {}\n>({\n  id: 'google.enterprise_web_search',\n  inputSchema: lazySchema(() => zodSchema(z.object({}))),\n});\n","import {\n  createProviderToolFactory,\n  lazySchema,\n  zodSchema,\n} from '@ai-sdk/provider-utils';\nimport { z } from 'zod/v4';\n\n/** Tool to retrieve knowledge from the File Search Stores. */\nconst fileSearchArgsBaseSchema = z\n  .object({\n    /** The names of the file_search_stores to retrieve from.\n     *  Example: `fileSearchStores/my-file-search-store-123`\n     */\n    fileSearchStoreNames: z\n      .array(z.string())\n      .describe(\n        'The names of the file_search_stores to retrieve from. Example: `fileSearchStores/my-file-search-store-123`',\n      ),\n    /** The number of file search retrieval chunks to retrieve. */\n    topK: z\n      .number()\n      .int()\n      .positive()\n      .describe('The number of file search retrieval chunks to retrieve.')\n      .optional(),\n\n    /** Metadata filter to apply to the file search retrieval documents.\n     *  See https://google.aip.dev/160 for the syntax of the filter expression.\n     */\n    metadataFilter: z\n      .string()\n      .describe(\n        'Metadata filter to apply to the file search retrieval documents. See https://google.aip.dev/160 for the syntax of the filter expression.',\n      )\n      .optional(),\n  })\n  .passthrough();\n\nexport type GoogleFileSearchToolArgs = z.infer<typeof fileSearchArgsBaseSchema>;\n\nconst fileSearchArgsSchema = lazySchema(() =>\n  zodSchema(fileSearchArgsBaseSchema),\n);\n\nexport const fileSearch = createProviderToolFactory<\n  {},\n  GoogleFileSearchToolArgs\n>({\n  id: 'google.file_search',\n  inputSchema: fileSearchArgsSchema,\n});\n","import {\n  createProviderToolFactory,\n  lazySchema,\n  zodSchema,\n} from '@ai-sdk/provider-utils';\nimport { z } from 'zod/v4';\n\n// https://ai.google.dev/gemini-api/docs/maps-grounding\n// https://cloud.google.com/vertex-ai/generative-ai/docs/grounding/grounding-with-google-maps\n\nexport const googleMaps = createProviderToolFactory<{}, {}>({\n  id: 'google.google_maps',\n  inputSchema: lazySchema(() => zodSchema(z.object({}))),\n});\n","import {\n  createProviderToolFactory,\n  lazySchema,\n  zodSchema,\n} from '@ai-sdk/provider-utils';\nimport { z } from 'zod/v4';\n\n// https://ai.google.dev/gemini-api/docs/google-search\n// https://ai.google.dev/api/generate-content#GroundingSupport\n// https://cloud.google.com/vertex-ai/generative-ai/docs/grounding/grounding-with-google-search\n\nexport const googleSearch = createProviderToolFactory<\n  {},\n  {\n    /**\n     * The mode of the predictor to be used in dynamic retrieval. The following modes are supported:\n     *  - MODE_DYNAMIC: Run retrieval only when system decides it is necessary\n     *  - MODE_UNSPECIFIED: Always trigger retrieval\n     * @default MODE_UNSPECIFIED\n     */\n    mode?: 'MODE_DYNAMIC' | 'MODE_UNSPECIFIED';\n\n    /**\n     * The threshold to be used in dynamic retrieval (if not set, a system default value is used).\n     */\n    dynamicThreshold?: number;\n  }\n>({\n  id: 'google.google_search',\n  inputSchema: lazySchema(() =>\n    zodSchema(\n      z.object({\n        mode: z\n          .enum(['MODE_DYNAMIC', 'MODE_UNSPECIFIED'])\n          .default('MODE_UNSPECIFIED'),\n        dynamicThreshold: z.number().default(1),\n      }),\n    ),\n  ),\n});\n","import {\n  createProviderToolFactory,\n  lazySchema,\n  zodSchema,\n} from '@ai-sdk/provider-utils';\nimport { z } from 'zod/v4';\n\nexport const urlContext = createProviderToolFactory<\n  {\n    // Url context does not have any input schema, it will directly use the url from the prompt\n  },\n  {}\n>({\n  id: 'google.url_context',\n  inputSchema: lazySchema(() => zodSchema(z.object({}))),\n});\n","import { createProviderToolFactory } from '@ai-sdk/provider-utils';\nimport { z } from 'zod/v4';\n\n// https://cloud.google.com/vertex-ai/generative-ai/docs/rag-engine/use-vertexai-search#generate-content-using-gemini-api\n// https://cloud.google.com/vertex-ai/generative-ai/docs/model-reference/rag-output-explained\n\n/**\n * A tool that enables the model to perform RAG searches against a Vertex RAG Store.\n *\n * @note Only works with Vertex Gemini models.\n */\nexport const vertexRagStore = createProviderToolFactory<\n  {},\n  {\n    /**\n     * RagCorpus resource names, eg: projects/{project}/locations/{location}/ragCorpora/{rag_corpus}\n     */\n    ragCorpus: string;\n\n    /**\n     * The number of top contexts to retrieve.\n     */\n    topK?: number;\n  }\n>({\n  id: 'google.vertex_rag_store',\n  inputSchema: z.object({\n    ragCorpus: z.string(),\n    topK: z.number().optional(),\n  }),\n});\n","import { codeExecution } from './tool/code-execution';\nimport { enterpriseWebSearch } from './tool/enterprise-web-search';\nimport { fileSearch } from './tool/file-search';\nimport { googleMaps } from './tool/google-maps';\nimport { googleSearch } from './tool/google-search';\nimport { urlContext } from './tool/url-context';\nimport { vertexRagStore } from './tool/vertex-rag-store';\n\nexport const googleTools = {\n  /**\n   * Creates a Google search tool that gives Google direct access to real-time web content.\n   * Must have name \"google_search\".\n   */\n  googleSearch,\n\n  /**\n   * Creates an Enterprise Web Search tool for grounding responses using a compliance-focused web index.\n   * Designed for highly-regulated industries (finance, healthcare, public sector).\n   * Does not log customer data and supports VPC service controls.\n   * Must have name \"enterprise_web_search\".\n   *\n   * @note Only available on Vertex AI. Requires Gemini 2.0 or newer.\n   *\n   * @see https://cloud.google.com/vertex-ai/generative-ai/docs/grounding/web-grounding-enterprise\n   */\n  enterpriseWebSearch,\n\n  /**\n   * Creates a Google Maps grounding tool that gives the model access to Google Maps data.\n   * Must have name \"google_maps\".\n   *\n   * @see https://ai.google.dev/gemini-api/docs/maps-grounding\n   * @see https://cloud.google.com/vertex-ai/generative-ai/docs/grounding/grounding-with-google-maps\n   */\n  googleMaps,\n\n  /**\n   * Creates a URL context tool that gives Google direct access to real-time web content.\n   * Must have name \"url_context\".\n   */\n  urlContext,\n\n  /**\n   * Enables Retrieval Augmented Generation (RAG) via the Gemini File Search tool.\n   * Must have name \"file_search\".\n   *\n   * @param fileSearchStoreNames - Fully-qualified File Search store resource names.\n   * @param metadataFilter - Optional filter expression to restrict the files that can be retrieved.\n   * @param topK - Optional result limit for the number of chunks returned from File Search.\n   *\n   * @see https://ai.google.dev/gemini-api/docs/file-search\n   */\n  fileSearch,\n  /**\n   * A tool that enables the model to generate and run Python code.\n   * Must have name \"code_execution\".\n   *\n   * @note Ensure the selected model supports Code Execution.\n   * Multi-tool usage with the code execution tool is typically compatible with Gemini >=2 models.\n   *\n   * @see https://ai.google.dev/gemini-api/docs/code-execution (Google AI)\n   * @see https://cloud.google.com/vertex-ai/generative-ai/docs/model-reference/code-execution-api (Vertex AI)\n   */\n  codeExecution,\n\n  /**\n   * Creates a Vertex RAG Store tool that enables the model to perform RAG searches against a Vertex RAG Store.\n   * Must have name \"vertex_rag_store\".\n   */\n  vertexRagStore,\n};\n","import { ImageModelV3, SharedV3Warning } from '@ai-sdk/provider';\nimport {\n  combineHeaders,\n  createJsonResponseHandler,\n  type InferSchema,\n  lazySchema,\n  parseProviderOptions,\n  postJsonToApi,\n  resolve,\n  zodSchema,\n} from '@ai-sdk/provider-utils';\nimport { z } from 'zod/v4';\nimport { googleFailedResponseHandler } from './google-error';\nimport {\n  GoogleGenerativeAIImageModelId,\n  GoogleGenerativeAIImageSettings,\n} from './google-generative-ai-image-settings';\nimport { FetchFunction, Resolvable } from '@ai-sdk/provider-utils';\n\ninterface GoogleGenerativeAIImageModelConfig {\n  provider: string;\n  baseURL: string;\n  headers?: Resolvable<Record<string, string | undefined>>;\n  fetch?: FetchFunction;\n  generateId?: () => string;\n  _internal?: {\n    currentDate?: () => Date;\n  };\n}\n\nexport class GoogleGenerativeAIImageModel implements ImageModelV3 {\n  readonly specificationVersion = 'v3';\n\n  get maxImagesPerCall(): number {\n    // https://ai.google.dev/gemini-api/docs/imagen#imagen-model\n    return this.settings.maxImagesPerCall ?? 4;\n  }\n\n  get provider(): string {\n    return this.config.provider;\n  }\n\n  constructor(\n    readonly modelId: GoogleGenerativeAIImageModelId,\n    private readonly settings: GoogleGenerativeAIImageSettings,\n    private readonly config: GoogleGenerativeAIImageModelConfig,\n  ) {}\n\n  async doGenerate(\n    options: Parameters<ImageModelV3['doGenerate']>[0],\n  ): Promise<Awaited<ReturnType<ImageModelV3['doGenerate']>>> {\n    const {\n      prompt,\n      n = 1,\n      size,\n      aspectRatio = '1:1',\n      seed,\n      providerOptions,\n      headers,\n      abortSignal,\n      files,\n      mask,\n    } = options;\n    const warnings: Array<SharedV3Warning> = [];\n\n    // Google Generative AI does not support image editing\n    if (files != null && files.length > 0) {\n      throw new Error(\n        'Google Generative AI does not support image editing. ' +\n          'Use Google Vertex AI (@ai-sdk/google-vertex) for image editing capabilities.',\n      );\n    }\n\n    if (mask != null) {\n      throw new Error(\n        'Google Generative AI does not support image editing with masks. ' +\n          'Use Google Vertex AI (@ai-sdk/google-vertex) for image editing capabilities.',\n      );\n    }\n\n    if (size != null) {\n      warnings.push({\n        type: 'unsupported',\n        feature: 'size',\n        details:\n          'This model does not support the `size` option. Use `aspectRatio` instead.',\n      });\n    }\n\n    if (seed != null) {\n      warnings.push({\n        type: 'unsupported',\n        feature: 'seed',\n        details:\n          'This model does not support the `seed` option through this provider.',\n      });\n    }\n\n    const googleOptions = await parseProviderOptions({\n      provider: 'google',\n      providerOptions,\n      schema: googleImageProviderOptionsSchema,\n    });\n\n    const currentDate = this.config._internal?.currentDate?.() ?? new Date();\n\n    const parameters: Record<string, unknown> = {\n      sampleCount: n,\n    };\n\n    if (aspectRatio != null) {\n      parameters.aspectRatio = aspectRatio;\n    }\n\n    if (googleOptions) {\n      Object.assign(parameters, googleOptions);\n    }\n\n    const body = {\n      instances: [{ prompt }],\n      parameters,\n    };\n\n    const { responseHeaders, value: response } = await postJsonToApi<{\n      predictions: Array<{ bytesBase64Encoded: string }>;\n    }>({\n      url: `${this.config.baseURL}/models/${this.modelId}:predict`,\n      headers: combineHeaders(await resolve(this.config.headers), headers),\n      body,\n      failedResponseHandler: googleFailedResponseHandler,\n      successfulResponseHandler: createJsonResponseHandler(\n        googleImageResponseSchema,\n      ),\n      abortSignal,\n      fetch: this.config.fetch,\n    });\n    return {\n      images: response.predictions.map(\n        (p: { bytesBase64Encoded: string }) => p.bytesBase64Encoded,\n      ),\n      warnings: warnings ?? [],\n      providerMetadata: {\n        google: {\n          images: response.predictions.map(prediction => ({\n            // Add any prediction-specific metadata here\n          })),\n        },\n      },\n      response: {\n        timestamp: currentDate,\n        modelId: this.modelId,\n        headers: responseHeaders,\n      },\n    };\n  }\n}\n\n// minimal version of the schema\nconst googleImageResponseSchema = lazySchema(() =>\n  zodSchema(\n    z.object({\n      predictions: z\n        .array(z.object({ bytesBase64Encoded: z.string() }))\n        .default([]),\n    }),\n  ),\n);\n\n// Note: For the initial GA launch of Imagen 3, safety filters are not configurable.\n// https://ai.google.dev/gemini-api/docs/imagen#imagen-model\nconst googleImageProviderOptionsSchema = lazySchema(() =>\n  zodSchema(\n    z.object({\n      personGeneration: z\n        .enum(['dont_allow', 'allow_adult', 'allow_all'])\n        .nullish(),\n      aspectRatio: z.enum(['1:1', '3:4', '4:3', '9:16', '16:9']).nullish(),\n    }),\n  ),\n);\n\nexport type GoogleGenerativeAIImageProviderOptions = InferSchema<\n  typeof googleImageProviderOptionsSchema\n>;\n","import { createGoogleGenerativeAI } from '@ai-sdk/google';\r\nimport { streamText } from 'ai';\r\nimport { google as googleProvider } from '@ai-sdk/google';\r\nimport { getConversationContext, saveMessage, ensureSession } from '@ai-core';\r\nimport { checkRateLimit } from '@/lib/rate-limit';\r\nimport type { createChatTools } from '@ai-core';\r\nimport { callAIWithRetry } from '@ai-core';\r\n\r\n//  Helper: Extract text content from various message formats\r\nfunction extractUserMessage(message: any): string {\r\n    // Case C: message.parts array (actual structure from AI SDK)\r\n    if (message?.parts && Array.isArray(message.parts)) {\r\n        return message.parts\r\n            .filter((part: any) => part.type === 'text')\r\n            .map((part: any) => part.text)\r\n            .join('\\n');\r\n    }\r\n\r\n    // Case B: message.content is an array (Vercel multipart)\r\n    if (message?.content && Array.isArray(message.content)) {\r\n        return message.content\r\n            .filter((part: any) => part.type === 'text')\r\n            .map((part: any) => part.text)\r\n            .join('\\n');\r\n    }\r\n\r\n    // Case A: message.content is a simple string\r\n    if (typeof message?.content === 'string') {\r\n        return message.content;\r\n    }\r\n\r\n    return '';\r\n}\r\n\r\n// Configurazione\r\nexport const maxDuration = 60;\r\nexport const dynamic = 'force-dynamic';\r\nexport const runtime = 'nodejs'; // Required for Firebase Admin SDK\r\n\r\nconst SYSTEM_INSTRUCTION = `[CORE IDENTITY]\r\nYou are SYD - ARCHITETTO PERSONALE, an advanced construction and design assistant.\r\nLanguage: Italian.\r\nPrimary Rule: Classify intent immediately: MODE A (Designer) or MODE B (Surveyor).\r\n\r\n[INTERACTION RULES]\r\n1. **GREETINGS (Ciao)**: If the user says \"Ciao\" or greetings, DO NOT introduce yourself (you already did). Just answer: \"Ciao! Come posso aiutarti con il tuo progetto?\".\r\n2. **QUESTION LIMIT**: Ask MAXIMUM 1 or 2 questions at a time. NEVER ask a long list of questions. Wait for the user's answer before proceeding.\r\n\r\n[PHOTO UPLOAD DISAMBIGUATION]\r\n**CRITICAL RULE**: If the user's intent is UNCLEAR (e.g., uploads photo with only \"Ciao\", generic greetings, or vague text):\r\n1. DO NOT assume MODE A or MODE B\r\n2. MUST ask explicitly which service they want:\r\n\r\nResponse Template:\r\n\"Ciao! Ho ricevuto la tua foto. Come posso aiutarti?\r\n\r\n1.  **Visualizzare** come verrebbe ristrutturato con un rendering 3D\r\n2.  **Ricevere un preventivo** dettagliato per i lavori\r\n\r\nCosa preferisci?\"\r\n\r\n**WAIT for user's choice** before proceeding to MODE A or MODE B.\r\n\r\n\r\n[EXISTING TOOL INSTRUCTIONS]\r\n##  ANALISI IMMAGINI UPLOAD (FOTO UTENTE)\r\n\r\nQuando l'utente carica una foto:\r\n1. **ANALIZZA SUBITO** la foto.\r\n2. **DESCRIVI** esplicitamente cosa vedi.\r\n3. **NON GENERARE** ancora. Avvia il protocollo \"Discovery\" (vedi Mode A).\r\n\r\n## ISTRUZIONI PER IL TOOL generate_render\r\n\r\n**STEP 1 - structuralElements (OBBLIGATORIO):**\r\nPrima di tutto, devi compilare il campo \\`structuralElements\\` con TUTTI gli elementi strutturali:\r\n- Se l'utente ha caricato una FOTO: descrivi gli elementi visibili (es. \"arched window on left wall, wooden ceiling beams, parquet floor\")\r\n- Se NON c' foto: descrivi gli elementi richiesti nella conversazione\r\n- Scrivi in INGLESE e sii SPECIFICO\r\n\r\n**STEP 2 - roomType & style:**\r\nCompila questi campi in INGLESE (es. \"living room\", \"modern\")\r\n\r\n**STEP 3 - prompt (DEVE iniziare con structuralElements):**\r\nIl prompt DEVE iniziare descrivendo gli elementi di STEP 1.\r\n\r\n##  SCELTA MODALIT (mode)\r\n\r\n### MODE: \"creation\" (Creazione da zero)\r\nUsa quando l'utente NON ha caricato una foto\r\n\r\n### MODE: \"modification\" (Modifica foto esistente)\r\nUsa quando l'utente HA CARICATO una foto.\r\nDEVI compilare \\`sourceImageUrl\\`:\r\n1. Cerca nella cronologia il marker: \\`[Immagine allegata: https://storage.googleapis.com/...]\\`\r\n2. Estrai l'URL dal marker\r\n\r\n---\r\n\r\nMODE A: THE DESIGNER (Rendering & Visual Flow)\r\n\r\nTrigger: User wants to \"visualize\", \"imagine\", \"see ideas\", \"style advice\".\r\n\r\nScenario 1: Starting from Photo (Hybrid Vision) - STRICT PROTOCOL\r\n\r\nAction:\r\n1. ANALYZE (Silent): Identify structural constraints (windows, beams) from the image.\r\n2. DISCOVERY (Mandatory): BEFORE generating, you MUST ask:\r\n   - \"Cosa vuoi MANTENERE? (es. pavimento, infissi)\"\r\n   - \"Cosa vuoi CAMBIARE? (es. stile, colori)\"\r\n3. STOP & WAIT: Do NOT call 'generate_render' yet. You need these answers first.\r\n4. GENERATE: Only AFTER the user replies to these questions, call 'generate_render'.\r\n   - CRITICAL: You MUST populate the 'keepElements' parameter with the specific items the user wants to maintain (e.g., [\"camino\", \"scuro\", \"pavimento\"]).\r\n\r\nScenario 2: Starting from Zero\r\n\r\nAction: Guide imagination (Room Type, Style, Key Elements).\r\nGenerate: Create a descriptive prompt from scratch.\r\n\r\n---\r\n\r\nMODE B: RENOVATION CONSULTANT (Quote & Preventivo Flow)\r\n\r\nTrigger: User wants \"quote\", \"cost\", \"work details\", \"renovation\", \"preventivo\".\r\n\r\n\r\nPERSONA & MINDSET\r\n\r\nYou are a professional renovation consultant - think like an experienced architect \r\nor interior designer having a first consultation with a potential client.\r\n\r\nYour goal is to understand their PROJECT VISION and gather practical details \r\nfor an accurate quote, NOT to interrogate them with bureaucratic questions.\r\n\r\nTone: Professional, friendly, consultative, adaptive.\r\n\r\n\r\nINFORMATION TO GATHER\r\n\r\n\r\nESSENTIAL (Always Required):\r\n1. **Contact Information** (upfront, professional)\r\n   - Nome/Name\r\n   - Email\r\n   - Telefono/Phone (optional but encouraged)\r\n\r\n2. **Project Vision** (open-ended, rich detail)\r\n   - What do they want to achieve?\r\n   - Which room/space?\r\n   - Current state vs desired outcome\r\n\r\n3. **Scope of Work** (specific, project-focused)\r\n   - What needs to be done? (demolition, construction, finishes)\r\n   - Systems involved? (electrical, plumbing, HVAC)\r\n   - Materials preferences?\r\n\r\n4. **Space Context** (practical, approximate)\r\n   - Room type (kitchen, bathroom, living room, etc.)\r\n   - Approximate size (even \"piccola, media, grande\" is fine)\r\n   - Any structural constraints? (load-bearing walls, windows, doors)\r\n\r\nADAPTIVE (Based on Context):\r\n- For kitchens: Layout changes? Appliances included?\r\n- For bathrooms: Fixture replacement? New installations?\r\n- For renovations: Demolition extent? Preserve anything?\r\n- For new construction: From scratch or partial?\r\n\r\n\r\nCONVERSATION APPROACH\r\n\r\n\r\nSTART: Friendly intro + contact info request\r\nExample: \"Ciao! Per prepararti un preventivo accurato, partiamo dai contatti. \r\nCome ti chiami e qual  la tua email?\"\r\n\r\nMIDDLE: Open-ended project questions  Intelligent follow-ups\r\n- Ask WHAT they want (vision), not HOW they'll execute (logistics)\r\n- Let them describe freely, then drill into specifics\r\n- Adapt questions to their answers (be contextual!)\r\n- Focus on SCOPE and MATERIALS, not administrative details\r\n\r\nEND: Confirm understanding + save\r\nExample: \"Perfetto! Ho tutti i dettagli. Ricapitoliamo: [summary]. \r\nProcedo a salvare il tutto?\"\r\n\r\nMinimum Exchanges: 4-5 back-and-forth to gather quality information.\r\nMaximum: Keep it efficient - respect their time.\r\n\r\n\r\nEXAMPLES - GOOD QUESTIONS \r\n\r\n\r\n**Project Vision:**\r\n \"Raccontami del tuo progetto: cosa vuoi realizzare?\"\r\n \"Qual  l'obiettivo principale? Estetico, funzionale, o entrambi?\"\r\n \"Hai riferimenti di stile? (Moderno, classico, industriale...)\"\r\n\r\n**Scope of Work:**\r\n \"Cosa prevedi di cambiare esattamente?\"\r\n \"Partiamo da zero o mantieni qualcosa dell'esistente?\"\r\n \"Gli impianti (elettrico, idraulico) vanno rifatti o aggiornati?\"\r\n \"Prevedi demolizioni? Se s, totali o parziali?\"\r\n\r\n**Materials & Finishes:**\r\n \"Quali materiali hai in mente? (Legno, marmo, gres, laminato...)\"\r\n \"Pavimento: sostituzione o manutenzione?\"\r\n \"Rivestimenti bagno/cucina: piastrelle, resina, altro?\"\r\n\r\n**Space Context:**\r\n \"Che dimensioni ha lo spazio? (anche indicative)\"\r\n \"Ci sono vincoli architettonici da considerare?\"\r\n \"Finestre e porte: mantieni posizioni o vuoi modifiche?\"\r\n\r\n**Room-Specific (Kitchen):**\r\n \"La disposizione attuale va bene o vuoi cambiarla?\"\r\n \"Elettrodomestici: li fornisci tu o li includiamo?\"\r\n \"Top e ante: che materiali preferisci?\"\r\n\r\n**Room-Specific (Bathroom):**\r\n \"Sanitari: quanti e che tipo? (Doccia, vasca, bidet...)\"\r\n \"Mobili bagno: su misura o standard?\"\r\n \"Rivestimenti: totali o solo zona doccia?\"\r\n\r\n\r\nEXAMPLES - BAD QUESTIONS  (DO NOT ASK)\r\n\r\n\r\n**Logistics (Not Relevant for Quote):**\r\n \"A che piano  l'appartamento?\"\r\n \"C' l'ascensore?\"\r\n \"Di che anno  la costruzione?\"\r\n \"Qual  l'altezza esatta dei soffitti?\"\r\n \"Come si arriva al cantiere?\"\r\n\r\n**Too Bureaucratic:**\r\n \"Compilare campo numero 7: metri quadri esatti\"\r\n \"Protocollo richiede [long list]\"\r\n \"Dato obbligatorio: [technical jargon]\"\r\n\r\n**Premature Budget Talk:**\r\n \"Qual  il tuo budget massimo?\"\r\n \"Quanto vuoi spendere?\"\r\n(Note: If user mentions budget, acknowledge and note it, but focus on scope)\r\n\r\n\r\nFLEXIBILITY & INTELLIGENCE\r\n\r\n\r\n**If User is Vague:**\r\nAsk clarifying open-ended questions to get richer details.\r\nExample: \"Interessante! Puoi darmi qualche dettaglio in pi su [aspect]?\"\r\n\r\n**If User is Very Detailed:**\r\nAcknowledge their thoroughness, fill any remaining gaps.\r\nExample: \"Ottimo, hai gi le idee chiare! Solo per completare...\"\r\n\r\n**If User Has Photo:**\r\nStart from visual analysis, then converge to project scope.\r\nExample: \"Vedo che hai [current state]. Intendi [demolish/preserve]?\"\r\n\r\n**If User Asks About Budget:**\r\nPolitely redirect to scope first.\r\nExample: \"Per darti una stima accurata, fammi capire meglio il progetto. \r\nPoi potremo discutere budget in base al lavoro.\"\r\n\r\n\r\nOUTPUT FORMATTING\r\n\r\n\r\nAfter gathering information, compile into projectDetails field as rich narrative:\r\n\r\nExample projectDetails:\r\n\"Ristrutturazione cucina 20mq, stile moderno. Demolizione parziale con \r\nmantenimento disposizione attuale. Top in quarzo, ante laccate bianche, \r\npavimento in gres effetto cemento. Elettrodomestici da includere: piano \r\ncottura induzione, forno, frigo, lavastoviglie. Impianto elettrico da \r\naggiornare, idraulico invariato. Illuminazione LED a soffitto + sottopensile.\"\r\n\r\nThen call submit_lead_data with all gathered fields.\r\n\r\nEnd Message Template:\r\n\"Riepilogo Tecnico salvato! \r\nTi ricontatteremo presto per un sopralluogo e la proposta economica. \r\nGrazie [Name]!\"\r\n\r\n[STATE MACHINE & TRANSITIONS - SYMMETRIC LOGIC]\r\nTrack conversation state based on tools used. Apply SYMMETRIC rules for both renders and quotes.\r\n\r\n\r\nSTATE 0: INITIAL (Nothing done yet)\r\n\r\n- Condition: Neither generate_render nor submit_lead_data called\r\n- Action: Determine user intent (MODE A for visualization, MODE B for quote)\r\n- Next: Transition to STATE 1A or STATE 1B based on user's first request\r\n\r\n\r\nSTATE 1A: RENDER_ONLY (Render done, Quote NOT done)\r\n\r\n- Condition: generate_render called successfully, submit_lead_data NOT called\r\n- NEXT ACTION REQUIRED (NON-NEGOTIABLE):\r\n  * IMMEDIATELY propose quote (complementary action)\r\n  * DO NOT propose another render (already have one)\r\n  \r\n- Prompt Template:\r\n  \" Ti piace questo rendering? \r\n  \r\n   **Vuoi realizzarlo davvero?** Posso prepararti un preventivo gratuito. \r\n  Mi servono solo 3-4 dettagli tecnici (piano, metratura, tipo di interventi). \r\n  \r\n  Procediamo con il preventivo?\"\r\n\r\n- Critical Rules:\r\n   Always propose quote after first render\r\n   Never propose second render (no changes yet)\r\n   Don't allow second render unless substantial modifications requested\r\n\r\n\r\nSTATE 1B: QUOTE_ONLY (Quote done, Render NOT done) \r\n\r\n- Condition: submit_lead_data called successfully, generate_render NOT called\r\n- NEXT ACTION REQUIRED (NON-NEGOTIABLE):\r\n  * IMMEDIATELY propose render (complementary action)\r\n  * DO NOT propose another quote (already have one)\r\n  \r\n- Prompt Template:\r\n  \" Dati salvati correttamente!\r\n  \r\n   **Vuoi vedere come verrebbe?** Posso generarti un rendering 3D fotorealistico \r\n  del progetto che hai in mente.\r\n  \r\n  Procediamo con la visualizzazione?\"\r\n\r\n- Critical Rules:\r\n   Always propose render after first quote\r\n   Never propose second quote (no changes yet)\r\n   Don't allow second quote unless substantial modifications requested\r\n\r\n\r\nSTATE 2: COMPLETE (Both Render AND Quote done)\r\n\r\n- Condition: Both generate_render AND submit_lead_data called successfully\r\n- NEXT ACTION: Listen for modification requests, distinguish substantial vs minor\r\n\r\n- Behavior Based on Change Type:\r\n  \r\n   SUBSTANTIAL CHANGES (New Project Scope):\r\n  - Examples: \r\n    * \"Invece voglio stile industriale, non moderno\"\r\n    * \"Cambiamo ambiente: bagno invece di cucina\"\r\n    * \"Progetto completamente diverso\"\r\n  - Action:\r\n     Generate new render if requested\r\n     CAN propose new quote (different scope)\r\n     Collect new quote data if needed\r\n     Treat as NEW iteration\r\n  \r\n   MINOR VARIATIONS (Same Project Scope):\r\n  - Examples:\r\n    * \"Fammi vedere con pavimento pi chiaro\"\r\n    * \"Cambia colore divano\"\r\n    * \"Mostrami variante con altra disposizione\"\r\n  - Action:\r\n     Generate new render if requested\r\n     DO NOT propose new quote (same project, data valid)\r\n     DO NOT propose new render (user already asked)\r\n     Just execute what user explicitly requests\r\n\r\n- Prompt Template (After Completion):\r\n  \"Perfetto! Abbiamo il progetto visivo e il preventivo.\r\n  \r\n  Se vuoi esplorare un'opzione completamente diversa o apportare modifiche, \r\n  sono qui per aiutarti!\"\r\n\r\n\r\nANTI-DUPLICATE RULES (Critical - Prevent Waste)\r\n\r\n1.  NEVER propose a tool that was JUST used\r\n   - After render  propose QUOTE, not another render\r\n   - After quote  propose RENDER, not another quote\r\n\r\n2.  NEVER propose same tool twice in same iteration\r\n   - One render proposal per iteration\r\n   - One quote proposal per iteration\r\n\r\n3.  NEVER allow second use without modifications\r\n   - \"Want another render?\"  NO (unless changes requested)\r\n   - \"Want another quote?\"  NO (unless project changed)\r\n\r\n4.  ONLY allow tool reuse on:\r\n   - User explicitly requests it with substantial changes\r\n   - New project scope identified\r\n\r\n\r\nSEQUENCE-AWARE RULES (Bidirectional & Symmetric)\r\n\r\n\r\nFOR QUOTES:\r\n1. Render FIRST  Quote NOT done:  Propose quote (STATE 1A)\r\n2. Quote FIRST  Render AFTER:  Never propose second quote (STATE 1B  2)\r\n3. Both COMPLETE  Substantial changes:  Can propose new quote\r\n4. Both COMPLETE  Minor variations:  Never propose quote\r\n\r\nFOR RENDERS (SYMMETRIC):\r\n1. Quote FIRST  Render NOT done:  Propose render (STATE 1B)\r\n2. Render FIRST  Quote AFTER:  Never propose second render (STATE 1A  2)\r\n3. Both COMPLETE  Substantial changes:  Can propose new render\r\n4. Both COMPLETE  Minor variations:  Never propose render\r\n\r\n\r\nQUOTA LIMITS (Enforced by System)\r\n\r\n- Maximum 2 renders per 24h per IP\r\n- Maximum 2 quotes per 24h per IP\r\n- If user hits limit: Relay error message politely, explain reset time\r\n- Don't encourage quota waste: Follow anti-duplicate rules strictly\r\n\r\n\r\nEXAMPLES - CORRECT FLOWS\r\n\r\n\r\nExample 1: Render-First (Standard)\r\n  User: \"Show me my kitchen\"  AI generates render  STATE 1A\r\n  AI: \"Ti piace? Vuoi un preventivo?\"  Propose quote \r\n  User: \"Yes\"  AI collects data  STATE 2 COMPLETE\r\n  AI: \"Perfetto! Hai tutto.\"  Don't propose render \r\n\r\nExample 2: Quote-First (Symmetric)\r\n  User: \"I want a quote for bathroom\"  AI collects data  STATE 1B\r\n  AI: \"Dati salvati! Vuoi vedere rendering?\"  Propose render \r\n  User: \"Yes\"  AI generates render  STATE 2 COMPLETE\r\n  AI: \"Ecco il rendering!\"  Don't propose quote \r\n\r\nExample 3: Substantial Modification\r\n  STATE 2 COMPLETE (modern kitchen render + quote)\r\n  User: \"Actually, industrial style instead\"\r\n  AI: Recognizes SUBSTANTIAL  generates new render\r\n  AI: \"Nuovo stile! Vuoi preventivo aggiornato?\"  Can propose \r\n\r\nExample 4: Minor Variation (Anti-Pattern)\r\n  STATE 2 COMPLETE\r\n  User: \"Show lighter floors\"\r\n  AI: Recognizes MINOR  generates new render\r\n  AI: \"Ecco la variante!\"  Don't propose anything \r\n`;\r\n\r\n\r\n\r\n\r\n/**\r\n * POST /api/chat - Main chat endpoint with AI streaming\r\n * Handles conversation with Gemini Pro and tool execution\r\n */\r\n\r\n\r\nexport async function POST(req: Request) {\r\n    console.log(\"---> API /api/chat HIT\");\r\n\r\n    //  Hybrid Rate Limiting (Firestore + In-Memory Cache)\r\n    const ip = (req.headers.get('x-forwarded-for') ?? '127.0.0.1').split(',')[0];\r\n\r\n    const { allowed, remaining, resetAt } = await checkRateLimit(ip);\r\n\r\n    if (!allowed) {\r\n        console.warn(`[RateLimit] IP ${ip} exceeded rate limit`);\r\n        return new Response('Too Many Requests - Please wait before trying again', {\r\n            status: 429,\r\n            headers: {\r\n                'Content-Type': 'text/plain',\r\n                'X-RateLimit-Limit': '20',\r\n                'X-RateLimit-Remaining': remaining.toString(),\r\n                'X-RateLimit-Reset': resetAt.toISOString(),\r\n                'Retry-After': Math.ceil((resetAt.getTime() - Date.now()) / 1000).toString(),\r\n            },\r\n        });\r\n    }\r\n\r\n    console.log(`[RateLimit] IP ${ip} allowed - ${remaining} requests remaining`);\r\n\r\n    try {\r\n        const body = await req.json();\r\n        const { messages, images, imageUrls, sessionId } = body; //  Extract imageUrls\r\n\r\n        //  BUG FIX #5: Strict sessionId validation (security)\r\n        if (!sessionId || typeof sessionId !== 'string' || sessionId.trim().length === 0) {\r\n            console.error('[API] Missing or invalid sessionId');\r\n            return new Response(JSON.stringify({\r\n                error: 'sessionId is required',\r\n                details: 'A valid session identifier must be provided'\r\n            }), {\r\n                status: 400,\r\n                headers: { 'Content-Type': 'application/json' }\r\n            });\r\n        }\r\n\r\n        console.log(\"API Request Debug:\", {\r\n            hasMessages: !!messages,\r\n            messagesLength: messages?.length,\r\n            hasImages: !!images,\r\n            hasImageUrls: !!imageUrls, //  Log imageUrls presence\r\n            imageUrlsCount: imageUrls?.length || 0,\r\n            sessionId\r\n        });\r\n\r\n        // Ensure session exists in Firestore\r\n        await ensureSession(sessionId);\r\n\r\n        // Load conversation history from Firestore\r\n        const conversationHistory = await getConversationContext(sessionId, 10);\r\n\r\n        // Get the latest user message from the request\r\n        const safeMessages = Array.isArray(messages) ? messages : [];\r\n        const latestUserMessage = safeMessages[safeMessages.length - 1];\r\n\r\n        //  DEBUG CRITICO: Stampa la struttura grezza per capire dove  il testo\r\n        console.log(' [DEBUG RAW MESSAGE]:', JSON.stringify(latestUserMessage, null, 2));\r\n\r\n        // Combine history + new message\r\n        let coreMessages = [\r\n            ...conversationHistory,\r\n            {\r\n                role: latestUserMessage?.role || 'user',\r\n                content: latestUserMessage?.content || ''\r\n            }\r\n        ];\r\n\r\n        // Inject images into the last user message if provided\r\n        if (images && Array.isArray(images) && images.length > 0) {\r\n            const lastMessage = coreMessages[coreMessages.length - 1];\r\n\r\n            if (lastMessage && lastMessage.role === 'user') {\r\n                const textContent = typeof lastMessage.content === 'string' ? lastMessage.content : '';\r\n\r\n                lastMessage.content = [\r\n                    { type: 'text', text: textContent },\r\n                    ...images.map((img: string) => ({ type: 'image', image: img }))\r\n                ] as any;\r\n            }\r\n        }\r\n\r\n        // Save user message to Firestore (async, don't await)\r\n        //  FIX: Use helper to correctly extract text from message.parts structure\r\n        let userTextContent = extractUserMessage(latestUserMessage);\r\n\r\n        //  HYBRID TOOL: Append marker with public URL if imageUrls available\r\n        if (images && Array.isArray(images) && images.length > 0) {\r\n            // If we have public URLs, include them in the marker for AI context\r\n            if (imageUrls && Array.isArray(imageUrls) && imageUrls.length > 0) {\r\n                // Save first URL (most recent image) in marker for modification mode\r\n                const firstImageUrl = imageUrls[0];\r\n                userTextContent += ` [Immagine allegata: ${firstImageUrl}]`;\r\n                console.log('[API]  Appended [Immagine allegata] marker with public URL:', firstImageUrl);\r\n            } else {\r\n                // Fallback: basic marker without URL\r\n                userTextContent += ' [Immagine allegata]';\r\n                console.log('[API] Appended [Immagine allegata] marker (no public URL available)');\r\n            }\r\n        }\r\n\r\n        console.log('[Firestore] Attempting to save user message...', { sessionId, content: userTextContent.substring(0, 50) });\r\n        console.log(`[API] Parsed User Message: \"${userTextContent}\"`);\r\n        saveMessage(sessionId, 'user', userTextContent)\r\n            .then(() => console.log('[Firestore]  User message saved successfully'))\r\n            .catch((error) => {\r\n                console.error('[Firestore]  ERROR saving user message:', error);\r\n                console.error('[Firestore] Error details:', {\r\n                    message: error.message,\r\n                    stack: error.stack,\r\n                    code: error.code\r\n                });\r\n            });\r\n\r\n        // Initialize Google Provider\r\n        const googleProvider = createGoogleGenerativeAI({\r\n            apiKey: process.env.GEMINI_API_KEY || '',\r\n        });\r\n\r\n        //  CRITICAL FIX: Conditional Tool Loading\r\n        // Only enable tools when user has explicitly requested them\r\n        // This prevents Gemini from calling generate_render on simple greetings\r\n\r\n        const conversationText = coreMessages.map((m: any) =>\r\n            typeof m.content === 'string' ? m.content.toLowerCase() : ''\r\n        ).join(' ');\r\n\r\n        //  ALWAYS enable tools - let the AI decide when to use them\r\n        // The system prompt already instructs the AI to only use tools after confirmation\r\n        const { createChatTools } = await import('@ai-core');\r\n        const tools = createChatTools(sessionId, ip);\r\n        console.log('[Tools]  Tools ENABLED (always available)');\r\n\r\n        //  MANUAL DATA STREAM IMPLEMENTATION\r\n        // Since createDataStream is missing in ai@6.0.5, we manually construct the stream\r\n        // strictly following Vercel's Data Stream Protocol (v1)\r\n\r\n        //  MANUAL DATA STREAM IMPLEMENTATION\r\n        // Since createDataStream is missing in certain versions, we manually construct the stream\r\n        // strictly following Vercel's Data Stream Protocol (v1)\r\n\r\n        const stream = new ReadableStream({\r\n            async start(controller) {\r\n                // Helper to write formatted data protocol chunks\r\n                const writeData = (key: string, value: any) => {\r\n                    const raw = JSON.stringify(value);\r\n                    controller.enqueue(new TextEncoder().encode(`${key}:${raw} \\n`));\r\n                };\r\n\r\n                //  ACCUMULATE STREAM: Track exactly what user sees for database persistence\r\n                let streamedContent = '';\r\n\r\n                try {\r\n                    // 1. Start the actual AI stream\r\n                    // Cast options to any to avoid strict type checks on experimental features\r\n                    const result = streamText({\r\n                        model: googleProvider(process.env.CHAT_MODEL_VERSION || 'gemini-2.5-flash'),\r\n                        system: SYSTEM_INSTRUCTION,\r\n                        messages: coreMessages as any,\r\n                        tools: tools as any,\r\n                        maxSteps: 5,\r\n                        maxToolRoundtrips: 2, // Allow Gemini to use tools AND generate final response\r\n                        experimental_providerMetadata: { sessionId },\r\n\r\n                        //  DIRECT TOOL RESULT STREAMING\r\n                        // Write tool results directly to the stream instead of waiting for Gemini\r\n                        async onToolCall({ toolCall, toolResult }: { toolCall: any; toolResult: any }) {\r\n                            console.log(' [Tool Call]', toolCall.toolName);\r\n\r\n                            // For market prices, write result directly to stream\r\n                            if (toolCall.toolName === 'get_market_prices' && toolResult) {\r\n                                const resultText = typeof toolResult === 'string' ? toolResult : JSON.stringify(toolResult);\r\n                                console.log(' [Direct Stream] Writing market prices directly to chat');\r\n\r\n                                // Write as text delta to appear in chat\r\n                                writeData('0', resultText);\r\n                                streamedContent += resultText;\r\n                            }\r\n                        },\r\n\r\n                        // Keep onFinish logic\r\n                        onFinish: async ({ text, toolResults }: { text: string; toolResults: any[] }) => {\r\n                            console.log('[onFinish]  Streamed Content Length:', streamedContent.length);\r\n                            console.log('[onFinish] Saving assistant message');\r\n\r\n                            try {\r\n                                //  SINGLE SOURCE OF TRUTH: Save exactly what was streamed to user\r\n                                await saveMessage(sessionId, 'assistant', streamedContent, {\r\n                                    toolCalls: toolResults?.map((tr: any) => ({\r\n                                        name: tr.toolName || 'unknown',\r\n                                        args: tr.args || {},\r\n                                        result: tr.result || {}\r\n                                    }))\r\n                                });\r\n                                console.log('[onFinish]  Message saved successfully');\r\n                            } catch (error) {\r\n                                console.error('[onFinish]  CRITICAL: Failed to save message', error);\r\n                            }\r\n                        },\r\n                    } as any);\r\n\r\n                    // 2. Consume the FULL stream to capture tools and text\r\n                    // We iterate over the full event stream to manually inject tool outputs (images) as text\r\n                    for await (const part of result.fullStream) {\r\n                        if (part.type === 'text-delta') {\r\n                            streamedContent += part.text;\r\n                            writeData('0', part.text);\r\n                        }\r\n\r\n                        // Check for tool results (specifically our generation tool)\r\n                        //  SECURITY FIX: Robust error handling for tool failures\r\n\r\n                        //  MARKET PRICES: Write directly to stream\r\n                        if (part.type === 'tool-result' && part.toolName === 'get_market_prices') {\r\n                            try {\r\n                                const result = (part as any).result || (part as any).output;\r\n                                const resultText = typeof result === 'string' ? result : JSON.stringify(result);\r\n\r\n                                console.log(' [Market Prices] Writing directly to stream');\r\n                                console.log(' [Market Prices] Content length:', resultText.length);\r\n\r\n                                // Write to chat\r\n                                writeData('0', resultText);\r\n                                streamedContent += resultText;\r\n                            } catch (error) {\r\n                                console.error(' [Market Prices] Failed to write to stream:', error);\r\n                            }\r\n                        }\r\n\r\n                        if (part.type === 'tool-result' && part.toolName === 'generate_render') {\r\n                            try {\r\n                                const result = (part as any).result || (part as any).output;\r\n\r\n                                // Check for error status first (tool-level failure)\r\n                                if (result?.status === 'error') {\r\n                                    const errorMessage = '\\n\\n Mi dispiace, il servizio di rendering  temporaneamente non disponibile. Riprova tra qualche minuto.\\n\\n';\r\n                                    console.error('[Stream] Tool returned error:', result.error);\r\n                                    streamedContent += errorMessage;\r\n                                    writeData('0', errorMessage);\r\n                                } else if (result?.status === 'success' && result?.imageUrl) {\r\n                                    // Inject the image as a markdown text chunk\r\n                                    const imageMarkdown = `\\n\\n![](${result.imageUrl}) \\n\\n`;\r\n                                    console.log('[Stream] Injecting image to stream:', result.imageUrl);\r\n                                    streamedContent += imageMarkdown;\r\n                                    writeData('0', imageMarkdown);\r\n                                } else {\r\n                                    // Unexpected result format\r\n                                    const unexpectedError = '\\n\\n Si  verificato un errore imprevisto. Riprova.\\n\\n';\r\n                                    console.warn('[Stream] Unexpected tool result format:', result);\r\n                                    streamedContent += unexpectedError;\r\n                                    writeData('0', unexpectedError);\r\n                                }\r\n                            } catch (toolError) {\r\n                                // Catch any unexpected errors during tool result processing\r\n                                const processingError = '\\n\\n Si  verificato un errore durante la generazione. Riprova.\\n\\n';\r\n                                console.error('[Stream] Error processing tool result:', toolError);\r\n                                streamedContent += processingError;\r\n                                writeData('0', processingError);\r\n                            }\r\n                        }\r\n\r\n                        // We also likely need to send tool call info if we want to be \"correct\", \r\n                        // but for this specific \"Text + Image\" requirement, injecting text is safer.\r\n\r\n                        //  FIX: Forward tool calls to client (Protocol '9')\r\n                        if (part.type === 'tool-call') {\r\n                            const p = part as any;\r\n                            const toolCall = {\r\n                                toolCallId: p.toolCallId,\r\n                                toolName: p.toolName,\r\n                                args: p.args || p.input || {}\r\n                            };\r\n                            writeData('9', toolCall);\r\n                        }\r\n\r\n                        //  Forward ALL tool results (Protocol 'a') for frontend metadata access\r\n                        // User-facing content sent via Protocol '0', metadata via Protocol 'a'\r\n                        if (part.type === 'tool-result') {\r\n                            const p = part as any;\r\n                            const toolResult = {\r\n                                toolCallId: p.toolCallId,\r\n                                result: p.result\r\n                            };\r\n                            writeData('a', toolResult);\r\n                        }\r\n                    }\r\n\r\n                    // 3. Close the stream cleanly\r\n                    controller.close();\r\n\r\n                } catch (error: any) {\r\n                    // Protocol: '3' key for error messages\r\n                    writeData('3', { error: error.message });\r\n                    console.error(\"Stream Error:\", error);\r\n                    controller.close();\r\n                }\r\n            }\r\n        });\r\n\r\n        // Return the standard response with correct headers\r\n        return new Response(stream, {\r\n            status: 200,\r\n            headers: {\r\n                'Content-Type': 'text/plain; charset=utf-8',\r\n                'X-Vercel-AI-Data-Stream': 'v1', // Activates frontend tool/image mode\r\n                'X-RateLimit-Limit': '20',\r\n                'X-RateLimit-Remaining': remaining.toString(),\r\n                'X-RateLimit-Reset': resetAt.toISOString(),\r\n            },\r\n        });\r\n\r\n    } catch (error: any) {\r\n        console.error(\"Chat API Error Details:\", error);\r\n        return new Response(JSON.stringify({\r\n            error: 'Internal Server Error',\r\n            details: error.message,\r\n            stack: error.stack\r\n        }), {\r\n            status: 500,\r\n            headers: { 'Content-Type': 'application/json' }\r\n        });\r\n    }\r\n}\r\n","import {\n  AppRouteRouteModule,\n  type AppRouteRouteHandlerContext,\n  type AppRouteRouteModuleOptions,\n} from '../../server/route-modules/app-route/module.compiled'\nimport { RouteKind } from '../../server/route-kind'\nimport { patchFetch as _patchFetch } from '../../server/lib/patch-fetch'\nimport type { IncomingMessage, ServerResponse } from 'node:http'\nimport { addRequestMeta, getRequestMeta } from '../../server/request-meta'\nimport { getTracer, type Span, SpanKind } from '../../server/lib/trace/tracer'\nimport { setReferenceManifestsSingleton } from '../../server/app-render/encryption-utils'\nimport { createServerModuleMap } from '../../server/app-render/action-utils'\nimport { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\nimport { NodeNextRequest, NodeNextResponse } from '../../server/base-http/node'\nimport {\n  NextRequestAdapter,\n  signalFromNodeResponse,\n} from '../../server/web/spec-extension/adapters/next-request'\nimport { BaseServerSpan } from '../../server/lib/trace/constants'\nimport { getRevalidateReason } from '../../server/instrumentation/utils'\nimport { sendResponse } from '../../server/send-response'\nimport {\n  fromNodeOutgoingHttpHeaders,\n  toNodeOutgoingHttpHeaders,\n} from '../../server/web/utils'\nimport { getCacheControlHeader } from '../../server/lib/cache-control'\nimport { INFINITE_CACHE, NEXT_CACHE_TAGS_HEADER } from '../../lib/constants'\nimport { NoFallbackError } from '../../shared/lib/no-fallback-error.external'\nimport {\n  CachedRouteKind,\n  type ResponseCacheEntry,\n  type ResponseGenerator,\n} from '../../server/response-cache'\n\nimport * as userland from 'VAR_USERLAND'\n\n// These are injected by the loader afterwards. This is injected as a variable\n// instead of a replacement because this could also be `undefined` instead of\n// an empty string.\ndeclare const nextConfigOutput: AppRouteRouteModuleOptions['nextConfigOutput']\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\n// INJECT:nextConfigOutput\n\nconst routeModule = new AppRouteRouteModule({\n  definition: {\n    kind: RouteKind.APP_ROUTE,\n    page: 'VAR_DEFINITION_PAGE',\n    pathname: 'VAR_DEFINITION_PATHNAME',\n    filename: 'VAR_DEFINITION_FILENAME',\n    bundlePath: 'VAR_DEFINITION_BUNDLE_PATH',\n  },\n  distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n  relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n  resolvedPagePath: 'VAR_RESOLVED_PAGE_PATH',\n  nextConfigOutput,\n  userland,\n})\n\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule\n\nfunction patchFetch() {\n  return _patchFetch({\n    workAsyncStorage,\n    workUnitAsyncStorage,\n  })\n}\n\nexport {\n  routeModule,\n  workAsyncStorage,\n  workUnitAsyncStorage,\n  serverHooks,\n  patchFetch,\n}\n\nexport async function handler(\n  req: IncomingMessage,\n  res: ServerResponse,\n  ctx: {\n    waitUntil: (prom: Promise<void>) => void\n  }\n) {\n  if (routeModule.isDev) {\n    addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint())\n  }\n  let srcPage = 'VAR_DEFINITION_PAGE'\n\n  // turbopack doesn't normalize `/index` in the page name\n  // so we need to to process dynamic routes properly\n  // TODO: fix turbopack providing differing value from webpack\n  if (process.env.TURBOPACK) {\n    srcPage = srcPage.replace(/\\/index$/, '') || '/'\n  } else if (srcPage === '/index') {\n    // we always normalize /index specifically\n    srcPage = '/'\n  }\n  const multiZoneDraftMode = process.env\n    .__NEXT_MULTI_ZONE_DRAFT_MODE as any as boolean\n\n  const prepareResult = await routeModule.prepare(req, res, {\n    srcPage,\n    multiZoneDraftMode,\n  })\n\n  if (!prepareResult) {\n    res.statusCode = 400\n    res.end('Bad Request')\n    ctx.waitUntil?.(Promise.resolve())\n    return null\n  }\n\n  const {\n    buildId,\n    params,\n    nextConfig,\n    parsedUrl,\n    isDraftMode,\n    prerenderManifest,\n    routerServerContext,\n    isOnDemandRevalidate,\n    revalidateOnlyGenerated,\n    resolvedPathname,\n    clientReferenceManifest,\n    serverActionsManifest,\n  } = prepareResult\n\n  const normalizedSrcPage = normalizeAppPath(srcPage)\n\n  let isIsr = Boolean(\n    prerenderManifest.dynamicRoutes[normalizedSrcPage] ||\n      prerenderManifest.routes[resolvedPathname]\n  )\n\n  const render404 = async () => {\n    // TODO: should route-module itself handle rendering the 404\n    if (routerServerContext?.render404) {\n      await routerServerContext.render404(req, res, parsedUrl, false)\n    } else {\n      res.end('This page could not be found')\n    }\n    return null\n  }\n\n  if (isIsr && !isDraftMode) {\n    const isPrerendered = Boolean(prerenderManifest.routes[resolvedPathname])\n    const prerenderInfo = prerenderManifest.dynamicRoutes[normalizedSrcPage]\n\n    if (prerenderInfo) {\n      if (prerenderInfo.fallback === false && !isPrerendered) {\n        if (nextConfig.experimental.adapterPath) {\n          return await render404()\n        }\n        throw new NoFallbackError()\n      }\n    }\n  }\n\n  let cacheKey: string | null = null\n\n  if (isIsr && !routeModule.isDev && !isDraftMode) {\n    cacheKey = resolvedPathname\n    // ensure /index and / is normalized to one key\n    cacheKey = cacheKey === '/index' ? '/' : cacheKey\n  }\n\n  const supportsDynamicResponse: boolean =\n    // If we're in development, we always support dynamic HTML\n    routeModule.isDev === true ||\n    // If this is not SSG or does not have static paths, then it supports\n    // dynamic HTML.\n    !isIsr\n\n  // This is a revalidation request if the request is for a static\n  // page and it is not being resumed from a postponed render and\n  // it is not a dynamic RSC request then it is a revalidation\n  // request.\n  const isStaticGeneration = isIsr && !supportsDynamicResponse\n\n  // Before rendering (which initializes component tree modules), we have to\n  // set the reference manifests to our global store so Server Action's\n  // encryption util can access to them at the top level of the page module.\n  if (serverActionsManifest && clientReferenceManifest) {\n    setReferenceManifestsSingleton({\n      page: srcPage,\n      clientReferenceManifest,\n      serverActionsManifest,\n      serverModuleMap: createServerModuleMap({\n        serverActionsManifest,\n      }),\n    })\n  }\n\n  const method = req.method || 'GET'\n  const tracer = getTracer()\n  const activeSpan = tracer.getActiveScopeSpan()\n\n  const context: AppRouteRouteHandlerContext = {\n    params,\n    prerenderManifest,\n    renderOpts: {\n      experimental: {\n        authInterrupts: Boolean(nextConfig.experimental.authInterrupts),\n      },\n      cacheComponents: Boolean(nextConfig.cacheComponents),\n      supportsDynamicResponse,\n      incrementalCache: getRequestMeta(req, 'incrementalCache'),\n      cacheLifeProfiles: nextConfig.cacheLife,\n      waitUntil: ctx.waitUntil,\n      onClose: (cb) => {\n        res.on('close', cb)\n      },\n      onAfterTaskError: undefined,\n      onInstrumentationRequestError: (error, _request, errorContext) =>\n        routeModule.onRequestError(\n          req,\n          error,\n          errorContext,\n          routerServerContext\n        ),\n    },\n    sharedContext: {\n      buildId,\n    },\n  }\n  const nodeNextReq = new NodeNextRequest(req)\n  const nodeNextRes = new NodeNextResponse(res)\n\n  const nextReq = NextRequestAdapter.fromNodeNextRequest(\n    nodeNextReq,\n    signalFromNodeResponse(res)\n  )\n\n  try {\n    const invokeRouteModule = async (span?: Span) => {\n      return routeModule.handle(nextReq, context).finally(() => {\n        if (!span) return\n\n        span.setAttributes({\n          'http.status_code': res.statusCode,\n          'next.rsc': false,\n        })\n\n        const rootSpanAttributes = tracer.getRootSpanAttributes()\n        // We were unable to get attributes, probably OTEL is not enabled\n        if (!rootSpanAttributes) {\n          return\n        }\n\n        if (\n          rootSpanAttributes.get('next.span_type') !==\n          BaseServerSpan.handleRequest\n        ) {\n          console.warn(\n            `Unexpected root span type '${rootSpanAttributes.get(\n              'next.span_type'\n            )}'. Please report this Next.js issue https://github.com/vercel/next.js`\n          )\n          return\n        }\n\n        const route = rootSpanAttributes.get('next.route')\n        if (route) {\n          const name = `${method} ${route}`\n\n          span.setAttributes({\n            'next.route': route,\n            'http.route': route,\n            'next.span_name': name,\n          })\n          span.updateName(name)\n        } else {\n          span.updateName(`${method} ${srcPage}`)\n        }\n      })\n    }\n    const isMinimalMode = Boolean(\n      process.env.MINIMAL_MODE || getRequestMeta(req, 'minimalMode')\n    )\n\n    const handleResponse = async (currentSpan?: Span) => {\n      const responseGenerator: ResponseGenerator = async ({\n        previousCacheEntry,\n      }) => {\n        try {\n          if (\n            !isMinimalMode &&\n            isOnDemandRevalidate &&\n            revalidateOnlyGenerated &&\n            !previousCacheEntry\n          ) {\n            res.statusCode = 404\n            // on-demand revalidate always sets this header\n            res.setHeader('x-nextjs-cache', 'REVALIDATED')\n            res.end('This page could not be found')\n            return null\n          }\n\n          const response = await invokeRouteModule(currentSpan)\n\n          ;(req as any).fetchMetrics = (context.renderOpts as any).fetchMetrics\n          let pendingWaitUntil = context.renderOpts.pendingWaitUntil\n\n          // Attempt using provided waitUntil if available\n          // if it's not we fallback to sendResponse's handling\n          if (pendingWaitUntil) {\n            if (ctx.waitUntil) {\n              ctx.waitUntil(pendingWaitUntil)\n              pendingWaitUntil = undefined\n            }\n          }\n          const cacheTags = context.renderOpts.collectedTags\n\n          // If the request is for a static response, we can cache it so long\n          // as it's not edge.\n          if (isIsr) {\n            const blob = await response.blob()\n\n            // Copy the headers from the response.\n            const headers = toNodeOutgoingHttpHeaders(response.headers)\n\n            if (cacheTags) {\n              headers[NEXT_CACHE_TAGS_HEADER] = cacheTags\n            }\n\n            if (!headers['content-type'] && blob.type) {\n              headers['content-type'] = blob.type\n            }\n\n            const revalidate =\n              typeof context.renderOpts.collectedRevalidate === 'undefined' ||\n              context.renderOpts.collectedRevalidate >= INFINITE_CACHE\n                ? false\n                : context.renderOpts.collectedRevalidate\n\n            const expire =\n              typeof context.renderOpts.collectedExpire === 'undefined' ||\n              context.renderOpts.collectedExpire >= INFINITE_CACHE\n                ? undefined\n                : context.renderOpts.collectedExpire\n\n            // Create the cache entry for the response.\n            const cacheEntry: ResponseCacheEntry = {\n              value: {\n                kind: CachedRouteKind.APP_ROUTE,\n                status: response.status,\n                body: Buffer.from(await blob.arrayBuffer()),\n                headers,\n              },\n              cacheControl: { revalidate, expire },\n            }\n\n            return cacheEntry\n          } else {\n            // send response without caching if not ISR\n            await sendResponse(\n              nodeNextReq,\n              nodeNextRes,\n              response,\n              context.renderOpts.pendingWaitUntil\n            )\n            return null\n          }\n        } catch (err) {\n          // if this is a background revalidate we need to report\n          // the request error here as it won't be bubbled\n          if (previousCacheEntry?.isStale) {\n            await routeModule.onRequestError(\n              req,\n              err,\n              {\n                routerKind: 'App Router',\n                routePath: srcPage,\n                routeType: 'route',\n                revalidateReason: getRevalidateReason({\n                  isStaticGeneration,\n                  isOnDemandRevalidate,\n                }),\n              },\n              routerServerContext\n            )\n          }\n          throw err\n        }\n      }\n\n      const cacheEntry = await routeModule.handleResponse({\n        req,\n        nextConfig,\n        cacheKey,\n        routeKind: RouteKind.APP_ROUTE,\n        isFallback: false,\n        prerenderManifest,\n        isRoutePPREnabled: false,\n        isOnDemandRevalidate,\n        revalidateOnlyGenerated,\n        responseGenerator,\n        waitUntil: ctx.waitUntil,\n        isMinimalMode,\n      })\n\n      // we don't create a cacheEntry for ISR\n      if (!isIsr) {\n        return null\n      }\n\n      if (cacheEntry?.value?.kind !== CachedRouteKind.APP_ROUTE) {\n        throw new Error(\n          `Invariant: app-route received invalid cache entry ${cacheEntry?.value?.kind}`\n        )\n      }\n\n      if (!isMinimalMode) {\n        res.setHeader(\n          'x-nextjs-cache',\n          isOnDemandRevalidate\n            ? 'REVALIDATED'\n            : cacheEntry.isMiss\n              ? 'MISS'\n              : cacheEntry.isStale\n                ? 'STALE'\n                : 'HIT'\n        )\n      }\n\n      // Draft mode should never be cached\n      if (isDraftMode) {\n        res.setHeader(\n          'Cache-Control',\n          'private, no-cache, no-store, max-age=0, must-revalidate'\n        )\n      }\n\n      const headers = fromNodeOutgoingHttpHeaders(cacheEntry.value.headers)\n\n      if (!(isMinimalMode && isIsr)) {\n        headers.delete(NEXT_CACHE_TAGS_HEADER)\n      }\n\n      // If cache control is already set on the response we don't\n      // override it to allow users to customize it via next.config\n      if (\n        cacheEntry.cacheControl &&\n        !res.getHeader('Cache-Control') &&\n        !headers.get('Cache-Control')\n      ) {\n        headers.set(\n          'Cache-Control',\n          getCacheControlHeader(cacheEntry.cacheControl)\n        )\n      }\n\n      await sendResponse(\n        nodeNextReq,\n        nodeNextRes,\n        // @ts-expect-error - Argument of type 'Buffer<ArrayBufferLike>' is not assignable to parameter of type 'BodyInit | null | undefined'.\n        new Response(cacheEntry.value.body, {\n          headers,\n          status: cacheEntry.value.status || 200,\n        })\n      )\n      return null\n    }\n\n    // TODO: activeSpan code path is for when wrapped by\n    // next-server can be removed when this is no longer used\n    if (activeSpan) {\n      await handleResponse(activeSpan)\n    } else {\n      await tracer.withPropagatedContext(req.headers, () =>\n        tracer.trace(\n          BaseServerSpan.handleRequest,\n          {\n            spanName: `${method} ${srcPage}`,\n            kind: SpanKind.SERVER,\n            attributes: {\n              'http.method': method,\n              'http.target': req.url,\n            },\n          },\n          handleResponse\n        )\n      )\n    }\n  } catch (err) {\n    if (!(err instanceof NoFallbackError)) {\n      await routeModule.onRequestError(req, err, {\n        routerKind: 'App Router',\n        routePath: normalizedSrcPage,\n        routeType: 'route',\n        revalidateReason: getRevalidateReason({\n          isStaticGeneration,\n          isOnDemandRevalidate,\n        }),\n      })\n    }\n\n    // rethrow so that we can handle serving error page\n\n    // If this is during static generation, throw the error again.\n    if (isIsr) throw err\n\n    // Otherwise, send a 500 response.\n    await sendResponse(\n      nodeNextReq,\n      nodeNextRes,\n      new Response(null, { status: 500 })\n    )\n    return null\n  }\n}\n"],"names":["generateId","lazySchema","zodSchema","z","responseHeaders","response","rawValue","combineHeaders","createJsonResponseHandler","parseProviderOptions","postJsonToApi","resolve","_a","UnsupportedFunctionalityError","googleTools","createProviderToolFactory","AppRouteRouteModule","RouteKind","patchFetch","_patchFetch","addRequestMeta","getRequestMeta","getTracer","SpanKind","setReferenceManifestsSingleton","createServerModuleMap","normalizeAppPath","NodeNextRequest","NodeNextResponse","NextRequestAdapter","signalFromNodeResponse","BaseServerSpan","getRevalidateReason","sendResponse","fromNodeOutgoingHttpHeaders","toNodeOutgoingHttpHeaders","getCacheControlHeader","INFINITE_CACHE","NEXT_CACHE_TAGS_HEADER","NoFallbackError","CachedRouteKind","userland","routeModule","definition","kind","APP_ROUTE","page","pathname","filename","bundlePath","distDir","process","env","__NEXT_RELATIVE_DIST_DIR","relativeProjectDir","__NEXT_RELATIVE_PROJECT_DIR","resolvedPagePath","nextConfigOutput","workAsyncStorage","workUnitAsyncStorage","serverHooks","handler","req","res","ctx","isDev","hrtime","bigint","srcPage","TURBOPACK","replace","multiZoneDraftMode","__NEXT_MULTI_ZONE_DRAFT_MODE","prepareResult","prepare","statusCode","end","waitUntil","Promise","buildId","params","nextConfig","parsedUrl","isDraftMode","prerenderManifest","routerServerContext","isOnDemandRevalidate","revalidateOnlyGenerated","resolvedPathname","clientReferenceManifest","serverActionsManifest","normalizedSrcPage","isIsr","Boolean","dynamicRoutes","routes","render404","isPrerendered","prerenderInfo","fallback","experimental","adapterPath","cacheKey","supportsDynamicResponse","isStaticGeneration","serverModuleMap","method","tracer","activeSpan","getActiveScopeSpan","context","renderOpts","authInterrupts","cacheComponents","incrementalCache","cacheLifeProfiles","cacheLife","onClose","cb","on","onAfterTaskError","undefined","onInstrumentationRequestError","error","_request","errorContext","onRequestError","sharedContext","nodeNextReq","nodeNextRes","nextReq","fromNodeNextRequest","invokeRouteModule","span","handle","finally","setAttributes","rootSpanAttributes","getRootSpanAttributes","get","handleRequest","console","warn","route","name","updateName","isMinimalMode","MINIMAL_MODE","handleResponse","currentSpan","cacheEntry","responseGenerator","previousCacheEntry","setHeader","fetchMetrics","pendingWaitUntil","cacheTags","collectedTags","blob","headers","type","revalidate","collectedRevalidate","expire","collectedExpire","value","status","body","Buffer","from","arrayBuffer","cacheControl","err","isStale","routerKind","routePath","routeType","revalidateReason","routeKind","isFallback","isRoutePPREnabled","Error","isMiss","delete","getHeader","set","Response","withPropagatedContext","trace","spanName","SERVER","attributes","url"],"mappings":"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","ignoreList":[23]}